<html layout:decorate="~{layout_page}">
<th:block layout:fragment="content">
    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>ì¶œê³  ì§€ì‹œ ë“±ë¡(LOT)</h2>
                <a title="ë¶ë§ˆí¬" class="bookmark toggle">
                    ë‚´ ë©”ë‰´
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
                <li>ì˜ì—… ê´€ë¦¬</li>
                <li>ì¶œê³  ì§€ì‹œ ë“±ë¡(LOT)</li>
            </ul>
        </div>
        <div style="display: flex; gap: 5px;">
            <section class="section" style="flex: 1;">
                <form id="searchForm" autocomplete="off">
                    <div class="section-top">
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    <label>
                                        ì¶œê³ ì¼<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="date" id="srchStartDt" name="srchStartDt"/>
                                        <span class="slow_sign">~</span>
                                        <input type="date" id="srchEndDt" name="srchEndDt"/>
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        ì—…ì²´
                                    </label>
                                </dt>
                                <dd>
                                    <select class="form-control2" id="cboCompany" name="cboCompany">
                                    </select>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        í’ˆëª©ê·¸ë£¹
                                    </label>
                                </dt>
                                <dd>
                                    <select class="" id="cboMatGroup" name="cboMatGroup">
                                    </select>
                                </dd>
                            </dl>
                        </div>
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    <label>
                                        í’ˆëª©<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <select class="" id="cboMaterial" name="cboMaterial">
                                    </select>
                                </dd>
                            </dl>

                            <dl>
                                <dt>
                                    <label>
                                        í’ˆëª©ëª…<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <input type="text" class="" id="keyword" name="keyword"/>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                        ì¶œê³ ëŒ€ê¸°<span class="eq"></span>
                                    </label>
                                </dt>
                                <dd>
                                    <input type="checkbox" id="chkNotShipped" name="chkNotShipped" value="Y" checked/>
                                </dd>
                            </dl>
                            <dl>
                                <dt>&nbsp;</dt>
                                <dd>
                                    <li>
                                        <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                                            <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                            <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                            ê²€ìƒ‰
                                        </a>
                                    </li>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </form>
                <!--            <div class="title_box">-->
                <!--                <div class="left_align">-->
                <!--                    <label class="switch">-->
                <!--                        <input type="checkbox" checked id="btnListCollapse"><span class="slider round"></span>-->
                <!--                    </label>-->
                <!--                    ì¶œê³  ì§€ì‹œ ë³´ê¸°/ê°ì¶”ê¸°-->
                <!--                </div>-->
                <!--            </div>-->
                <div class="grid_box" id="divList">
                    <div class="title_box">
                        <span class="right_align rpt" data-labelCd="ì¶œê³  ì§€ì‹œ ëª©ë¡">ì¶œê³  ì§€ì‹œ ëª©ë¡</span>
                        <button class="btn-default y_write_auth" id="btnShipmentComplete" title="ì¶œê³ ì²˜ë¦¬" disabled>ì¶œê³ ì²˜ë¦¬
                        </button>
                    </div>
                    <div class="container-fluid">
                        <div id="theGrid"></div>
                    </div>
                </div>
            </section>

            <section class="section" style="flex: 1; min-width: 0;">
                <div class="section-top">
                    <div class="container-fluid">
                        <div class="title_box buttons">
                            <span class="right_align rpt" data-labelCd="ì¶œê³ ">ì¶œê³ </span>
                            <button style="visibility: hidden;" class="btn-default y_write_auth" id="btnSaveShip"
                                    data-labelCd="ì¶œê³  ì²˜ë¦¬">ì¶œê³  ì²˜ë¦¬
                            </button>
                        </div>
                        <div id="theGrid2" style="height: 32vh;"></div>
                    </div>

                    <div class="container-fluid" style="margin-top: 15px;">
                        <div class="title_box buttons">
                            <span class="right_align rpt" data-labelCd="ì¶œê³  ì²˜ë¦¬ LOTìƒì„¸">ì¶œê³  ì²˜ë¦¬ LOTìƒì„¸</span>
                            <input style="width: 170px; height: 32px" class="w-140 tac y_write_auth" type="text"
                                   id="LotNumber" placeholder="LOTë²ˆí˜¸ ìŠ¤ìº” or ì…ë ¥" disabled/>
                            <button type="button" class="btn-default" id="btnLOTSelect" title="LOTì¶”ê°€" disabled><i
                                    class="fas fa-plus"></i></button>
                            <button style="" type="button" class="btn-danger y_write_auth" id="btnLOTSelectCancel"
                                    title="LOTì‚­ì œ" disabled><i class="fas fa-trash"></i></button>
                        </div>
                        <div id="theGrid3" style="height: 32vh;"></div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script type="text/x-tmpl" id="lotSelectTemplate">
        <div class="content_wrap popup">
        <section class="pt-2">
                <div class="table_box p-1">
                    <div class="grid_box" >
                        <div class="h-300" id="theGrid4"></div>
                    </div>
                </div>
        </section>
        <form id="lotForm">
            <div class="table-wrap">
                <table class="write-table">
                    <caption>ì£¼ë¬¸ë“±ë¡ í…Œì´ë¸”</caption>
                    <tbody>
                        <tr>
                            <th style="text-align: center">
                                <label>Lot No.</label>
                            </th>
                            <td>
                                <input class="" style="width: 200px" type="text" id="popLotNumber" name="LotNumber" readonly />
                            </td>
                            <th style="text-align: center">
                                <label>í’ˆëª©ëª…</label>
                            </th>
                            <td>
                                 <input class="" style="width: 200px" type="text" id="popMaterial" name="mat_name" readonly />
                            </td>
                        </tr>

                        <tr>
                            <th style="text-align: center">
                                <label for="end_date">í˜„ì¬ê³ </label>
                            </th>
                            <td>
                                <input class="" type="number" style="width: 200px" id="popCurrentStock" name="CurrentStock" readonly />
                            </td>
                            <th style="text-align: center">
                                <label for="EndTime">LOT ìƒì„±ì¼</label>
                            </th>
                            <td>
                                 <input class="" type="text" style="width: 200px" id="popInputDateTime" name="InputDateTime" readonly />
                            </td>
                        </tr>

                        <tr>
                            <th style="text-align: center">
                                <label for="end_date">ìœ íš¨ê¸°ê°„</label>
                            </th>
                            <td>
                                <input class="" type="number" style="width: 200px" id="popEffectiveDate" name="EffectiveDate" readonly />
                            </td>
                            <th style="text-align: center">
                                <label for="RunState">ì¶œê³ ëŸ‰</label>
                            </th>
                            <td>
                                <input type="number" style="width: 200px" id="popLotUseQuantity" name="lot_use_quantity" />
                            </td>
                        </tr>

                    </tbody>
                </table>
            </div>

            <div class="popup-button">

                    <button type="button" class="btn-popup y_write_auth" id="btnLotSave">ì¶”ê°€</button>
                    <button type="button" class="btn-popup" id="modal-close-button">ë‹«ê¸°</button>
                    <button type="button" class="btn-popup" id="btnLotRefresh"><span data-commonCd="ìƒˆë¡œê³ ì¹¨">ìƒˆë¡œê³ ì¹¨</span></button>
            </div>
            </form>
        </div>
    </script>

</th:block>

<th:block layout:fragment="scripts">
    <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
    <script type="text/javascript">

        let gUrl = '/api/shipment/shipment_do_a';
        let $content;
        let modalContainer;
        let SelectItem = [];
        let enterFlag = false;


        class ShipmentProcessPage {
            constructor() {
                this.url = '/api/shipment/shipment_do_b';
                this.shipmentHeaderGrid = null;
                this.shipmentListGrid = null;
                this.lotListGrid = null;
                this.viewData = new wijmo.collections.CollectionView();
                this.viewData2 = new wijmo.collections.CollectionView();
                this.viewData3 = new wijmo.collections.CollectionView();
                this.viewData4 = new wijmo.collections.CollectionView();
                this.lastSelectedShipmentId = null;


                this.init();
            }

            init() {

                this.$LotNumber = $('#LotNumber');
                this.$btnLOTSelect = $('#btnLOTSelect');
                this.$btnLOTSelectCancel = $('#btnLOTSelectCancel');
                let $cboCompany = $('#cboCompany');

                AjaxUtil.fillSelectOptions($cboCompany, 'company', 'choose', '', 'sale');
                AjaxUtil.fillSelectOptions($('#cboMatGroup'), 'material_group', 'all', '', 'product,semi,sangpum');
                $('#cboMatGroup').change(function (e) {
                    let mat_grp_pk = $('#cboMatGroup').val();
                    AjaxUtil.fillSelectOptions($('#cboMaterial'), 'material', 'all', '', mat_grp_pk);
                });

                $cboCompany.change(function () {
                    // íŒë§¤ì²˜ íƒ€ì´í‹€
                    $cboCompany.attr('title', $('#cboCompany option:checked').text());
                });

                this.initShipmentHeader();
                this.initShipmentList();
                this.initLotList();

            }

            initShipmentHeader() {
                let _this = this;

                this.shipmentHeaderGrid = new wijmo.grid.FlexGrid('#theGrid', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    allowSorting: 'MultiColumn',
                    selectionMode: wijmo.grid.SelectionMode.Row, // í–‰ ë‹¨ìœ„ ì„ íƒ
                    isReadOnly: false,
                    columns: [

                        {binding: 'id', header: 'ì¶œí•˜ë²ˆí˜¸', width: 100, align: 'right'},
                        {binding: 'company_id', header: 'íŒë§¤ì²˜id', width: 0, align: 'right', visible: false},
                        {binding: 'company_name', header: 'íŒë§¤ì²˜', width: '*', align: 'left', isReadOnly: true},
                        {binding: 'ship_date', header: 'ì¶œê³ ì¼', width: '*', align: 'center', isReadOnly: true},
                        {binding: 'item_count', header: 'í’ˆëª©ê±´ìˆ˜', width: '*', align: 'right', isReadOnly: true},
                        {binding: 'total_price', header: 'ì´ê³µê¸‰ê°€', width: '*', align: 'right', isReadOnly: true},
                        {binding: 'total_vat', header: 'ì´ë¶€ê°€ì„¸', width: '*', align: 'center', isReadOnly: true},
                        {binding: 'state_id', header: 'State id', width: '*', align: 'left', isReadOnly: true},
                        {binding: 'state_name', header: 'ìƒíƒœ', width: '*', align: 'center', isReadOnly: true},
                        {binding: 'description', header: 'ë¹„ê³ ', width: '*', align: 'left', isReadOnly: false},

                    ],
                    itemsSource: this.viewData,
                    formatItem: function (s, e) {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center'; // í—¤ë” í…ìŠ¤íŠ¸ ê°€ìš´ë° ì •ë ¬
                        }
                    },

                });
                //ë§¨ ì•ì— í—¤ë”ë¶€ë¶„ ì—†ì• ê¸°
                this.shipmentHeaderGrid.rowHeaders.columns.splice(0, 1);
                // ë°ì´í„° ë¡œë“œ í›„ ì´ˆê¸° ì„ íƒ ìƒíƒœ í•´ì œ
                this.shipmentHeaderGrid.loadedRows.addHandler(() => {
                    setTimeout(() => {
                        this.shipmentHeaderGrid.select(-1, -1); // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
                    }, 0); // ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ì—¬ ì´ˆê¸° ì„ íƒ í•´ì œ
                });
                let isInitialLoad = true; // ì´ˆê¸° ìƒíƒœ í”Œë˜ê·¸

                this.shipmentHeaderGrid.hostElement.addEventListener('click', (e) => {
                    const ht = this.shipmentHeaderGrid.hitTest(e);

                    // âœ… ì…€ì„ ë”ë¸”í´ë¦­í•œ ê²½ìš°ë§Œ ë™ì‘
                    if (ht.panel === this.shipmentHeaderGrid.cells) {
                        const selectedRowIndex = ht.row;
                        const selectedRowData = this.shipmentHeaderGrid.rows[selectedRowIndex].dataItem;

                        if (selectedRowData) {
                            // ğŸ‘‰ í´ë¦­ ì‹œë§Œ ì‹¤í–‰
                            _this.showShipmentList();

                            if (selectedRowData.state == "shipped") {
                                _this.$btnShipmentComplete.attr('disabled', 'disabled');
                                _this.$LotNumber.attr('disabled', 'disabled');
                                _this.$btnLOTSelect.attr('disabled', 'disabled');
                                _this.$btnLOTSelectCancel.attr('disabled', 'disabled');
                            } else {
                                _this.$btnShipmentComplete.removeAttr('disabled');
                                _this.$LotNumber.removeAttr('disabled');
                                _this.$btnLOTSelect.removeAttr('disabled');
                                _this.$btnLOTSelectCancel.removeAttr('disabled');
                            }

                            console.log(`ë”ë¸”í´ë¦­ëœ í–‰ ì¸ë±ìŠ¤: ${selectedRowIndex}`);
                            console.log('ë”ë¸”í´ë¦­ëœ í–‰ ë°ì´í„°:', selectedRowData);
                        }
                    }
                });
                this.$btnShipmentComplete = $('#btnShipmentComplete');
                this.$btnShipmentComplete.click(function (e) {

                    let headerItems = _this.shipmentHeaderGrid.selectedItems;
                    if (headerItems.length === 0 || headerItems === undefined || headerItems === null) {
                        Alert.alert('ì¶œê³ ì²˜ë¦¬', 'ì„ íƒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    let head_item = headerItems[0];
                    Alert.confirm('ì¶œê³ ì²˜ë¦¬', "ì¶œê³  ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", function () {
                        _this.shipmentStateComplete(head_item);
                    });
                });

                new FlexGridContextMenu(this.shipmentHeaderGrid);
                this.shipmentHeaderGrid.downloadFileName = 'ì¶œê³ ì§€ì‹œ';
            }

            initShipmentList() {
                let _this = this;

                this.shipmentListGrid = new wijmo.grid.FlexGrid('#theGrid2', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: false,
                    columns: [
                        {binding: 'shipment_id', header: 'ì¶œí•˜ìƒì„¸ë²ˆí˜¸', maxWidth: 170, align: 'left', isReadOnly: true},
                        {binding: 'mat_grp_name', header: 'ì œí’ˆê·¸ë£¹', maxWidth: 170, align: 'left', isReadOnly: true},
                        {binding: 'mat_code', header: 'ì œí’ˆì½”ë“œ', maxWidth: 140, align: 'center', isReadOnly: true},
                        {binding: 'mat_name', header: 'ì œí’ˆëª…', maxWidth: 200, align: 'left', isReadOnly: true},
                        {binding: 'unit_name', header: 'ë‹¨ìœ„', maxWidth: 100, align: 'center', isReadOnly: true},
                        {binding: 'standard', header: 'ê·œê²©', maxWidth: 100, align: 'center', isReadOnly: true},
                        {binding: 'OrderQty', header: 'ì§€ì‹œìˆ˜ëŸ‰', maxWidth: 100, align: 'right', isReadOnly: true},
                        {binding: 'Qty', header: 'ì²˜ë¦¬ëŸ‰', maxWidth: 100, align: 'right', isReadOnly: true},
                        {
                            binding: 'unit_price',
                            header: 'ë‹¨ê°€',
                            maxWidth: 120,
                            align: 'right',
                            isReadOnly: true, // í¸ì§‘ ê°€ëŠ¥
                            editor: new wijmo.input.InputNumber(document.createElement('div'), {
                                format: 'n0', // ì •ìˆ˜ í˜•ì‹
                                min: 0,       // ìµœì†Œê°’ ì„¤ì •
                                max: 99999,   // ìµœëŒ€ê°’ ì„¤ì •
                                step: 1       // ì¦ê°€/ê°ì†Œ ë‹¨ìœ„
                            })
                        },
                        {binding: 'price', header: 'ê³µê¸‰ê°€', maxWidth: 120, align: 'right', isReadOnly: true},
                        {binding: 'vat', header: 'ë¶€ê°€ì„¸', maxWidth: 100, align: 'right', isReadOnly: true},
                        {binding: 'invat_yn', header: 'ë¶€ê°€ì„¸í¬í•¨', maxWidth: 100, align: 'center', isReadOnly: true},
                        {binding: 'total_price', header: 'í•©ê³„', maxWidth: 120, align: 'right', isReadOnly: true},

                    ],
                    itemsSource: this.viewData2,
                    formatItem: function (s, e) {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center'; // í—¤ë” í…ìŠ¤íŠ¸ ê°€ìš´ë° ì •ë ¬
                        }
                    },

                });
                // ë°ì´í„° ë¡œë“œ í›„ ì´ˆê¸° ì„ íƒ ìƒíƒœ í•´ì œ
                this.shipmentListGrid.loadedRows.addHandler(() => {
                    setTimeout(() => {
                        this.shipmentListGrid.select(-1, -1); // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
                    }, 0); // ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ì—¬ ì´ˆê¸° ì„ íƒ í•´ì œ
                });

                this.shipmentListGrid.hostElement.addEventListener('click', (e) => {
                    const ht = this.shipmentListGrid.hitTest(e);
                    if (ht.cellType === wijmo.grid.CellType.Cell) {
                        const rowIndex = ht.row;
                        if (rowIndex >= 0) {
                            const selectedRowData = this.shipmentListGrid.rows[rowIndex].dataItem;
                            this.lastSelectedShipmentId = selectedRowData.shipment_id; // âœ… this ì‚¬ìš©
                            this.showMatLotConsumeList();
                            console.log('í´ë¦­ëœ í–‰:', rowIndex, selectedRowData);
                        }
                    }
                });
                new FlexGridContextMenu(this.shipmentListGrid);
                this.shipmentListGrid.downloadFileName = 'ì¶œê³ ';
            }

            initLotList() {
                let _this = this;
                this.lotListGrid = new wijmo.grid.FlexGrid('#theGrid3', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    allowSorting: 'MultiColumn',
                    selectionMode: wijmo.grid.SelectionMode.Row, // í–‰ ë‹¨ìœ„ ì„ íƒ
                    isReadOnly: false,
                    columns: [
                        {binding: 'LotNumber', header: 'LOT', maxWidth: 170, align: 'center', isReadOnly: true},
                        {binding: 'unit_name', header: 'ë‹¨ìœ„', maxWidth: 100, align: 'center', isReadOnly: true},
                        {
                            binding: 'OutputQty',
                            header: 'ìˆ˜ëŸ‰',
                            maxWidth: 120,
                            align: 'right',
                            isReadOnly: false, // í¸ì§‘ ê°€ëŠ¥
                            editor: new wijmo.input.InputNumber(document.createElement('div'), {
                                format: 'n0', // ì •ìˆ˜ í˜•ì‹
                                min: 0,       // ìµœì†Œê°’ ì„¤ì •
                                max: 99999,   // ìµœëŒ€ê°’ ì„¤ì •
                                step: 1       // ì¦ê°€/ê°ì†Œ ë‹¨ìœ„
                            })
                        },
                        {binding: 'EffectiveDate', header: 'ìœ íš¨ê¸°ê°„', width: '*', align: 'center', isReadOnly: true},

                    ],
                    itemsSource: this.viewData2,
                    formatItem: function (s, e) {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center'; // í—¤ë” í…ìŠ¤íŠ¸ ê°€ìš´ë° ì •ë ¬
                        }
                    },

                });
                // ë°ì´í„° ë¡œë“œ í›„ ì´ˆê¸° ì„ íƒ ìƒíƒœ í•´ì œ
                /* this.lotListGrid.loadedRows.addHandler(() => {
                     setTimeout(() => {
                         this.lotListGrid.select(-1, -1); // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
                     }, 0); // ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ì—¬ ì´ˆê¸° ì„ íƒ í•´ì œ
                 });*/
                let selector = new wijmo.grid.selector.Selector(this.lotListGrid, {
                    itemChecked: (e, ctx) => {
                        SelectItem = this.lotListGrid.rows.filter(r => r.isSelected);

                    }
                });
                new FlexGridContextMenu(this.lotListGrid);
                this.lotListGrid.downloadFileName = 'ì¶œê³ ';

                this.lotListGrid.itemsSource = new wijmo.collections.CollectionView([]);

                //LOTì§€ì • í´ë¦­
                this.$btnLOTSelect.click(function (e) {
                    _this.showLotSelectPopup();
                });

                this.$btnLOTSelectCancel.click(function (e) {
                    let lotItems = _this.lotListGrid.selectedItems;
                    if (lotItems.length === 0 || lotItems === undefined || lotItems === null) {
                        Alert.alert('LOT ì§€ì • ì·¨ì†Œ ì˜¤ë¥˜', 'ì„ íƒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    Alert.confirm('LOT ì§€ì • ì·¨ì†Œ', 'ì„ íƒëœ LOTë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
                        _this.deleteMatLotConsume(lotItems);
                    });
                });

                // LOTë²ˆí˜¸ ì¼ë°˜ ìŠ¤ìºë„ˆ
                /*this.$LotNumber.keydown(function (e) {
                    if (e.keyCode == 9) {
                        _this.showLotMaterialDetail();
                    }
                });*/

                // LOTë²ˆí˜¸ PDAìŠ¤ìºë„ˆ
                /*this.$LotNumber.keyup(function (e) {
                    if (e.keyCode == 0) {
                        _this.showLotMaterialDetail();
                    }
                });*/

                //LOTë²ˆí˜¸ ì…ë ¥ í›„ ì—”í„°í‚¤ ì…ë ¥
                this.$LotNumber.keypress(function (e) {
                    if (e.keyCode == 13) {
                        e.preventDefault();
                        let lot_number = _this.$LotNumber.val();
                        if (lot_number == "") {
                            return;
                        }

                        let headerItems = _this.shipmentHeaderGrid.selectedItems;
                        if (headerItems.length === 0 || headerItems === undefined || headerItems === null) {
                            Alert.alert('ë¡œíŠ¸ ì…ë ¥ ì˜¤ë¥˜', 'í•­ëª© ì„ íƒí•´ ì£¼ì„¸ìš”.');
                            this.$LotNumber.val('');
                            this.$LotNumber.focus();
                            return;
                        }

                        _this.showLotSelectPopup();
                    }
                });
            }

            // ë¡œíŠ¸ì…ë ¥ ì—”í„°í‚¤
            // showLotMaterialDetail() {
            //
            //
            //     let _this = this;
            //     let lot_number = this.$LotNumber.val();
            //     let headerItems = this.shipmentHeaderGrid.selectedItems;
            //     let sh_id = headerItems[0].id;
            //
            //
            //     let fnsuccess = function (result) {
            //
            //         if (result.data.length > 0) {
            //             console.log('1')
            //
            //             let content = tmpl('lotDetailTemplate', {});
            //             let $content = $(content);
            //             let modalContainer = new PopupDraggable('LOT ì§€ì • ìˆ˜ëŸ‰ ì…ë ¥');
            //             modalContainer.open({width: 800, height: 300, $content});
            //             console.log('2')
            //
            //             let $lotDetailForm = $content.find('#lotDetailForm');
            //             let selectedItem = result.data[0];
            //             selectedItem.lot_use_quantity = selectedItem.CurrentStock;
            //             FormUtil.BindDataForm(selectedItem, $lotDetailForm);
            //
            //             let $btnLotDetailSave = $content.find('#btnLotDetailSave');
            //             let $popLotUseQuantity = $content.find('#popLotUseQuantity');
            //             console.log('3')
            //
            //             //ìŠ¤ìº” íŒì—…ì—ì„œ ì €ì¥
            //             $btnLotDetailSave.click(function (e) {
            //                 let lot_use_quantity = $popLotUseQuantity.val();
            //                 if (lot_use_quantity == "" || lot_use_quantity == 0) {
            //                     Alert.alert('LOT ì¶”ê°€ ì˜¤ë¥˜', 'ì¶œê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì‹­ì‹œìš”');
            //                     return;
            //                 }
            //                 console.log('4')
            //
            //                 let fnOkCallback = function () {
            //                     let items = [];
            //                     let item = {
            //                         ml_id: selectedItem.ml_id,
            //                         material_id: selectedItem.Material_id,
            //                         quantity: lot_use_quantity,
            //                         shipment_id: selectedItem.shipment_id
            //                     };
            //                     items.push(item);
            //
            //                     let strItems = JSON.stringify(items);
            //                     let data = {
            //                         sh_id: sh_id,
            //                         Q: strItems
            //                     };
            //
            //                     let url = _this.url + '/save_mat_lot_cons';
            //                     let fnsuccess = function (result) {
            //                         if (result.success) {
            //                             modalContainer.close();
            //                             _this.showShipmentList();
            //                             _this.showMatLotConsumeList();
            //                         }
            //                     };
            //
            //                     AjaxUtil.postAsyncData(url, data, fnsuccess);
            //                 };
            //
            //                 Alert.confirm('LOT ì§€ì •', 'ì €ì¥ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', fnOkCallback);
            //             });
            //         } else {
            //             Alert.alert('LOT ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜', "ì ìš©í•  ìˆ˜ ìˆëŠ” LOT ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            //             return;
            //         }
            //     };
            //
            //     let data = {
            //         sh_id: sh_id,
            //         lot_number: lot_number
            //     };
            //     AjaxUtil.getAsyncData(this.url + '/mat_lot_search', data, fnsuccess);
            // }

            searchDataBind() {

                let _this = this;

                this.shipmentListGrid.itemsSource = new wijmo.collections.CollectionView([]);
                this.lotListGrid.itemsSource = new wijmo.collections.CollectionView([]);


                this.$LotNumber.attr('disabled', 'disabled');
                this.$btnLOTSelect.attr('disabled', 'disabled');
                this.$btnLOTSelectCancel.attr('disabled', 'disabled');

                let data = FormUtil.extractForm($('#searchForm'));
                data['action'] = 'read';

                let result = AjaxUtil.getSyncData(this.url + '/read', data);
                if (result != null) {
                    this.shipmentHeaderGrid.itemsSource = result.data;
                }
                enterFlag = false;
            }

            showMatLotConsumeList() {
                let headerItems = this.shipmentHeaderGrid.selectedItems;
                let shipmentItems = this.shipmentListGrid.selectedItems;
                if (headerItems.length === 0 || headerItems === null || headerItems === undefined) {
                    return;
                }
                let sh_id = headerItems[0].id;
                let shipment_id = null;
                if (shipmentItems != null && shipmentItems != undefined && shipmentItems.length > 0) {
                    shipment_id = shipmentItems[0].shipment_id;
                }

                this.lotListGrid.itemsSource = new wijmo.collections.CollectionView([]);
                let data = {
                    sh_id: sh_id,
                    shipment_id: shipment_id
                };
                let result = AjaxUtil.getSyncData(this.url + '/shipment_lot_list', data);
                if (result != null) {
                    this.lotListGrid.itemsSource = result.data;
                }
            }

            showShipmentList(callback) {

                console.log('í˜¸ì¶œ');
                let headerItems = this.shipmentHeaderGrid.selectedItems;
                if (headerItems.length === 0 || headerItems === null || headerItems === undefined) {
                    Alert.alert('', 'í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                    return;
                }

                let shipment_header = headerItems[0];
                let data = {
                    header_id: shipment_header.id
                };

                this.shipmentListGrid.itemsSource = new wijmo.collections.CollectionView([]);
                this.lotListGrid.itemsSource = new wijmo.collections.CollectionView([]);

                let result = AjaxUtil.getSyncData(this.url + '/shipment_list', data);
                if (result != null) {
                    this.shipmentListGrid.itemsSource = result.data;
                    setTimeout(() => {
                        if(typeof callback === 'function'){
                            callback();
                        }
                    })
                }
            }

            // LOT ì¶”ê°€ ë²„íŠ¼ í´ë¦­
            showLotSelectPopup() {
                let _this = this;

                let headerItems = this.shipmentHeaderGrid.selectedItems;
                let shipmentItems = this.shipmentListGrid.selectedItems;
                console.log('shipmentItems', shipmentItems);

                if (headerItems.length === 0 || headerItems === undefined || headerItems === null) {
                    Alert.alert('ë¡œíŠ¸ ì§€ì • ì˜¤ë¥˜', 'ì¶œê³  ì§€ì‹œ í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                    return;
                }

                if (shipmentItems.length === 0 || shipmentItems === undefined || shipmentItems === null) {
                    Alert.alert('ì•Œë¦¼ ', 'ì¶œí•˜ìƒì„¸ì •ë³´ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                    return;
                }

                let sh_id = headerItems[0].id;
                let shipment_id = shipmentItems[0].shipment_id;

                let material_id = null;

                if (shipmentItems.length > 0) {
                    material_id = shipmentItems[0].Material_id;
                }

                let content = tmpl('lotSelectTemplate', {});
                let $content = $(content);

                let modalContainer = new PopupDraggable('LOTì§€ì •');
                modalContainer.open({width: 800, height: 600, $content});
                let $lotForm = $content.find('#lotForm');

                let lotSearchGrid = null;
                let selectedItem = null;

                lotSearchGrid = new wijmo.grid.FlexGrid('#theGrid4', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    columns: [
                        {binding: 'LotNumber', header: 'LOT', width: 150, align: 'center'},
                        {binding: 'unit_name', header: 'ë‹¨ìœ„', width: '*', align: 'center'},
                        {binding: 'InputQty', header: 'ì´ˆê¸°ìˆ˜ëŸ‰', width: '*', align: 'right'},
                        {binding: 'CurrentStock', header: 'í˜„ì¬ê³ ëŸ‰', width: '*', align: 'right'},
                        {binding: 'mat_grp_name', header: 'í’ˆëª©ê·¸ë£¹', width: '*', align: 'left'},
                        {binding: 'mat_code', header: 'í’ˆëª©ì½”ë“œ', width: '*', align: 'center'},
                        {binding: 'mat_name', header: 'í’ˆëª©', width: '*', align: 'left'},
                    ],
                    itemsSource: _this.viewData4,
                    formatItem: function (s, e) {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center'; // í—¤ë” í…ìŠ¤íŠ¸ ê°€ìš´ë° ì •ë ¬
                        }
                    },

                });
                let isInitialLoad = true;
                lotSearchGrid.selectionChanged.addHandler((s, e) => {
                    if (isInitialLoad) {
                        isInitialLoad = false; // ì´ˆê¸° ë¡œë“œ ì´í›„ í”Œë˜ê·¸ í•´ì œ
                        //this.lotSearchGrid.select(-1, -1); // ì„ íƒ ìƒíƒœ í•´ì œ
                        return;
                    }

                    let selectedRowIndex = s.selection.row; // ì„ íƒëœ í–‰ì˜ ì¸ë±ìŠ¤
                    if (selectedRowIndex >= 0) { // ìœ íš¨í•œ í–‰ì´ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
                        let selectedRowData = s.rows[selectedRowIndex].dataItem; // ì„ íƒëœ í–‰ì˜ ë°ì´í„°

                        selectedRowData.lot_use_quantity = selectedRowData.CurrentStock;
                        FormUtil.BindDataForm(selectedRowData, $lotForm);
                        selectedItem = selectedRowData;

                        console.log(`ì„ íƒëœ í–‰ ì¸ë±ìŠ¤: ${selectedRowIndex}`);
                        console.log('ì„ íƒëœ í–‰ ë°ì´í„°:', selectedRowData);

                    }
                });
                // ë°ì´í„° ë¡œë“œ í›„ ì´ˆê¸° ì„ íƒ ìƒíƒœ í•´ì œ
                lotSearchGrid.loadedRows.addHandler(() => {
                    setTimeout(() => {
                        lotSearchGrid.select(-1, -1); // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
                    }, 0); // ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ì—¬ ì´ˆê¸° ì„ íƒ í•´ì œ
                });

                new FlexGridContextMenu(lotSearchGrid);
                lotSearchGrid.downloadFileName = 'ì¶œê³ ';

                let fnLotSearch = function () {
                    $lotForm[0].reset();
                    // í—¤ë”ë²ˆí˜¸ë§Œ ìˆê±°ë‚˜ í—¤ë°ì™€ materialì´ ë‹¤ ìˆê±°ë‚˜ ë‘˜ ì¤‘ í•˜ë‚˜
                    // í—¤ë”ë§Œ ìˆëŠ”ê²½ìš° ì¶œê³  í•­ëª©ì˜ ëª¨ë“  í¼ëª©ì— í•´ë‹¹ë˜ëŠ” lotì„ ë¦¬ìŠ¤íŠ¸ì—…
                    // í—¤ë”ì™€ material ì´ ìˆëŠ”ê²½ìš° í•´ë‹¹ í’ˆëª©ì— í•´ë‹¹ë˜ëŠ” lot ë¦¬ìŠ¤íŠ¸ì—…
                    let data = {
                        material_id: material_id,
                        sh_id: sh_id,
                        lot_number: $('#LotNumber').val().trim()
                    };

                    let result = AjaxUtil.getSyncData(_this.url + '/mat_lot_search', data);
                    if (result) {
                        _this.viewData4.sourceCollection = result.data;

                    }
                };
                fnLotSearch();

                let $btnLotSave = $content.find('#btnLotSave');
                let $btnLotRefresh = $content.find('#btnLotRefresh');
                let $popLotUseQuantity = $content.find('#popLotUseQuantity');

                // ë¡œíŠ¸ ì„ íƒ, ìˆ˜ëŸ‰ ì…ë ¥ í›„ ì €ì¥ë²„íŠ¼ í´ë¦­
                $btnLotSave.click(function (e) {
                    if (selectedItem.CurrentStock <= 0) {
                        Alert.alert('LOT ì¶”ê°€ ì˜¤ë¥˜', 'í˜„ì¬ê³ ë¥¼ í™•ì¸í•˜ì‹­ì‹œìš”');
                        return;
                    }

                    let lot_use_quantity = $popLotUseQuantity.val();
                    if (lot_use_quantity == "" || lot_use_quantity == 0) {
                        Alert.alert('LOT ì¶”ê°€ ì˜¤ë¥˜', 'ì¶œê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì‹­ì‹œìš”');
                        return;
                    }

                    let fnOkCallback = function () {
                        let items = [];
                        let item = {
                            ml_id: selectedItem.ml_id,
                            material_id: selectedItem.Material_id,
                            quantity: lot_use_quantity,
                            shipment_id: selectedItem.shipment_id
                        };
                        items.push(item);

                        let strItems = JSON.stringify(items);
                        let data = {
                            sh_id: sh_id,
                            shipment_id : shipment_id,
                            Q: strItems
                        };

                        let url = _this.url + '/save_mat_lot_cons';

                        //í˜„ì¬ ì„ íƒëœ í–‰
                        const selectedRow = _this.shipmentListGrid.selection.row >= 0
                            ? _this.shipmentListGrid.rows[_this.shipmentListGrid.selection.row].dataItem :
                            null;
                        const selectedId = selectedRow ? selectedRow.shipment_id : null;

                        let fnsuccess = function (result) {
                            if (result.success) {
                                fnLotSearch();

                                _this.showShipmentList(() => {
                                    const lastId = _this.lastSelectedShipmentId;
                                    if (!lastId) return;

                                    const view = _this.shipmentListGrid.collectionView;
                                    if (!view || !view.items || view.items.length === 0) return;

                                    const index = view.items.findIndex(item => String(item.shipment_id) === String(lastId));
                                    if (index < 0) return;

                                    console.log(`ì´ì „ ì„ íƒ í–‰ ë³µì› ì‹œë„: ${index}`);

                                    // âœ… ë Œë” ì™„ë£Œ í›„ DOM íƒìƒ‰ (ì‚´ì§ ë”œë ˆì´)
                                    setTimeout(() => {
                                        const grid = _this.shipmentListGrid;
                                        const view = grid.collectionView;

                                        if (!view || !view.items || view.items.length === 0) return;

                                        const index = view.items.findIndex(
                                            item => String(item.shipment_id) === String(_this.lastSelectedShipmentId)
                                        );
                                        if (index < 0) return;

                                        console.log(`ì´ì „ ì„ íƒ í–‰ ë³µì›: ${index}`);

                                        // ğŸ”¹ ì´ë²¤íŠ¸ ì¼ì‹œ ì¤‘ë‹¨ (selectionChangedë‚˜ í´ë¦­ í•¸ë“¤ëŸ¬ê°€ ë°˜ì‘í•˜ì§€ ì•Šê²Œ)
                                        const clickHandlers = grid.hostElement.onclick;
                                        grid.hostElement.onclick = null;

                                        const selHandlers = grid.selectionChanged._handlers ? [...grid.selectionChanged._handlers] : [];
                                        grid.selectionChanged._handlers = [];

                                        // ğŸ”¹ UI ì—…ë°ì´íŠ¸ ìµœì†Œí™”
                                        grid.deferUpdate(() => {
                                            grid.select(index, 0);
                                            grid.scrollIntoView(index, 0);
                                        });

                                        // ğŸ”¹ ë¡œì§ ì§ì ‘ ì‹¤í–‰ (í´ë¦­ ì—†ì´)
                                        const selectedRowData = view.items[index];
                                        _this.lastSelectedShipmentId = selectedRowData.shipment_id;
                                        _this.showMatLotConsumeList();

                                        // ğŸ”¹ ì´ë²¤íŠ¸ ë³µêµ¬
                                        grid.selectionChanged._handlers = selHandlers;
                                        grid.hostElement.onclick = clickHandlers;

                                        console.log('ì´ì „ ì„ íƒ í–‰ ì™„ì „ ë³µì› ì™„ë£Œ:', selectedRowData);
                                    }, 0);
                                });
                            } else {
                                Alert.alert('', result.message);
                            }
                        };

                        AjaxUtil.postAsyncData(url, data, fnsuccess);
                    };

                    Alert.confirm('LOT ì§€ì •', 'ì €ì¥ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', fnOkCallback);
                });
                $btnLotRefresh.click(function (e) {
                    fnLotSearch();
                })
                return;

            }

            deleteMatLotConsume(selectedLotItems) {
                let _this = this;
                let headerItems = this.shipmentHeaderGrid.selectedItems;
                let shipmentItems = this.shipmentListGrid.selectedItems;

                if (headerItems.length === 0 || headerItems === undefined || headerItems === null) {
                    Alert.alert('', 'ì¶œí•˜ì •ë³´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                if (shipmentItems.length === 0 || shipmentItems === undefined || shipmentItems === null) {
                    Alert.alert('', 'ì¶œí•˜ìƒì„¸ì •ë³´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                let sh_id = headerItems[0].id;
                let shipment_id = shipmentItems[0].shipment_id;

                let items = [];
                $.each(selectedLotItems, function (idx, item) {
                    items.push(item.mlc_id);
                });
                let strData = JSON.stringify(items);
                let data = {
                    sh_id: sh_id,
                    shipment_id: shipment_id,
                    Q: strData
                };
                const selectedRow = _this.shipmentListGrid.selection.row >= 0
                    ? _this.shipmentListGrid.rows[_this.shipmentListGrid.selection.row].dataItem :
                    null;
                const selectedId = selectedRow ? selectedRow.shipment_id : null;

                let fnSuccess = function (res) {
                    if (res.success) {
                        AjaxUtil.hideLoading();

                        Notify.success("LOTì§€ì • ì·¨ì†Œ ì™„ë£Œ.");
                        _this.showShipmentList(() => {
                            const lastId = _this.lastSelectedShipmentId;
                            if (!lastId) return;

                            const view = _this.shipmentListGrid.collectionView;
                            if (!view || !view.items || view.items.length === 0) return;

                            const index = view.items.findIndex(item => String(item.shipment_id) === String(lastId));
                            if (index < 0) return;

                            console.log(`ì´ì „ ì„ íƒ í–‰ ë³µì› ì‹œë„: ${index}`);

                            // âœ… ë Œë” ì™„ë£Œ í›„ DOM íƒìƒ‰ (ì‚´ì§ ë”œë ˆì´)
                            setTimeout(() => {
                                const grid = _this.shipmentListGrid;
                                const view = grid.collectionView;

                                if (!view || !view.items || view.items.length === 0) return;

                                const index = view.items.findIndex(
                                    item => String(item.shipment_id) === String(_this.lastSelectedShipmentId)
                                );
                                if (index < 0) return;

                                console.log(`ì´ì „ ì„ íƒ í–‰ ë³µì›: ${index}`);

                                // ğŸ”¹ ì´ë²¤íŠ¸ ì¼ì‹œ ì¤‘ë‹¨ (selectionChangedë‚˜ í´ë¦­ í•¸ë“¤ëŸ¬ê°€ ë°˜ì‘í•˜ì§€ ì•Šê²Œ)
                                const clickHandlers = grid.hostElement.onclick;
                                grid.hostElement.onclick = null;

                                const selHandlers = grid.selectionChanged._handlers ? [...grid.selectionChanged._handlers] : [];
                                grid.selectionChanged._handlers = [];

                                // ğŸ”¹ UI ì—…ë°ì´íŠ¸ ìµœì†Œí™”
                                grid.deferUpdate(() => {
                                    grid.select(index, 0);
                                    grid.scrollIntoView(index, 0);
                                });

                                // ğŸ”¹ ë¡œì§ ì§ì ‘ ì‹¤í–‰ (í´ë¦­ ì—†ì´)
                                const selectedRowData = view.items[index];
                                _this.lastSelectedShipmentId = selectedRowData.shipment_id;
                                _this.showMatLotConsumeList();

                                // ğŸ”¹ ì´ë²¤íŠ¸ ë³µêµ¬
                                grid.selectionChanged._handlers = selHandlers;
                                grid.hostElement.onclick = clickHandlers;

                                console.log('ì´ì „ ì„ íƒ í–‰ ì™„ì „ ë³µì› ì™„ë£Œ:', selectedRowData);
                            }, 200);





                        });

                        if (shipment_id != null) {
                            _this.shipmentListGrid.select(shipmentItems[0].__index);
                        }
                        _this.showMatLotConsumeList();

                    } else {
                        Alert.alert('', res.message);//Notify.success("LOTì§€ì • ì·¨ì†Œ ì‹¤íŒ¨.");
                    }
                }
                let url = this.url + '/delete_mal_lot_consume';
                AjaxUtil.postAsyncData(url, data, fnSuccess);

                return;
            }

            //ì¶œê³ ì²˜ë¦¬
            shipmentStateComplete(head_item) {
                let _this = this;
                let data = {sh_id: head_item.id, description: head_item.description};
                let url = this.url + '/shipment_status_complete';
                let fnSuccess = function (result) {
                    if (result.success) {
                        _this.searchDataBind();
                        Notify.success("ì¶œê³  ì²˜ë¦¬ ì™„ë£Œ.");
                    } else {
                        if (result.message != '') {
                            Alert.alert('', result.message);
                        } else {
                            Notify.success("ì¶œê³  ì²˜ë¦¬ ì‹¤íŒ¨.");
                        }
                    }
                }
                AjaxUtil.postAsyncData(url, data, fnSuccess);
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const keywordInput = document.getElementById("keyword");

            keywordInput.addEventListener("keydown", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€
                    page.searchMain();
                }
            });
        });


        let page = null;

        $(document).ready(function (e) {
            page = new ShipmentProcessPage();

            $('#srchStartDt').val(CommonUtil.getYYYYMMDD(-7));
            $('#srchEndDt').val(CommonUtil.getYYYYMMDD());

            $('#btnListCollapse').click(function (e) {
                $('#divList').toggle(300);
            });

            // ê²€ìƒ‰
            $('#btnSearch').click(function (e) {
                page.searchDataBind();
            });

            $('#searchForm').on('keydown', function(e){
                if(e.key === 'Enter'){
                    page.searchDataBind();
                }
            })

            page.searchDataBind();
        })
    </script>

</th:block>
</html>