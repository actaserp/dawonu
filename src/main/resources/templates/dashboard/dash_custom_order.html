<html layout:decorate="~{layout_page}">
<head>
    <style>
        #work-table td{
            text-align: left !important;
            width: 100%;
        }

        #work-table td input{
            width: 100%;
        }
    </style>
</head>

<th:block layout:fragment="content">
    <div class="layout-contents">
        <div style="display: flex; gap: 5px;">
            <section class="section" style="flex: 2.5;">
                <div class="section-top">
                    <div class="search-wrap">
                        <dl>
                            <dt>
                                ÏÉùÏÇ∞Ïùº<span class="eq">*</span>
                            </dt>
                            <dd>
                                <ul class="date-box">
                                    <li>
                                        <input type="date" id="date_from" name="date_from">
                                        <label for="date_from" class="hide">ÏãúÏûëÏùº</label>
                                    </li>
                                    <li>
                                        <input type="date" id="date_to" name="date_to">
                                        <label for="date_to" class="hide">Ï¢ÖÎ£åÏùº</label>
                                    </li>
                                </ul>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="choComp">
                                    Í±∞ÎûòÏ≤ò<span class="eq"></span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <input id="choComp" name="choComp" style="width: 160px;"/>
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>&nbsp;</dt>
                            <dd>
                                <li>
                                    <a class="btn btn-search" title="Í≤ÄÏÉâ" id="btnMainSearch">
                                        <!--                                        class Ïì∞Ïù¥Îäî Í≥≥ Ï∞æÍ≥† ÏóÜÏúºÎ©¥ ÌÅ¥ÎûòÏä§Î™Ö ÏàòÏ†ïÌïòÍ∏∞-->
                                        <img src="/images/icon/btn-srch.svg" alt="Í≤ÄÏÉâ ÏïÑÏù¥ÏΩò">
                                        Í≤ÄÏÉâ
                                    </a>
                                </li>
                            </dd>
                        </dl>
                    </div>
                </div>
                <div class="container-fluid" style="height: 35vh;">
                    <div id="prod-result-grid"></div>
                </div>
                <div class="container-fluid" style="margin-top: 5px; height: 10vh;">
                    <div id="result-grid"></div>
                </div>
            </section>

            <div class="tab-wrap" style="flex: 1; min-width: 0;">

                <ul class="tab-links">
                    <li><a href="#tabHistory" name="tabHistory">Ïù¥Î†•</a></li>
                    <li><a href="#tabCompany" name="tabCompany">Í±∞ÎûòÏ≤ò</a></li>

                </ul>
                <div>
                    <section class="tab-item" id="tabHistory" style="border-top-left-radius: 0;">
                        <div class="grid_box">
                            <div class="container-fluid">
                                <div id="history-grid"></div>
                            </div>
                        </div>

                    </section>
                    <section class="tab-item" id="tabCompany" style="border-top-left-radius: 0;">
                        <div class="section-top">

                            <div class="table-wrap">
                                <form id="companyForm">
                                    <input type="hidden" id="id" name="id"/>
                                    <table id="work-table">
                                        <caption>Í±∞ÎûòÏ≤ò ÌÖåÏù¥Î∏î</caption>
                                        <colgroup>
                                            <col style="width: 40%;">
                                            <col style="width: 60%;">
                                        </colgroup>
                                        <tbody>
                                        <tr>
                                            <th><label for="name">ÌöåÏÇ¨Î™Ö</label></th>
                                            <td><input type="text" id="name" name="name" readonly/></td>
                                        </tr>
                                        <tr>
                                            <th><label for="business_number">ÏÇ¨ÏóÖÏûê Î≤àÌò∏</label></th>
                                            <td><input type="text" id="business_number" name="business_number" readonly/></td>
                                        </tr>
                                        <tr>
                                            <th><label for="ceo_name">ÎåÄÌëúÏûêÎ™Ö</label></th>
                                            <td><input type="text" id="ceo_name" name="ceo_name" readonly/></td>
                                        </tr>
                                        <tr>
                                            <th><label for="address">ÏÇ¨ÏóÖÏû• Ï£ºÏÜå</label></th>
                                            <td>
                                                <input id="address" name="address" readonly />
                                            </td>
                                        </tr>
                                        <tr>
                                            <th><label for="business_type">ÏóÖÌÉú</label></th>
                                            <td ><input type="text" id="business_type" name="business_type" readonly/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th><label for="business_item">ÏóÖÏ¢Ö</label></th>
                                            <td>
                                                <input type="text" id="business_item" name="business_item" readonly/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th><label for="tel_number">Ïó∞ÎùΩÏ≤ò</label></th>
                                            <td >
                                                <input type="text" id="tel_number" name="tel_number" readonly/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th><label for="email">Ïù¥Î©îÏùº</label></th>
                                            <td><input type="text" id="email" name="email" readonly/></td>
                                        </tr>
                                        <tr>
                                            <th><label for="fax_number">Ìå©Ïä§</label></th>
                                            <td><input type="text" id="fax_number" name="fax_number" readonly /></td>
                                        </tr>
                                        <tr>
                                            <th><label for="description">ÏÑ§Î™Ö</label></th>
                                            <td><textarea id="description" name="description" readonly></textarea></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </form>
                            </div>
                        </div>
                    </section>
                </div>

            </div>
        </div>
    </div>

</th:block>


<th:block layout:fragment="scripts">
    <script type="text/javascript">

        class DashCustomPage {
            constructor() {
                this.grid = null;
                this.resultGrid = null;
                this.historyGrid = null;
                this.baseUrl = '/api/dashboard';
                this.init();
            }

            init() {
                let _this = this;

                this.grid = new wijmo.grid.FlexGrid('#prod-result-grid', {
                    autoGenerateColumns: false,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    formatItem: (s, e) => {
                        // Ìó§Îçî Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                            const binding = s.columns[e.col].binding;
                            if (binding === 'Description') {
                                e.cell.style.color = '#5567ff'; // Í∏ÄÏûê ÏÉâ Ï†ÅÏö©
                            }
                            return;
                        }

                        // Î≥∏Î¨∏ ÏÖÄ ÏÉâÏÉÅ Ï≤òÎ¶¨
                        if (e.panel.cellType === wijmo.grid.CellType.Cell) {
                            const col = s.columns[e.col];
                            const item = s.rows[e.row]?.dataItem;

                            // Ïû¨ÌôúÏö© ÏÖÄ Ï¥àÍ∏∞Ìôî(Ï§ëÏöî)
                            e.cell.style.color = '';
                            e.cell.style.fontWeight = '';

                            if (col && col.binding === 'division' && item) {
                                const isSuju = item.division === 'ÏàòÏ£º';

                                // ÏÉâÏÉÅÏùÄ Í∏∞Ï°¥ Î°úÏßÅ Í∑∏ÎåÄÎ°ú
                                e.cell.style.color = isSuju ? '#1d4ed8' : '#dc2626';
                                e.cell.style.fontWeight = '600';

                                // üëá ÌëúÏãúÎßå Î∞îÍæºÎã§: ÏàòÏ£ºÎäî 'ÏàòÏ£º', Í∑∏ Ïô∏(Î∞úÏ£º/Îß§ÏûÖ)Îäî 'Îß§ÏûÖ'
                                e.cell.textContent = isSuju ? 'ÏàòÏ£º' : 'Îß§ÏûÖ';
                                return; // ÎÅù
                            }
                        }
                    },
                    isReadOnly: true,
                    showMarquee: true,
                    columns: [
                        {binding: 'head_id', visible: false},
                        {binding: 'division', header: 'Íµ¨Î∂Ñ', width: 70, align: 'center'},
                        {binding: 'JumunDate', header: 'ÏûëÏÑ±ÏùºÏûê', width: 100, align: 'center'},
                        {binding: 'state_name', header: 'ÏÉÅÌÉú', width: 80, align: 'center'},
                        // {binding: 'JumunNumber', header: 'Î≤àÌò∏', width: 120, align: 'center'},
                        {binding: 'company_name', header: 'Í±∞ÎûòÏ≤òÎ™Ö', width: 120, align: 'center'},
                        {binding: 'BusinessNumber', header: 'ÏÇ¨ÏóÖÏûêÎ≤àÌò∏', width: 120, align: 'center'},
                        {binding: 'product_name', header: 'Ï†úÌíàÎ™Ö', width: 200, align: 'left'},
                        {binding: 'price', header: 'Í≥µÍ∏âÍ∞ÄÏï°', width: 100, align: 'right'},
                        {binding: 'vat', header: 'ÏÑ∏Ïï°', width: 80, align: 'right'},
                        {binding: 'total_price', header: 'Ìï©Í≥Ñ', width: 100, align: 'right'},
                        {binding: 'Description', header: 'Î©îÎ™®', width: '*', align: 'left'},
                    ],
                    itemsSource: new wijmo.collections.CollectionView([]),
                });
                new FlexGridContextMenu(this.grid);
                this.grid.downloadFileName = 'ÏßÑÌñâ ÎÇ¥Ïó≠';

                // ÎçîÎ∏îÌÅ¥Î¶≠: Description ÏÖÄÏóêÏÑúÎäî Ïä§Ìã∞Ïª§, Í∑∏ Ïô∏ÏóêÎäî Í∏∞Ï°¥ ÎèôÏûë
                this.grid.hostElement.addEventListener('dblclick', (e) => {
                    const grid = this.grid;                           // ÏïàÏ†ÑÌïòÍ≤å Ï∞∏Ï°∞
                    const ht = grid.hitTest(e);

                    if (ht.cellType === wijmo.grid.CellType.Cell) {   // ‚Üê CellType Ï∞∏Ï°∞ ÏàòÏ†ï
                        const col  = grid.columns[ht.col];
                        const item = grid.rows[ht.row]?.dataItem;

                        if (col && col.binding === 'Description' && item) {
                            const rect = grid.getCellBoundingRect(ht.row, ht.col, true);
                            openMemoSticker(grid, rect, item, this.baseUrl); // Ïä§Ìã∞Ïª§ Ïò§Ìîà
                            return; // Î©îÎ™® ÏÖÄÏùº Îïê Í∏∞Î≥∏ ÎèôÏûë ÎßâÍ∏∞
                        }
                    }

                    // (Í∏∞Ï°¥ ÎèôÏûë) Description Ïô∏ ÎçîÎ∏îÌÅ¥Î¶≠ Ïãú
                    const items = grid.selectedItems;
                    if (!items || items.length === 0) return;
                    this.getDetail();
                    this.getHistory();
                    this.getCompany();
                });


                this.resultGrid = new wijmo.grid.FlexGrid('#result-grid', {
                    autoGenerateColumns: false,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.All,
                    showMarquee: true,
                    formatItem: (s, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.RowHeader) {
                            // Ìó§ÎçîÏóê ÏàúÎ≤à
                            e.cell.textContent = (e.row + 1).toString();
                        }
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnFooter) {
                            const col = s.columns[e.col];
                            if (col.binding === 'product_name') {
                                e.cell.textContent = 'Ìï©Í≥Ñ';
                                e.cell.style.textAlign = 'center';
                            }
                        }
                    },
                    columns: [
                        {binding: 'id', visible:false},
                        {binding: 'JumunDate', header: 'ÏùºÏûê', width: 100, align: 'center', isReadOnly: true},
                        {binding: 'state_name', header: 'ÏÉÅÌÉú', width: 80, align: 'center'},
                        {binding: 'product_name', header: 'Ï†úÌíàÎ™Ö', width: 200, align: 'left', isReadOnly: true},
                        {binding: 'standard', header: 'Í∑úÍ≤©', width: 80, align: 'center', isReadOnly: true},
                        {binding: 'quantity', header: 'ÏàòÎüâ', width: 80, align: 'right', isReadOnly: true, aggregate: wijmo.Aggregate.Sum},
                        {binding: 'unit_price', header: 'Îã®Í∞Ä', width: 80, align: 'right', isReadOnly: true},
                        {binding: 'supply_amount', header: 'Í≥µÍ∏âÍ∞ÄÏï°', width: 100, align: 'right', isReadOnly: true, aggregate: wijmo.Aggregate.Sum},
                        {binding: 'vat_amount', header: 'ÏÑ∏Ïï°', width: 100, align: 'right', isReadOnly: true, aggregate: wijmo.Aggregate.Sum},
                        {binding: 'total_amount', header: 'Ìï©Í≥Ñ', width: 100, align: 'right', isReadOnly: true, aggregate: wijmo.Aggregate.Sum},
                        {binding: 'description', header: 'ÎπÑÍ≥†', width: '*', align: 'left', isReadOnly: true},

                    ],
                    itemsSource: new wijmo.collections.CollectionView([]),
                });

                // ÌïòÎã® Ìï©Í≥Ñ Ìñâ Ï∂îÍ∞Ä
                this.resultGrid.columnFooters.rows.push(new wijmo.grid.GroupRow());

                // Context Menu Ï∂îÍ∞Ä
                new FlexGridContextMenu(this.resultGrid);
                this.resultGrid.downloadFileName = 'ÌíàÎ™© ÎÇ¥Ïó≠';


                this.historyGrid = new wijmo.grid.FlexGrid('#history-grid', {
                    autoGenerateColumns: false,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    showMarquee: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        {binding: 'product_name', header: 'Ï†úÌíàÎ™Ö', width: 170, align: 'left', isReadOnly: true},
                        {binding: 'standard', header: 'Í∑úÍ≤©', width: 70, align: 'center', isReadOnly: true},
                        {binding: 'state_name', header: 'ÏÉÅÌÉú', width: 70, align: 'center', isReadOnly: true},
                        {binding: 'event_time', header: 'ÏÉùÏÑ±ÏãúÍ∞Ñ', width: 170, align: 'center', isReadOnly: true},
                    ],
                    itemsSource: new wijmo.collections.CollectionView([]),
                });

                // Context Menu Ï∂îÍ∞Ä
                new FlexGridContextMenu(this.historyGrid);
                this.historyGrid.downloadFileName = 'Ï∞®ÏàòÎ≥Ñ ÏÉùÏÇ∞ ÎÇ¥Ïó≠';

            }

            getDetail () {
                let _this = this;

                const it = _this.grid.selectedItems && _this.grid.selectedItems[0];
                let data = {
                    id: it.head_id,
                    division: it.division,
                };
                let result = AjaxUtil.getSyncData(this.baseUrl + '/detail', data);
                if (result.data && _this.grid.itemsSource) {

                    _this.resultGrid.itemsSource = result.data;
                }

            };

            getHistory () {
                let _this = this;

                const it = _this.grid.selectedItems && _this.grid.selectedItems[0];
                let data = {
                    id: it.head_id,
                    division: it.division,
                };
                // 1) Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                let result = AjaxUtil.getSyncData(this.baseUrl + '/history', data);
                if (result.data) {
                    const rows = result.data.map(r => ({
                        ...r,
                        event_time: new Date(r.event_time) // ISO ‚Üí Date
                    }));

                    // 2) Í∑∏Î£π/Ï†ïÎ†¨ ÏÑ§Ï†ï
                    const labelMap = { suju: 'ÏàòÏ£º', job: 'ÏÉùÏÇ∞', shipment: 'Ï∂úÍ≥†', balju: 'Î∞úÏ£º', input: 'ÏûÖÍ≥†' };

                    const cv = new wijmo.collections.CollectionView(rows);
                    // event_typeÏúºÎ°ú Í∑∏Î£π (Ï†ïÎ†¨ ÌÇ§Î•º Ï†ëÎëêÎ°ú Î∂ôÏó¨ ÏàúÏÑú Í≥†Ï†ï)
                    cv.groupDescriptions.push(new wijmo.collections.PropertyGroupDescription(
                        'event_type',
                        item => {
                            const t = item.event_type;
                            const label = labelMap[t] ?? t;  // 'ÏàòÏ£º' Îì±
                            return `${label}`;      // Í∑∏Î£π Í∞í(value)Ïù¥ Îê®
                        }
                    ));
                    // Í∑∏Î£π ÎÇ¥ ÏãúÍ∞ÑÏàú Ï†ïÎ†¨
                    cv.sortDescriptions.push(new wijmo.collections.SortDescription('event_time', true));

                    this.historyGrid.itemsSource = cv;

                    // 3) Ïª¨Îüº ÌÉÄÏûÖ/Ìè¨Îß∑(ÏÑ†ÌÉù)
                    const col = this.historyGrid.columns.getColumn('event_time');
                    if (col) {
                        col.dataType = wijmo.DataType.Date;
                        col.format = 'yyyy-MM-dd HH:mm:ss';
                    }

                    // 4) Í∑∏Î£π Ìó§Îçî ÌëúÏãú ÏòàÏÅòÍ≤å (Ï†ëÎëê "1:" Ï†úÍ±∞ + Í±¥Ïàò ÌëúÏãú)
                    this.historyGrid.groupHeaderFormat = '{value} ';
                    this.historyGrid.formatItem = (s, e) => {
                        // Í∏∞Ï°¥ Ìó§Îçî Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨ Ïú†ÏßÄ
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                        // Í∑∏Î£π Ìó§Îçî Íæ∏ÎØ∏Í∏∞
                        if (e.panel === s.cells) {
                            const row = s.rows[e.row];
                            if (row instanceof wijmo.grid.GroupRow) {
                                const g = row.dataItem; // CollectionViewGroup
                                if (e.col === 0) {
                                    const raw = String(g.name);            // "1:ÏàòÏ£º" Í∞ôÏùÄ Î¨∏ÏûêÏó¥
                                    const label = raw.replace(/^\d+:/, ''); // "ÏàòÏ£º"Îßå Ï∂îÏ∂ú
                                    e.cell.textContent = `${label} (${g.items.length}Í±¥)`;
                                    e.cell.style.fontWeight = '600';
                                } else {
                                    // Í∑∏Î£π Ìó§ÎçîÏùò ÎÇòÎ®∏ÏßÄ ÏπºÎüºÏùÄ ÎπÑÏö∞Í∏∞
                                    e.cell.textContent = '';
                                }
                            }
                        }
                    };
                }
            };


            getCompany () {
                let _this = this;

                const it = _this.grid.selectedItems && _this.grid.selectedItems[0];
                let data = {
                    company_id: it.company_id
                };
                let result = AjaxUtil.getSyncData('/api/definition/company/detail', data);
                if (result.data) {
                    const d = { ...result.data };
                    d.business_number = formatBizNo(d.business_number);
                    d.tel_number      = formatPhone(d.tel_number);
                    d.fax_number      = formatPhone(d.fax_number);
                    FormUtil.BindDataForm(d, $('#companyForm'));
                }

            };

            // ÏûëÏóÖÎ™©Î°ù Ï°∞Ìöå
            searchMainData() {
                let _this = this;

                let param = {
                    'date_from': $('#date_from').val(),
                    'date_to': $('#date_to').val(),
                    'choComp': $('#choComp').val(),
                };

                let result = AjaxUtil.getSyncData(this.baseUrl + '/read', param);
                if (result.data && _this.grid.itemsSource) {
                    const rows = result.data.map(r => ({
                        ...r,
                        BusinessNumber: formatBizNo(r.BusinessNumber) // ‚Üê Í∞Å Ìï≠Î™©Ïóê ÌïòÏù¥Ìîà Ï†ÅÏö©
                    }));
                    _this.grid.itemsSource = new wijmo.collections.CollectionView(rows);
                }
            }

        }

        // Í≥µÌÜµ: Ïà´ÏûêÎßå ÎÇ®Í∏∞Í∏∞
        const digits = v => String(v || '').replace(/\D/g, '');

        // ÏÇ¨ÏóÖÏûêÎ≤àÌò∏: 10ÏûêÎ¶¨ ‚Üí 000-00-00000
        const formatBizNo = v => {
            const d = digits(v);
            return d.length === 10 ? `${d.slice(0,3)}-${d.slice(3,5)}-${d.slice(5)}` : v || '';
        };

        // Ï†ÑÌôî/Ìå©Ïä§
        const formatPhone = v => {
            const d = digits(v);
            if (!d) return '';

            if (d.startsWith('02')) { // ÏÑúÏö∏
                return d.length >= 10
                    ? `02-${d.slice(2, d.length-4)}-${d.slice(-4)}`
                    : `02-${d.slice(2,5)}-${d.slice(5)}`;
            }
            if (/^01[016789]/.test(d)) { // Ìú¥ÎåÄÌè∞
                return d.length === 11
                    ? `${d.slice(0,3)}-${d.slice(3,7)}-${d.slice(7)}`
                    : `${d.slice(0,3)}-${d.slice(3,6)}-${d.slice(6)}`;
            }
            if (d.startsWith('070')) {
                return `070-${d.slice(3, d.length-4)}-${d.slice(-4)}`;
            }
            if (d.startsWith('050')) {
                return `${d.slice(0,4)}-${d.slice(4,8)}-${d.slice(8)}`;
            }
            // ÏùºÎ∞ò ÏßÄÏó≠Î≤àÌò∏(3ÏûêÎ¶¨ Í∞ÄÏ†ï)
            return d.length >= 9
                ? `${d.slice(0,3)}-${d.slice(3, d.length-4)}-${d.slice(-4)}`
                : v || '';
        };

        function ensureMemoSticker() {
            let sticker = document.getElementById('memo-sticker');
            if (sticker) return sticker;

            sticker = document.createElement('div');
            sticker.id = 'memo-sticker';
            sticker.style.cssText = `
    position:absolute; display:none; z-index:10000;
    width:320px; background:#d1d5db; border:1px solid #d1d5db;
    box-shadow:0 8px 20px rgba(0,0,0,.15); border-radius:10px; padding:10px;
  `;
            sticker.innerHTML = `
    <div id="memoHeader" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;cursor:move;user-select:none;">
      <strong>Î©îÎ™®</strong>
      <button type="button" id="memoCloseBtn" style="border:none;background:transparent;font-size:18px;cursor:pointer;">‚úï</button>
    </div>
    <textarea id="memoText" rows="6" style="width:100%;height:180px;box-sizing:border-box;resize:vertical;"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button type="button" id="memoSaveBtn"   style="padding:6px 10px;border-radius:6px;border:1px solid #d1d5db;cursor:pointer;">Ï†ÄÏû•</button>
      <button type="button" id="memoCancelBtn" style="padding:6px 10px;border-radius:6px;border:1px solid #d1d5db;background:#fff;cursor:pointer;">Ï∑®ÏÜå</button>
    </div>
  `;
            document.body.appendChild(sticker);

            // ‚òÖ ÎìúÎûòÍ∑∏ Í∞ÄÎä•ÌïòÍ≤å
            makeStickerDraggable(sticker, sticker.querySelector('#memoHeader'));
            return sticker;
        }

        function makeStickerDraggable(sticker, handle) {
            let dragging = false, startX = 0, startY = 0, startLeft = 0, startTop = 0;
            let prevUserSelect = '';

            const onDown = (clientX, clientY, preventDefault) => {
                dragging = true;
                const rect = sticker.getBoundingClientRect();
                startLeft = rect.left;
                startTop  = rect.top;
                startX = clientX;
                startY = clientY;
                prevUserSelect = document.body.style.userSelect;
                document.body.style.userSelect = 'none';
                preventDefault && preventDefault();
            };

            const onMove = (clientX, clientY) => {
                if (!dragging) return;
                let newLeft = startLeft + (clientX - startX);
                let newTop  = startTop  + (clientY - startY);

                const pad = 8;
                const maxLeft = window.innerWidth  - sticker.offsetWidth  - pad;
                const maxTop  = window.innerHeight - sticker.offsetHeight - pad;
                newLeft = Math.max(pad, Math.min(maxLeft, newLeft));
                newTop  = Math.max(pad, Math.min(maxTop,  newTop));

                sticker.style.left = `${newLeft}px`;
                sticker.style.top  = `${newTop}px`;
                sticker.dataset.dragged = '1'; // Ïù¥ÌõÑ Ïó¥ Îïå Ïù¥ ÏúÑÏπò Ïú†ÏßÄ
            };

            const onUp = () => {
                if (!dragging) return;
                dragging = false;
                document.body.style.userSelect = prevUserSelect;
            };

            // Mouse
            handle.addEventListener('mousedown', (e) => onDown(e.clientX, e.clientY, () => e.preventDefault()));
            document.addEventListener('mousemove', (e) => onMove(e.clientX, e.clientY));
            document.addEventListener('mouseup', onUp);

            // Touch
            handle.addEventListener('touchstart', (e) => {
                const t = e.touches[0];
                onDown(t.clientX, t.clientY, () => e.preventDefault());
            }, { passive: false });
            document.addEventListener('touchmove', (e) => {
                if (!dragging) return;
                const t = e.touches[0];
                onMove(t.clientX, t.clientY);
            }, { passive: false });
            document.addEventListener('touchend', onUp);
        }

        function openMemoSticker(grid, rect, item, baseUrl) {
            const sticker = ensureMemoSticker();
            const txt = sticker.querySelector('#memoText');
            const btnSave = sticker.querySelector('#memoSaveBtn');
            const btnCancel = sticker.querySelector('#memoCancelBtn');
            const btnClose = sticker.querySelector('#memoCloseBtn');

            sticker.style.display = 'block';

            // ‚òÖ ÏÇ¨Ïö©ÏûêÍ∞Ä ÎìúÎûòÍ∑∏Ìïú Ï†Å ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ ÏúÑÏπòÎ°ú ÏÑ∏ÌåÖ
            if (sticker.dataset.dragged !== '1') {
                const left = Math.min(rect.left, window.innerWidth - sticker.offsetWidth - 16);
                const top  = Math.min(rect.top + rect.height + 8, window.innerHeight - sticker.offsetHeight - 16);
                sticker.style.left = `${Math.max(8, left)}px`;
                sticker.style.top  = `${Math.max(8, top)}px`;
            }

            txt.value = item.Description || '';
            setTimeout(() => txt.focus(), 0);

            const close = () => { sticker.style.display = 'none'; };

            btnCancel.onclick = btnClose.onclick = close;

            const keyHandler = (e) => {
                if (sticker.style.display !== 'block') return;
                if (e.key === 'Escape') close();
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') btnSave.click();
            };
            document.addEventListener('keydown', keyHandler, { once: true });

            btnSave.onclick = () => {
                const newMemo = txt.value;
                const payload = { head_id: item.head_id, division: item.division, description: newMemo };
                const res = AjaxUtil.postSyncData(baseUrl + '/memo/save', payload);
                if (res && res.success === false) {
                    alert(res.message || 'Ï†ÄÏû• Ïã§Ìå®');
                    return;
                }
                item.Description = newMemo;
                grid.collectionView.refresh();
                close();
            };

            const outsideClose = (e) => {
                if (sticker.style.display === 'block' && !sticker.contains(e.target)) {
                    close();
                    document.removeEventListener('mousedown', outsideClose);
                    document.removeEventListener('touchstart', outsideClose);
                }
            };
            document.addEventListener('mousedown', outsideClose);
            document.addEventListener('touchstart', outsideClose);
        }



        let page = null;

        $(document).ready(function (e) {
            page = new DashCustomPage();

            let date_from = CommonUtil.getYYYYMMDD(-7);
            let today = CommonUtil.getYYYYMMDD();
            page.today = today;

            $('#date_from').val(date_from);
            $('#date_to').val(today);


            page.searchMainData();

            $('#btnMainSearch').click(function (e) {
                page.searchMainData();
            });

            $('#choComp').on('keydown', function (e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault(); // form submit Î∞©ÏßÄ
                    page.searchMainData();
                }
            });

        });
    </script>
</th:block>
</html>
