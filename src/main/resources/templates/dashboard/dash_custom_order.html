<html layout:decorate="~{layout_page}">
<head>
    <style>
        #work-table td{
            text-align: left !important;
            width: 100%;
        }

        #work-table td input{
            width: 100%;
        }
        /* Wijmo 선택/호버가 덮어쓰면 우선순위 올리기 */
        #result-grid .wj-cell.diff-new              { background-color:#e6f7ff; }
        #result-grid .wj-cell.diff-modified_both    { background-color:#fff1b8; }
        #result-grid .wj-cell.diff-modified_bom     { background-color:#ffd666; }
        #result-grid .wj-cell.diff-modified_part    { background-color:#ffccc7; }
        #result-grid .wj-cell.diff-deleted          { background-color:#f0f0f0; }
        #result-grid .wj-cell.diff-unchanged        { background-color:#ffffff; }
        #result-grid .wj-cell.diff-new_parent       { background-color:#d9f7be; }
        #result-grid .wj-cell.diff-deleted_parent   { background-color:#f0f0f0; }

        /* 선택/호버 상태에서도 유지 */
        #result-grid .wj-state-selected.wj-cell[class*="diff-"] { background-color: inherit !important; }
        #result-grid .wj-state-hover.wj-cell[class*="diff-"]    { background-color: inherit !important; }

    </style>
</head>

<th:block layout:fragment="content">
    <div class="layout-contents">
        <div style="display: flex; gap: 5px;">
            <section class="section" style="flex: 2.5;">
                <div class="section-top">
                    <div class="search-wrap">
                        <dl>
                            <dt>
                                생산일<span class="eq">*</span>
                            </dt>
                            <dd>
                                <ul class="date-box">
                                    <li>
                                        <input type="date" id="date_from" name="date_from">
                                        <label for="date_from" class="hide">시작일</label>
                                    </li>
                                    <li>
                                        <input type="date" id="date_to" name="date_to">
                                        <label for="date_to" class="hide">종료일</label>
                                    </li>
                                </ul>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="choComp">
                                    거래처<span class="eq"></span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <input id="choComp" name="choComp" style="width: 160px;"/>
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>&nbsp;</dt>
                            <dd>
                                <li>
                                    <a class="btn btn-search" title="검색" id="btnMainSearch">
                                        <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                        <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                        검색
                                    </a>
                                </li>
                            </dd>
                        </dl>
                    </div>
                </div>
                <div class="container-fluid" style="height: 35vh;">
                    <div id="prod-result-grid"></div>
                </div>
                <div class="container-fluid" style="margin-top: 5px; height: 10vh;">
                    <div id="result-grid"></div>
                </div>
            </section>

            <div class="tab-wrap" style="flex: 1; min-width: 0;">

                <ul class="tab-links">
                    <li><a href="#tabHistory" name="tabHistory">이력</a></li>
                    <li><a href="#tabCompany" name="tabCompany">거래처</a></li>

                </ul>
                <div>
                    <section class="tab-item" id="tabHistory" style="border-top-left-radius: 0;">
                        <div class="grid_box">
                            <div class="container-fluid">
                                <div id="history-grid"></div>
                            </div>
                        </div>

                    </section>
                    <section class="tab-item" id="tabCompany" style="border-top-left-radius: 0;">
                        <div class="section-top">

                            <div class="table-wrap">
                                <form id="companyForm">
                                    <input type="hidden" id="id" name="id"/>
                                    <table id="work-table">
                                        <caption>거래처 테이블</caption>
                                        <colgroup>
                                            <col style="width: 40%;">
                                            <col style="width: 60%;">
                                        </colgroup>
                                        <tbody>
                                        <tr>
                                            <th><label for="name">회사명</label></th>
                                            <td><input type="text" id="name" name="name" readonly/></td>
                                        </tr>
                                        <tr>
                                            <th><label for="business_number">사업자 번호</label></th>
                                            <td><input type="text" id="business_number" name="business_number" readonly/></td>
                                        </tr>
                                        <tr>
                                            <th><label for="ceo_name">대표자명</label></th>
                                            <td><input type="text" id="ceo_name" name="ceo_name" readonly/></td>
                                        </tr>
                                        <tr>
                                            <th><label for="address">사업장 주소</label></th>
                                            <td>
                                                <input id="address" name="address" readonly />
                                            </td>
                                        </tr>
                                        <tr>
                                            <th><label for="business_type">업태</label></th>
                                            <td ><input type="text" id="business_type" name="business_type" readonly/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th><label for="business_item">업종</label></th>
                                            <td>
                                                <input type="text" id="business_item" name="business_item" readonly/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th><label for="tel_number">연락처</label></th>
                                            <td >
                                                <input type="text" id="tel_number" name="tel_number" readonly/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th><label for="email">이메일</label></th>
                                            <td><input type="text" id="email" name="email" readonly/></td>
                                        </tr>
                                        <tr>
                                            <th><label for="fax_number">팩스</label></th>
                                            <td><input type="text" id="fax_number" name="fax_number" readonly /></td>
                                        </tr>
                                        <tr>
                                            <th><label for="description">설명</label></th>
                                            <td><textarea id="description" name="description" readonly></textarea></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </form>
                            </div>
                        </div>
                    </section>
                </div>

            </div>
        </div>
    </div>

</th:block>


<th:block layout:fragment="scripts">
    <script type="text/javascript">

        class DashCustomPage {
            constructor() {
                this.grid = null;
                this.resultGrid = null;
                this.historyGrid = null;
                this.baseUrl = '/api/dashboard';
                this.init();
            }

            init() {
                let _this = this;

                // 구분 표기 매핑(백엔드 원본 코드를 모두 포용하도록 느슨하게)
                const DIVISION_LABEL_MAP = {
                    // 수주
                    'suju': '수주',
                    // 매출
                    'sales': '매출', 'sale': '매출', 'shipment': '매출', '출고': '매출',
                    // 매입(=매입·발주)
                    'purchase': '매입', 'buy': '매입', 'balju': '매입', '발주': '매입',
                    // 수금
                    'receipt': '수금', 'receive': '수금', 'deposit': '수금', '입금': '수금',
                    // 지급
                    'payment': '지급', 'payout': '지급', 'withdraw': '지급', '출금': '지급',
                    // 대체거래(수입·지출)
                    'transfer': '대체거래(수입·지출)', 'adjust': '대체거래(수입·지출)', 'etc': '대체거래(수입·지출)', 'etc_inout': '대체거래(수입·지출)'
                };

                // 색상(선택) — 기존 톤 유지 + 카테고리별 강조
                const DIVISION_COLOR_MAP = {
                    '수주': '#1d4ed8',                // 파랑
                    '매출': '#10b981',                // 초록
                    '매입': '#dc2626',                // 빨강
                    '수금': '#7c3aed',                // 보라
                    '지급': '#f59e0b',                // 주황
                    '대체거래(수입·지출)': '#6b7280'  // 회색
                };

                // 원본 division(문자열) → 라벨로 변환(소문자/트림 후 매핑)
                function toDivisionLabel(raw) {
                    const key = String(raw || '').trim().toLowerCase();
                    return DIVISION_LABEL_MAP[key] || raw || '';
                }


                this.grid = new wijmo.grid.FlexGrid('#prod-result-grid', {
                    autoGenerateColumns: false,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    formatItem: (s, e) => {
                        // 헤더 정렬/색 지정(기존 유지)
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                            const binding = s.columns[e.col].binding;
                            if (binding === 'Description') {
                                e.cell.style.color = '#5567ff';
                            }
                            return;
                        }

                        // 본문 셀
                        if (e.panel.cellType === wijmo.grid.CellType.Cell) {
                            const col = s.columns[e.col];
                            const item = s.rows[e.row]?.dataItem;

                            // 재활용 셀 초기화
                            e.cell.style.color = '';
                            e.cell.style.fontWeight = '';

                            if (col && col.binding === 'division' && item) {
                                // 새 라벨 매핑
                                const label = toDivisionLabel(item.division);
                                e.cell.textContent = label;

                                // 색상/굵기 (선택)
                                const color = DIVISION_COLOR_MAP[label];
                                if (color) e.cell.style.color = color;
                                e.cell.style.fontWeight = '600';
                                return;
                            }
                        }
                    },
                    isReadOnly: true,
                    showMarquee: true,
                    columns: [
                        {binding: 'head_id', visible: false},
                        {binding: 'division', header: '구분', width: 70, align: 'center'},
                        {binding: 'JumunDate', header: '작성일자', width: 100, align: 'center'},
                        {binding: 'state_name', header: '상태', width: 80, align: 'center'},
                        // {binding: 'JumunNumber', header: '번호', width: 120, align: 'center'},
                        {binding: 'company_name', header: '거래처명', width: 120, align: 'center'},
                        {binding: 'BusinessNumber', header: '사업자번호', width: 120, align: 'center'},
                        {binding: 'product_name', header: '제품명', width: 200, align: 'left'},
                        {binding: 'price', header: '공급가액', width: 100, align: 'right'},
                        {binding: 'vat', header: '세액', width: 80, align: 'right'},
                        {binding: 'total_price', header: '합계', width: 100, align: 'right'},
                        {binding: 'Description', header: '메모', width: '*', align: 'left'},
                    ],
                    itemsSource: new wijmo.collections.CollectionView([]),
                });
                new FlexGridContextMenu(this.grid);
                this.grid.downloadFileName = '진행 내역';

                // 더블클릭: Description 셀에서는 스티커, 그 외에는 기존 동작
                this.grid.hostElement.addEventListener('dblclick', (e) => {
                    const grid = this.grid;                           // 안전하게 참조
                    const ht = grid.hitTest(e);

                    if (ht.cellType === wijmo.grid.CellType.Cell) {   // ← CellType 참조 수정
                        const col  = grid.columns[ht.col];
                        const item = grid.rows[ht.row]?.dataItem;

                        if (col && col.binding === 'Description' && item) {
                            const rect = grid.getCellBoundingRect(ht.row, ht.col, true);
                            openMemoSticker(grid, rect, item, this.baseUrl); // 스티커 오픈
                            return; // 메모 셀일 땐 기본 동작 막기
                        }
                    }

                    // (기존 동작) Description 외 더블클릭 시
                    const items = grid.selectedItems;
                    if (!items || items.length === 0) return;
                    this.getDetail();
                    this.getHistory();
                    this.getCompany();
                });


                this.resultGrid = new wijmo.grid.FlexGrid('#result-grid', {
                    autoGenerateColumns: false,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.All,
                    showMarquee: true,
                    childItemsPath: 'children',   // ★ 트리 핵심
                    formatItem: (s, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.RowHeader) {
                            e.cell.textContent = (e.row + 1).toString();
                            return;
                        }
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                            return;
                        }
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnFooter) {
                            const col = s.columns[e.col];
                            if (col.binding === 'product_name') {
                                e.cell.textContent = '합계';
                                e.cell.style.textAlign = 'center';
                            }
                            return;
                        }

                        // 셀 커스터마이징 (날짜 포맷/인덴트/부모 숫자 표시용)
                        if (e.panel.cellType !== wijmo.grid.CellType.Cell) return;

                        const col = s.columns[e.col];
                        const row = s.rows[e.row];
                        const item = row?.dataItem;
                        if (!item) return;

                        // YYYYMMDD -> YYYY-MM-DD (서버가 이미 포맷했으면 자동 skip)
                        if (col.binding === 'JumunDate') {
                            const raw = (e.cell.textContent || '').trim();
                            if (/^\d{8}$/.test(raw)) {
                                e.cell.textContent = `${raw.slice(0,4)}-${raw.slice(4,6)}-${raw.slice(6,8)}`;
                            }
                        }

                        // 트리 인덴트 보정 (제품명 열만)
                        if (col.binding === 'product_name') {
                            const depth = row.level || 0;
                            const btn = e.cell.querySelector('button.wj-elem-collapse');
                            if (btn) { btn.style.height = '14px'; btn.style.padding = '0'; btn.style.lineHeight = '14px'; }
                            const textNode = [...e.cell.childNodes].find(n => n.nodeType === Node.TEXT_NODE && n.textContent.trim() !== '');
                            if (textNode) {
                                const span = document.createElement('span');
                                span.textContent = textNode.textContent.trim();
                                span.style.marginLeft = `${depth * 15}px`;
                                span.style.display = 'inline-block';
                                e.cell.replaceChild(span, textNode);
                            }
                        }

                        // ★★★ 여기부터 핵심: 자식 행은 'standard','quantity'만 표시
                        if (item.__type === 'child') {
                            const visibleForChild = new Set(['standard', 'quantity']); // 화이트리스트
                            if (!visibleForChild.has(col.binding)) {
                                e.cell.textContent = '';               // 나머지 전부 숨김
                                e.cell.classList.add('child-dim');     // (선택) 흐리게 보이도록
                            } else {
                                // 숫자 포맷이 필요하면 여기에서 포맷(예: 소수 1자리)
                                if (col.binding === 'quantity') {
                                    const n = Number(e.cell.textContent.replace(/,/g,''));
                                    if (isFinite(n)) e.cell.textContent = (Math.round(n * 10) / 10).toString();
                                }
                            }
                        }

                        // DIFF 색상 (있으면)
                        if (item.DIFF_TYPE) {
                            e.cell.classList.add(`diff-${String(item.DIFF_TYPE).toLowerCase()}`);
                        }

                    },
                    columns: [
                        {binding: 'id', visible:false},
                        {binding: 'JumunDate', header: '일자', width: 120, align: 'center', isReadOnly: true},
                        {binding: 'state_name', header: '상태', width: 80, align: 'center'},
                        {binding: 'product_name', header: '제품명', width: 200, align: 'left', isReadOnly: true},
                        {binding: 'standard', header: '규격', width: 80, align: 'center', isReadOnly: true},
                        {binding: 'quantity', header: '수량', width: 80, align: 'right', isReadOnly: true, aggregate: wijmo.Aggregate.Sum},
                        {binding: 'unit_price', header: '단가', width: 80, align: 'right', isReadOnly: true},
                        {binding: 'supply_amount', header: '공급가액', width: 100, align: 'right', isReadOnly: true, aggregate: wijmo.Aggregate.Sum},
                        {binding: 'vat_amount', header: '세액', width: 100, align: 'right', isReadOnly: true, aggregate: wijmo.Aggregate.Sum},
                        {binding: 'total_amount', header: '합계', width: 100, align: 'right', isReadOnly: true, aggregate: wijmo.Aggregate.Sum},
                        {binding: 'description', header: '비고', width: '*', align: 'left', isReadOnly: true},
                    ],
                    itemsSource: new wijmo.collections.CollectionView([]),
                });

                this.resultGrid.columnFooters.rows.push(new wijmo.grid.GroupRow());
                new FlexGridContextMenu(this.resultGrid);
                this.resultGrid.downloadFileName = '상세 내역';

                this.historyGrid = new wijmo.grid.FlexGrid('#history-grid', {
                    autoGenerateColumns: false,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    showMarquee: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        {binding: 'product_name', header: '제품명', width: 170, align: 'left', isReadOnly: true},
                        {binding: 'standard', header: '규격', width: 70, align: 'center', isReadOnly: true},
                        {binding: 'state_name', header: '상태', width: 70, align: 'center', isReadOnly: true},
                        {binding: 'event_time', header: '생성시간', width: 170, align: 'center', isReadOnly: true},
                    ],
                    itemsSource: new wijmo.collections.CollectionView([]),
                });

                // Context Menu 추가
                new FlexGridContextMenu(this.historyGrid);
                this.historyGrid.downloadFileName = '차수별 생산 내역';

            }

            getDetail () {
                const it = this.grid.selectedItems && this.grid.selectedItems[0];
                if (!it) return;

                const data   = { id: it.head_id, division: it.division };
                const result = AjaxUtil.getSyncData(this.baseUrl + '/detail', data);
                if (!result || !result.data) return;

                const isSuju = String(it.division) === '수주';

                // 트리 모드 on/off
                this.resultGrid.childItemsPath = isSuju ? 'children' : null;

                if (isSuju) {
                    // 수주일 때만 트리 변환 + 롤업
                    const tree = toTree(result.data);  // (이미 만들어둔 함수)
                    this.resultGrid.itemsSource = new wijmo.collections.CollectionView(tree);

                    // 필요 시 기본으로 접기
                    this.resultGrid.collapseGroupsToLevel(0);
                } else {
                    // 수주가 아닐 때: 평면 데이터 그대로
                    this.resultGrid.itemsSource = new wijmo.collections.CollectionView(result.data);
                }

                // 선택/스크롤 초기화(선택)
                // this.resultGrid.select(-1, -1);
                // this.resultGrid.scrollPosition = new wijmo.Point(0, 0);
            }

            getHistory () {
                let _this = this;

                const it = _this.grid.selectedItems && _this.grid.selectedItems[0];
                let data = {
                    id: it.head_id,
                    division: it.division,
                };
                // 1) 데이터 로드
                let result = AjaxUtil.getSyncData(this.baseUrl + '/history', data);
                if (result.data) {
                    const rows = result.data.map(r => ({
                        ...r,
                        event_time: new Date(r.event_time) // ISO → Date
                    }));

                    // 2) 그룹/정렬 설정
                    const labelMap = { suju: '수주', job: '생산', shipment: '출고', balju: '발주', input: '입고' };

                    const cv = new wijmo.collections.CollectionView(rows);
                    // event_type으로 그룹 (정렬 키를 접두로 붙여 순서 고정)
                    cv.groupDescriptions.push(new wijmo.collections.PropertyGroupDescription(
                        'event_type',
                        item => {
                            const t = item.event_type;
                            const label = labelMap[t] ?? t;  // '수주' 등
                            return `${label}`;      // 그룹 값(value)이 됨
                        }
                    ));
                    // 그룹 내 시간순 정렬
                    cv.sortDescriptions.push(new wijmo.collections.SortDescription('event_time', true));

                    this.historyGrid.itemsSource = cv;

                    // 3) 컬럼 타입/포맷(선택)
                    const col = this.historyGrid.columns.getColumn('event_time');
                    if (col) {
                        col.dataType = wijmo.DataType.Date;
                        col.format = 'yyyy-MM-dd HH:mm:ss';
                    }

                    // 4) 그룹 헤더 표시 예쁘게 (접두 "1:" 제거 + 건수 표시)
                    this.historyGrid.groupHeaderFormat = '{value} ';
                    this.historyGrid.formatItem = (s, e) => {
                        // 기존 헤더 가운데 정렬 유지
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                        // 그룹 헤더 꾸미기
                        if (e.panel === s.cells) {
                            const row = s.rows[e.row];
                            if (row instanceof wijmo.grid.GroupRow) {
                                const g = row.dataItem; // CollectionViewGroup
                                if (e.col === 0) {
                                    const raw = String(g.name);            // "1:수주" 같은 문자열
                                    const label = raw.replace(/^\d+:/, ''); // "수주"만 추출
                                    e.cell.textContent = `${label} (${g.items.length}건)`;
                                    e.cell.style.fontWeight = '600';
                                } else {
                                    // 그룹 헤더의 나머지 칼럼은 비우기
                                    e.cell.textContent = '';
                                }
                            }
                        }
                    };
                }
            };


            getCompany () {
                let _this = this;

                const it = _this.grid.selectedItems && _this.grid.selectedItems[0];
                let data = {
                    company_id: it.company_id
                };
                let result = AjaxUtil.getSyncData('/api/definition/company/detail', data);
                if (result.data) {
                    const d = { ...result.data };
                    d.business_number = formatBizNo(d.business_number);
                    d.tel_number      = formatPhone(d.tel_number);
                    d.fax_number      = formatPhone(d.fax_number);
                    FormUtil.BindDataForm(d, $('#companyForm'));
                }

            };

            // 작업목록 조회
            searchMainData() {
                let _this = this;

                let param = {
                    'date_from': $('#date_from').val(),
                    'date_to': $('#date_to').val(),
                    'choComp': $('#choComp').val(),
                };

                let result = AjaxUtil.getSyncData(this.baseUrl + '/read', param);
                if (result.data && _this.grid.itemsSource) {
                    const rows = result.data.map(r => ({
                        ...r,
                        BusinessNumber: formatBizNo(r.BusinessNumber) // ← 각 항목에 하이픈 적용
                    }));
                    _this.grid.itemsSource = new wijmo.collections.CollectionView(rows);
                }
            }

        }

        function toTree(rows) {
            const byId = new Map();

            // 1) 부모 생성 (동일)
            for (const r of rows || []) {
                const id = r.id;
                if (!byId.has(id)) {
                    byId.set(id, {
                        __type: 'parent',
                        id: r.id,
                        head_id: r.head_id,
                        Material_id: r.Material_id,
                        product_code: r.product_code,
                        JumunDate: r.JumunDate,
                        product_name: r.product_name,
                        unit: r.unit,
                        standard: r.header_standard_label ?? r.header_standard ?? r.standard ?? '',
                        // 합계 중복 방지 기본값
                        quantity: null, unit_price: null, supply_amount: null, vat_amount: null, total_amount: null,
                        // 화면 표시용
                        _display_quantity: r.header_quantity ?? r.quantity ?? null,
                        _display_unit_price: r.header_unit_price ?? r.unit_price ?? null,
                        _display_supply_amount: r.header_supply_amount ?? r.supply_amount ?? null,
                        _display_vat_amount: r.header_vat_amount ?? r.vat_amount ?? null,
                        _display_total_amount: r.header_total_amount ?? r.total_amount ?? null,

                        state: r.state, state_name: r.state_name, description: r.description, DIFF_TYPE: r.DIFF_TYPE,
                        __hasNonFallbackChild: false, __sawFallback: false,
                        children: []
                    });
                }
            }

            // 2) 자식 붙이기 (fallback은 생성하지 않음)
            for (const r of rows || []) {
                const p = byId.get(r.id);
                const isChild = (r.row_type === 'child') || (r.detail_id != null) || (r.is_fallback === true);
                if (!isChild) continue;

                if (r.is_fallback === true) { p.__sawFallback = true; continue; }

                p.__hasNonFallbackChild = true;
                p.children.push({
                    __type: 'child',
                    id: r.id, detail_id: r.detail_id ?? null, JumunDate: r.JumunDate, product_name: r.product_name,
                    standard: r.standard, quantity: r.quantity, unit_price: r.unit_price,
                    supply_amount: r.supply_amount, vat_amount: r.vat_amount, total_amount: r.total_amount,
                    description: r.description, state: r.state, state_name: r.state_name, DIFF_TYPE: r.DIFF_TYPE
                });
            }

            // 3) 후처리: 롤업 + fallback 처리
            for (const p of byId.values()) {
                if (p.children.length > 0) {
                    const sum = k => p.children.reduce((a, c) => a + (Number(c[k]) || 0), 0);

                    const hasChildAmounts = p.children.some(c =>
                        c.supply_amount != null || c.vat_amount != null || c.total_amount != null
                    );

                    if (hasChildAmounts) {
                        // (배분 모드일 때만) 롤업 + 가중평균 단가
                        p.quantity      = sum('quantity');
                        p.supply_amount = sum('supply_amount');
                        p.vat_amount    = sum('vat_amount');
                        p.total_amount  = sum('total_amount');
                        p.unit_price    = p.quantity ? Math.round(p.total_amount / p.quantity) : null;
                    } else {
                        // ★ 이번 모드: 헤더 원본 단가/금액 사용
                        const n = v => (v == null ? null : Number(v));
                        const childQtySum = sum('quantity');

                        p.quantity      = n(p._display_quantity) ?? childQtySum ?? 0;
                        p.unit_price    = n(p._display_unit_price);        // ★ 재계산 금지
                        p.supply_amount = n(p._display_supply_amount) ?? 0;
                        p.vat_amount    = n(p._display_vat_amount) ?? 0;
                        p.total_amount  = n(p._display_total_amount) ?? 0;

                        // 표시값 동기화
                        p._display_unit_price    = p.unit_price;
                        p._display_quantity      = p.quantity;
                        p._display_supply_amount = p.supply_amount;
                        p._display_vat_amount    = p.vat_amount;
                        p._display_total_amount  = p.total_amount;
                    }
                }
            }

            return Array.from(byId.values());
        }

        // 공통: 숫자만 남기기
        const digits = v => String(v || '').replace(/\D/g, '');

        // 사업자번호: 10자리 → 000-00-00000
        const formatBizNo = v => {
            const d = digits(v);
            return d.length === 10 ? `${d.slice(0,3)}-${d.slice(3,5)}-${d.slice(5)}` : v || '';
        };

        // 전화/팩스
        const formatPhone = v => {
            const d = digits(v);
            if (!d) return '';

            if (d.startsWith('02')) { // 서울
                return d.length >= 10
                    ? `02-${d.slice(2, d.length-4)}-${d.slice(-4)}`
                    : `02-${d.slice(2,5)}-${d.slice(5)}`;
            }
            if (/^01[016789]/.test(d)) { // 휴대폰
                return d.length === 11
                    ? `${d.slice(0,3)}-${d.slice(3,7)}-${d.slice(7)}`
                    : `${d.slice(0,3)}-${d.slice(3,6)}-${d.slice(6)}`;
            }
            if (d.startsWith('070')) {
                return `070-${d.slice(3, d.length-4)}-${d.slice(-4)}`;
            }
            if (d.startsWith('050')) {
                return `${d.slice(0,4)}-${d.slice(4,8)}-${d.slice(8)}`;
            }
            // 일반 지역번호(3자리 가정)
            return d.length >= 9
                ? `${d.slice(0,3)}-${d.slice(3, d.length-4)}-${d.slice(-4)}`
                : v || '';
        };

        function ensureMemoSticker() {
            let sticker = document.getElementById('memo-sticker');
            if (sticker) return sticker;

            sticker = document.createElement('div');
            sticker.id = 'memo-sticker';
            sticker.style.cssText = `
    position:absolute; display:none; z-index:10000;
    width:320px; background:#d1d5db; border:1px solid #d1d5db;
    box-shadow:0 8px 20px rgba(0,0,0,.15); border-radius:10px; padding:10px;
  `;
            sticker.innerHTML = `
    <div id="memoHeader" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;cursor:move;user-select:none;">
      <strong>메모</strong>
      <button type="button" id="memoCloseBtn" style="border:none;background:transparent;font-size:18px;cursor:pointer;">✕</button>
    </div>
    <textarea id="memoText" rows="6" style="width:100%;height:180px;box-sizing:border-box;resize:vertical;"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button type="button" id="memoSaveBtn"   style="padding:6px 10px;border-radius:6px;border:1px solid #d1d5db;cursor:pointer;">저장</button>
      <button type="button" id="memoCancelBtn" style="padding:6px 10px;border-radius:6px;border:1px solid #d1d5db;background:#fff;cursor:pointer;">취소</button>
    </div>
  `;
            document.body.appendChild(sticker);

            // ★ 드래그 가능하게
            makeStickerDraggable(sticker, sticker.querySelector('#memoHeader'));
            return sticker;
        }

        function makeStickerDraggable(sticker, handle) {
            let dragging = false, startX = 0, startY = 0, startLeft = 0, startTop = 0;
            let prevUserSelect = '';

            const onDown = (clientX, clientY, preventDefault) => {
                dragging = true;
                const rect = sticker.getBoundingClientRect();
                startLeft = rect.left;
                startTop  = rect.top;
                startX = clientX;
                startY = clientY;
                prevUserSelect = document.body.style.userSelect;
                document.body.style.userSelect = 'none';
                preventDefault && preventDefault();
            };

            const onMove = (clientX, clientY) => {
                if (!dragging) return;
                let newLeft = startLeft + (clientX - startX);
                let newTop  = startTop  + (clientY - startY);

                const pad = 8;
                const maxLeft = window.innerWidth  - sticker.offsetWidth  - pad;
                const maxTop  = window.innerHeight - sticker.offsetHeight - pad;
                newLeft = Math.max(pad, Math.min(maxLeft, newLeft));
                newTop  = Math.max(pad, Math.min(maxTop,  newTop));

                sticker.style.left = `${newLeft}px`;
                sticker.style.top  = `${newTop}px`;
                sticker.dataset.dragged = '1'; // 이후 열 때 이 위치 유지
            };

            const onUp = () => {
                if (!dragging) return;
                dragging = false;
                document.body.style.userSelect = prevUserSelect;
            };

            // Mouse
            handle.addEventListener('mousedown', (e) => onDown(e.clientX, e.clientY, () => e.preventDefault()));
            document.addEventListener('mousemove', (e) => onMove(e.clientX, e.clientY));
            document.addEventListener('mouseup', onUp);

            // Touch
            handle.addEventListener('touchstart', (e) => {
                const t = e.touches[0];
                onDown(t.clientX, t.clientY, () => e.preventDefault());
            }, { passive: false });
            document.addEventListener('touchmove', (e) => {
                if (!dragging) return;
                const t = e.touches[0];
                onMove(t.clientX, t.clientY);
            }, { passive: false });
            document.addEventListener('touchend', onUp);
        }

        function openMemoSticker(grid, rect, item, baseUrl) {
            const sticker = ensureMemoSticker();
            const txt = sticker.querySelector('#memoText');
            const btnSave = sticker.querySelector('#memoSaveBtn');
            const btnCancel = sticker.querySelector('#memoCancelBtn');
            const btnClose = sticker.querySelector('#memoCloseBtn');

            sticker.style.display = 'block';

            // ★ 사용자가 드래그한 적 없으면 기본 위치로 세팅
            if (sticker.dataset.dragged !== '1') {
                const left = Math.min(rect.left, window.innerWidth - sticker.offsetWidth - 16);
                const top  = Math.min(rect.top + rect.height + 8, window.innerHeight - sticker.offsetHeight - 16);
                sticker.style.left = `${Math.max(8, left)}px`;
                sticker.style.top  = `${Math.max(8, top)}px`;
            }

            txt.value = item.Description || '';
            setTimeout(() => txt.focus(), 0);

            const close = () => { sticker.style.display = 'none'; };

            btnCancel.onclick = btnClose.onclick = close;

            const keyHandler = (e) => {
                if (sticker.style.display !== 'block') return;
                if (e.key === 'Escape') close();
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') btnSave.click();
            };
            document.addEventListener('keydown', keyHandler, { once: true });

            btnSave.onclick = () => {
                const newMemo = txt.value;
                const payload = { head_id: item.head_id, division: item.division, description: newMemo };
                const res = AjaxUtil.postSyncData(baseUrl + '/memo/save', payload);
                if (res && res.success === false) {
                    alert(res.message || '저장 실패');
                    return;
                }
                item.Description = newMemo;
                grid.collectionView.refresh();
                close();
            };

            const outsideClose = (e) => {
                if (sticker.style.display === 'block' && !sticker.contains(e.target)) {
                    close();
                    document.removeEventListener('mousedown', outsideClose);
                    document.removeEventListener('touchstart', outsideClose);
                }
            };
            document.addEventListener('mousedown', outsideClose);
            document.addEventListener('touchstart', outsideClose);
        }



        let page = null;

        $(document).ready(function (e) {
            page = new DashCustomPage();

            let date_from = CommonUtil.getYYYYMMDD(-7);
            let today = CommonUtil.getYYYYMMDD();
            page.today = today;

            $('#date_from').val(date_from);
            $('#date_to').val(today);


            page.searchMainData();

            $('#btnMainSearch').click(function (e) {
                page.searchMainData();
            });

            $('#choComp').on('keydown', function (e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault(); // form submit 방지
                    page.searchMainData();
                }
            });

        });
    </script>
</th:block>
</html>
