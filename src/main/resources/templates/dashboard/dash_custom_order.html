<html layout:decorate="~{layout_page}">
<head>
    <style>
        #work-table td{
            text-align: left !important;
            width: 100%;
        }

        #work-table td input{
            width: 100%;
        }

        #result-grid .wj-row.row-depth-0 .wj-cell { background-color:#f7f7f7; } /* ë¶€ëª¨ */
        #result-grid .wj-row.row-depth-1 .wj-cell { background-color:#f7f7f7; } /* ìì‹ 1 */
        #result-grid .wj-row.row-depth-2 .wj-cell { background-color:#fffbe6; } /* ìì‹ 2+ */

        #result-grid .wj-row.row-type-parent .wj-cell { font-weight:600; }

        /* ì„ íƒ/í˜¸ë²„ ì‹œ ì›ë˜ ë°°ê²½ ìœ ì§€ */
        #result-grid .wj-state-selected.wj-cell { background-color: inherit !important; }
        #result-grid .wj-state-hover.wj-cell[class*="diff-"]   { background-color: inherit !important; }

        /* diff-* ìƒíƒœìƒ‰ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ */
        #result-grid .wj-cell.diff-new              { background-color:#e6f7ff; }
        #result-grid .wj-cell.diff-modified_both    { background-color:#fff1b8; }
        #result-grid .wj-cell.diff-modified_bom     { background-color:#ffd666; }
        #result-grid .wj-cell.diff-modified_part    { background-color:#ffccc7; }
        #result-grid .wj-cell.diff-deleted          { background-color:#f0f0f0; }
        #result-grid .wj-cell.diff-unchanged        { background-color:#ffffff; }
        #result-grid .wj-cell.diff-new_parent       { background-color:#d9f7be; }
        #result-grid .wj-cell.diff-deleted_parent   { background-color:#f0f0f0; }
        #result-grid .wj-state-selected.wj-cell[class*="diff-"],
        #result-grid .wj-state-hover   .wj-cell[class*="diff-"] { background-color: inherit !important; }
        /* ê·¸ë£¹/í‘¸í„°, ì§€ë¸Œë¼ ë°°ê²½ ì œê±° â†’ ìš°ë¦¬ê°€ ì§€ì •í•œ ë°°ê²½ì´ ë³´ì´ë„ë¡ */
        #result-grid .wj-cell.wj-group { background: inherit !important; }
        #result-grid .wj-cell.wj-alt   { background: inherit !important; }
        /* ì§€ë¸Œë¼ ìì²´ë¥¼ ë„ê³  ì‹¶ìœ¼ë©´ JSë¡œ: this.resultGrid.alternatingRowStep = 0; */

    </style>
</head>

<th:block layout:fragment="content">
    <div class="layout-contents">
        <div style="display: flex; gap: 5px;">
            <section class="section" style="flex: 2.5;">
                <div class="section-top">
                    <div class="search-wrap">
                        <dl>
                            <dt>
                                ì¡°íšŒì¼ì<span class="eq">*</span>
                            </dt>
                            <dd>
                                <ul class="date-box">
                                    <li>
                                        <input type="date" id="date_from" name="date_from">
                                        <label for="date_from" class="hide">ì‹œì‘ì¼</label>
                                    </li>
                                    ~
                                    <li>
                                        <input type="date" id="date_to" name="date_to">
                                        <label for="date_to" class="hide">ì¢…ë£Œì¼</label>
                                    </li>
                                </ul>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="choComp">
                                    ê±°ë˜ì²˜<span class="eq"></span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <input id="choComp" name="choComp" style="width: 160px;"/>
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>&nbsp;</dt>
                            <dd>
                                <li>
                                    <a class="btn btn-search" title="ê²€ìƒ‰" id="btnMainSearch">
                                        <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                        <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                        ê²€ìƒ‰
                                    </a>
                                </li>
                            </dd>
                        </dl>
                    </div>
                </div>
                <div class="container-fluid" style="height: 35vh;">
                    <div id="prod-result-grid"></div>
                </div>
                <div class="container-fluid" style="margin-top: 5px; height: 10vh;">
                    <div id="result-grid"></div>
                </div>
                <div id="deposit-container" style="display: none; margin-top: 5px;">
                    <div style="width: 20%; display: grid;">
                        <tbody>
                        <th>ë¯¸ìˆ˜ì´ì•¡</th>
                        <td>
                            <input type="text" id="totalDeposit" style="width: 80%; text-align: right;" readonly>
                        </td>
                        <th>ë¯¸ì§€ì´ì•¡</th>
                        <td>
                            <input type="text" id="totalUnDeposit" style="width: 80%; text-align: right;" readonly>
                        </td>
                        <th>ìƒê³„ì”ì•¡</th>
                        <td>
                            <input type="text" id="totalRowDeposit" style="width: 80%; text-align: right;" readonly>
                        </td>
                        </tbody>
                    </div>
                    <div class="container-fluid" style="margin-top: 5px; width: 75%">
                        <div id="deposit_grid"></div>
                    </div>
                </div>
                <div id="wdraw-container" style="display: none; margin-top: 5px;">
                    <div style="width: 20%; display: grid;">
                        <tbody>
                        <th>ë¯¸ìˆ˜ì´ì•¡</th>
                        <td>
                            <input type="text" id="totalDeposit2" style="width: 80%; text-align: right;" readonly>
                        </td>
                        <th>ë¯¸ì§€ì´ì•¡</th>
                        <td>
                            <input type="text" id="totalUnDeposit2" style="width: 80%; text-align: right;" readonly>
                        </td>
                        <th>ìƒê³„ì”ì•¡</th>
                        <td>
                            <input type="text" id="totalRowDeposit2" style="width: 80%; text-align: right;" readonly>
                        </td>
                        </tbody>
                    </div>
                    <div class="container-fluid" style="margin-top: 5px; width: 75%">
                        <div id="wdraw_grid"></div>
                    </div>
                </div>
            </section>

            <div class="tab-wrap" style="flex: 1; min-width: 0;">

                <ul class="tab-links">
                    <li><a href="#tabCompany" name="tabCompany">ê±°ë˜ì²˜</a></li>
                    <li><a href="#tabHistory" name="tabHistory">ì´ë ¥</a></li>
                </ul>
                <div>
                    <section class="tab-item" id="tabCompany" style="border-top-left-radius: 0;">
                        <div class="section-top">

                            <div class="table-wrap">
                                <form id="companyForm">
                                    <input type="hidden" id="id" name="id"/>
                                    <table id="work-table">
                                        <caption>ê±°ë˜ì²˜ í…Œì´ë¸”</caption>
                                        <colgroup>
                                            <col style="width: 40%;">
                                            <col style="width: 60%;">
                                        </colgroup>
                                        <tbody>
                                        <tr>
                                            <th><label for="name">íšŒì‚¬ëª…</label></th>
                                            <td><input type="text" id="name" name="name" readonly/></td>
                                        </tr>
                                        <tr>
                                            <th><label for="business_number">ì‚¬ì—…ì ë²ˆí˜¸</label></th>
                                            <td><input type="text" id="business_number" name="business_number" readonly/></td>
                                        </tr>
                                        <tr>
                                            <th><label for="ceo_name">ëŒ€í‘œìëª…</label></th>
                                            <td><input type="text" id="ceo_name" name="ceo_name" readonly/></td>
                                        </tr>
                                        <tr>
                                            <th><label for="address">ì‚¬ì—…ì¥ ì£¼ì†Œ</label></th>
                                            <td>
                                                <textarea id="address" name="address" readonly ></textarea>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th><label for="our_manager">ìì‚¬ë‹´ë‹¹ì</label></th>
                                            <td ><input type="text" id="our_manager" name="our_manager" readonly/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th><label for="business_type">ì—…íƒœ</label></th>
                                            <td ><input type="text" id="business_type" name="business_type" readonly/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th><label for="business_item">ì—…ì¢…</label></th>
                                            <td>
                                                <input type="text" id="business_item" name="business_item" readonly/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th><label for="tel_number">ì—°ë½ì²˜</label></th>
                                            <td >
                                                <input type="text" id="tel_number" name="tel_number" readonly/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th><label for="email">ì´ë©”ì¼</label></th>
                                            <td><input type="text" id="email" name="email" readonly/></td>
                                        </tr>
                                        <tr>
                                            <th><label for="fax_number">íŒ©ìŠ¤</label></th>
                                            <td><input type="text" id="fax_number" name="fax_number" readonly /></td>
                                        </tr>
                                        <tr>
                                            <th><label for="description">ë©”ëª¨</label></th>
                                            <td><textarea id="description" name="description" readonly></textarea></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </form>
                            </div>
                        </div>
                    </section>
                    <section class="tab-item" id="tabHistory" style="border-top-left-radius: 0;">
                        <div class="grid_box">
                            <div class="container-fluid">
                                <div id="history-grid"></div>
                            </div>
                        </div>
                    </section>
                </div>

            </div>
        </div>
    </div>

</th:block>


<th:block layout:fragment="scripts">
    <script type="text/javascript">

        class DashCustomPage {
            constructor() {
                this.grid = null;
                this.resultGrid = null;
                this.depositGrid = null;
                this.wdrawGrid = null;
                this.historyGrid = null;
                this.baseUrl = '/api/dashboard';
                this.init();
            }

            init() {
                let _this = this;

                // êµ¬ë¶„ í‘œê¸° ë§¤í•‘(ë°±ì—”ë“œ ì›ë³¸ ì½”ë“œë¥¼ ëª¨ë‘ í¬ìš©í•˜ë„ë¡ ëŠìŠ¨í•˜ê²Œ)
                const DIVISION_LABEL_MAP = {
                    // ìˆ˜ì£¼
                    'suju': 'ìˆ˜ì£¼',
                    // ë§¤ì¶œ
                    'sales': 'ë§¤ì¶œ', 'sale': 'ë§¤ì¶œ',
                    // ë§¤ì…(=ë§¤ì…Â·ë°œì£¼)
                    'purchase': 'ë§¤ì…', 'balju': 'ë§¤ì…', 'ë°œì£¼': 'ë§¤ì…',
                    // ìˆ˜ê¸ˆ
                   'receive': 'ì…ê¸ˆ',
                    // ì§€ê¸‰
                    'payment': 'ì¶œê¸ˆ',
                };

                // ìƒ‰ìƒ(ì„ íƒ) â€” ê¸°ì¡´ í†¤ ìœ ì§€ + ì¹´í…Œê³ ë¦¬ë³„ ê°•ì¡°
                const DIVISION_COLOR_MAP = {
                    'ìˆ˜ì£¼': '#1d4ed8',                // íŒŒë‘
                    'ë§¤ì¶œ': '#10b981',                // ì´ˆë¡
                    'ë§¤ì…': '#dc2626',                // ë¹¨ê°•
                    'ì…ê¸ˆ': '#7c3aed',                // ë³´ë¼
                    'ì¶œê¸ˆ': '#f59e0b',                // ì£¼í™©
                };

                // ì›ë³¸ division(ë¬¸ìì—´) â†’ ë¼ë²¨ë¡œ ë³€í™˜(ì†Œë¬¸ì/íŠ¸ë¦¼ í›„ ë§¤í•‘)
                function toDivisionLabel(raw) {
                    const key = String(raw || '').trim().toLowerCase();
                    return DIVISION_LABEL_MAP[key] || raw || '';
                }

                this.grid = new wijmo.grid.FlexGrid('#prod-result-grid', {
                    autoGenerateColumns: false,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    formatItem: (s, e) => {
                        // í—¤ë” ì •ë ¬/ìƒ‰ ì§€ì •(ê¸°ì¡´ ìœ ì§€)
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                            const binding = s.columns[e.col].binding;
                            if (binding === 'Description') {
                                e.cell.style.color = '#5567ff';
                            }
                            return;
                        }

                        // ë³¸ë¬¸ ì…€
                        if (e.panel.cellType === wijmo.grid.CellType.Cell) {
                            const col = s.columns[e.col];
                            const item = s.rows[e.row]?.dataItem;

                            // ì¬í™œìš© ì…€ ì´ˆê¸°í™”
                            e.cell.style.color = '';
                            e.cell.style.fontWeight = '';

                            if (col && col.binding === 'division' && item) {
                                // ìƒˆ ë¼ë²¨ ë§¤í•‘
                                const label = toDivisionLabel(item.division);
                                e.cell.textContent = label;

                                // ìƒ‰ìƒ/êµµê¸° (ì„ íƒ)
                                const color = DIVISION_COLOR_MAP[label];
                                if (color) e.cell.style.color = color;
                                e.cell.style.fontWeight = '600';
                                return;
                            }
                        }
                    },
                    isReadOnly: true,
                    showMarquee: true,
                    columns: [
                        {binding: 'head_id', visible: false},
                        {binding: 'division', header: 'êµ¬ë¶„', width: 70, align: 'center'},
                        {binding: 'JumunDate', header: 'ì‘ì„±ì¼ì', width: 100, align: 'center'},
                        {binding: 'state_name', header: 'ìƒíƒœ', width: 80, align: 'center'},
                        // {binding: 'JumunNumber', header: 'ë²ˆí˜¸', width: 120, align: 'center'},
                        {binding: 'company_name', header: 'ê±°ë˜ì²˜ëª…', width: 120, align: 'center'},
                        {binding: 'BusinessNumber', header: 'ì‚¬ì—…ìë²ˆí˜¸', width: 120, align: 'center'},
                        {binding: 'product_name', header: 'ì œí’ˆëª…', width: 200, align: 'left'},
                        {binding: 'price', header: 'ê³µê¸‰ê°€ì•¡', width: 100, align: 'right'},
                        {binding: 'vat', header: 'ì„¸ì•¡', width: 80, align: 'right'},
                        {binding: 'total_price', header: 'í•©ê³„', width: 100, align: 'right'},
                        {binding: 'Description', header: 'ë©”ëª¨', width: '*', align: 'left'},
                    ],
                    itemsSource: new wijmo.collections.CollectionView([]),
                });
                new FlexGridContextMenu(this.grid);
                this.grid.downloadFileName = 'ì§„í–‰ ë‚´ì—­';

                // ë”ë¸”í´ë¦­: Description ì…€ì—ì„œëŠ” ìŠ¤í‹°ì»¤, ê·¸ ì™¸ì—ëŠ” ê¸°ì¡´ ë™ì‘
                this.grid.hostElement.addEventListener('dblclick', (e) => {
                    const grid = this.grid;                           // ì•ˆì „í•˜ê²Œ ì°¸ì¡°
                    const ht = grid.hitTest(e);

                    if (ht.cellType === wijmo.grid.CellType.Cell) {   // â† CellType ì°¸ì¡° ìˆ˜ì •
                        const col  = grid.columns[ht.col];
                        const item = grid.rows[ht.row]?.dataItem;

                        if (col && col.binding === 'Description' && item) {
                            const rect = grid.getCellBoundingRect(ht.row, ht.col, true);
                            openMemoSticker(grid, rect, item, this.baseUrl); // ìŠ¤í‹°ì»¤ ì˜¤í”ˆ
                            return; // ë©”ëª¨ ì…€ì¼ ë• ê¸°ë³¸ ë™ì‘ ë§‰ê¸°
                        }
                    }

                    // (ê¸°ì¡´ ë™ì‘) Description ì™¸ ë”ë¸”í´ë¦­ ì‹œ
                    const items = grid.selectedItems;
                    if (!items || items.length === 0) return;
                    this.getDetail();
                    this.getHistory();
                    this.getCompany();
                });


                this.resultGrid = new wijmo.grid.FlexGrid('#result-grid', {
                    autoGenerateColumns: false,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.All,
                    showMarquee: true,
                    childItemsPath: 'children',   // â˜… íŠ¸ë¦¬ í•µì‹¬
                    formatItem: (s, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.RowHeader) {
                            e.cell.textContent = (e.row + 1).toString();
                            return;
                        }
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                            return;
                        }
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnFooter) {
                            const col = s.columns[e.col];
                            if (col.binding === 'product_name') {
                                e.cell.textContent = 'í•©ê³„';
                                e.cell.style.textAlign = 'center';
                            }
                            return;
                        }

                        // ì…€ ì»¤ìŠ¤í„°ë§ˆì´ì§• (ë‚ ì§œ í¬ë§·/ì¸ë´íŠ¸/ë¶€ëª¨ ìˆ«ì í‘œì‹œìš©)
                        if (e.panel.cellType !== wijmo.grid.CellType.Cell) return;

                        const col = s.columns[e.col];
                        const row = s.rows[e.row];
                        const item = row?.dataItem;
                        if (!item) return;

                        // YYYYMMDD -> YYYY-MM-DD (ì„œë²„ê°€ ì´ë¯¸ í¬ë§·í–ˆìœ¼ë©´ ìë™ skip)
                        if (col.binding === 'JumunDate') {
                            const raw = (e.cell.textContent || '').trim();
                            if (/^\d{8}$/.test(raw)) {
                                e.cell.textContent = `${raw.slice(0,4)}-${raw.slice(4,6)}-${raw.slice(6,8)}`;
                            }
                        }

                        // íŠ¸ë¦¬ ì¸ë´íŠ¸ ë³´ì • (ì œí’ˆëª… ì—´ë§Œ)
                        if (col.binding === 'product_name') {
                            const depth = row.level || 0;
                            const btn = e.cell.querySelector('button.wj-elem-collapse');
                            if (btn) { btn.style.height = '14px'; btn.style.padding = '0'; btn.style.lineHeight = '14px'; }
                            const textNode = [...e.cell.childNodes].find(n => n.nodeType === Node.TEXT_NODE && n.textContent.trim() !== '');
                            if (textNode) {
                                const span = document.createElement('span');
                                span.textContent = textNode.textContent.trim();
                                span.style.marginLeft = `${depth * 15}px`;
                                span.style.display = 'inline-block';
                                e.cell.replaceChild(span, textNode);
                            }
                        }

                        // â˜…â˜…â˜… ì—¬ê¸°ë¶€í„° í•µì‹¬: ìì‹ í–‰ì€ 'standard','quantity'ë§Œ í‘œì‹œ
                        if (item.__type === 'child') {
                            const visibleForChild = new Set(['standard', 'quantity']); // í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸
                            if (!visibleForChild.has(col.binding)) {
                                e.cell.textContent = '';               // ë‚˜ë¨¸ì§€ ì „ë¶€ ìˆ¨ê¹€
                                e.cell.classList.add('child-dim');     // (ì„ íƒ) íë¦¬ê²Œ ë³´ì´ë„ë¡
                            } else {
                                // ìˆ«ì í¬ë§·ì´ í•„ìš”í•˜ë©´ ì—¬ê¸°ì—ì„œ í¬ë§·(ì˜ˆ: ì†Œìˆ˜ 1ìë¦¬)
                                if (col.binding === 'quantity') {
                                    const n = Number(e.cell.textContent.replace(/,/g,''));
                                    if (isFinite(n)) e.cell.textContent = (Math.round(n * 10) / 10).toString();
                                }
                            }
                        }

                        // DIFF ìƒ‰ìƒ (ìˆìœ¼ë©´)
                        if (item.DIFF_TYPE) {
                            e.cell.classList.add(`diff-${String(item.DIFF_TYPE).toLowerCase()}`);
                        }

                    },
                    columns: [
                        {binding: 'id', visible:false},
                        {binding: 'JumunDate', header: 'ì¼ì', width: 120, align: 'center', isReadOnly: true},
                        {binding: 'state_name', header: 'ìƒíƒœ', width: 120, align: 'center'},
                        {binding: 'product_name', header: 'ì œí’ˆëª…', width: 200, align: 'left', isReadOnly: true},
                        {binding: 'standard', header: 'ê·œê²©', width: 80, align: 'center', isReadOnly: true},
                        {binding: 'quantity', header: 'ìˆ˜ëŸ‰', width: 80, align: 'right', isReadOnly: true, aggregate: wijmo.Aggregate.Sum},
                        {binding: 'unit_price', header: 'ë‹¨ê°€', width: 80, align: 'right', isReadOnly: true},
                        {binding: 'supply_amount', header: 'ê³µê¸‰ê°€ì•¡', width: 100, align: 'right', isReadOnly: true, aggregate: wijmo.Aggregate.Sum},
                        {binding: 'vat_amount', header: 'ì„¸ì•¡', width: 100, align: 'right', isReadOnly: true, aggregate: wijmo.Aggregate.Sum},
                        {binding: 'total_amount', header: 'í•©ê³„', width: 100, align: 'right', isReadOnly: true, aggregate: wijmo.Aggregate.Sum},
                        {binding: 'description', header: 'ë¹„ê³ ', width: '*', align: 'left', isReadOnly: true},
                    ],
                    itemsSource: new wijmo.collections.CollectionView([]),
                });

                this.resultGrid.columnFooters.rows.push(new wijmo.grid.GroupRow());

                this.resultGrid.loadedRows.addHandler((s, e) => {
                    for (let r = 0; r < s.rows.length; r++) {
                        const row  = s.rows[r];
                        const item = row.dataItem || {};
                        if (row._styled) continue;

                        const depthCls = `row-depth-${Math.min(row.level || 0, 2)}`; // 0/1/2 ì´ìƒì€ 2ë¡œ
                        const typeCls  = item.__type ? `row-type-${item.__type}` : '';

                        row.cssClass = [row.cssClass, depthCls, typeCls].filter(Boolean).join(' ');
                        row._styled = true;
                    }
                });


                new FlexGridContextMenu(this.resultGrid);
                this.resultGrid.downloadFileName = 'ìƒì„¸ ë‚´ì—­';

                this.historyGrid = new wijmo.grid.FlexGrid('#history-grid', {
                    autoGenerateColumns: false,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    showMarquee: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        {binding: 'product_name', header: 'ì œí’ˆëª…', width: 170, align: 'left', isReadOnly: true},
                        {binding: 'standard', header: 'ê·œê²©', width: 70, align: 'center', isReadOnly: true},
                        {binding: 'state_name', header: 'ìƒíƒœ', width: 70, align: 'center', isReadOnly: true},
                        {binding: 'event_time', header: 'ìƒì„±ì‹œê°„', width: 170, align: 'center', isReadOnly: true},
                    ],
                    itemsSource: new wijmo.collections.CollectionView([]),
                });

                // Context Menu ì¶”ê°€
                new FlexGridContextMenu(this.historyGrid);
                this.historyGrid.downloadFileName = 'ì´ë ¥ ë‚´ì—­';

                // ì…ê¸ˆ/ì¶œê¸ˆ ë”ë¸”í´ë¦­ì‹œ ë¯¸ìˆ˜ì”ì•¡ í‘œì‹œ
                this.depositGrid = new wijmo.grid.FlexGrid('#deposit_grid', {
                    autoGenerateColumns: false,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    showMarquee: true,
                    formatItem: (s, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        {binding: 'id', visible:false},
                        // {binding: 'JumunDate', header: 'No', width: '*', align: 'center', isReadOnly: true},
                        {binding: 'date', header: 'ì¼ì', width: '*', align: 'center', isReadOnly: true},
                        {binding: 'sales_count', header: 'ë§¤ì¶œê±´ìˆ˜', width: '*', align: 'right', isReadOnly: true},
                        {binding: 'sales', header: 'ë§¤ì¶œ', width: '*', align: 'right', isReadOnly: true},
                        {binding: 'accin_count', header: 'ìˆ˜ê¸‰ê±´ìˆ˜', width: '*', align: 'right', isReadOnly: true},
                        {binding: 'accin', header: 'ìˆ˜ê¸ˆ', width: '*', align: 'right', isReadOnly: true},
                    ],
                    itemsSource: new wijmo.collections.CollectionView([]),
                });
                // âœ… Footer íŒ¨ë„ ì‚¬ìš© ì„¤ì •
                this.depositGrid.columnFooters.rows.push(new wijmo.grid.Row());
                this.depositGrid.bottomLeftCells.setCellData(0, 0, 'ì´í•©');

                // âœ… Footer í•©ê³„ ê°’ ì„¤ì • (ìˆ˜ë™)
                this.depositGrid.loadedRows.addHandler(() => {
                    const rows = this.depositGrid.rows;
                    const footer = this.depositGrid.columnFooters.rows[0];

                    const getSum = (field) => rows.map(r => +r.dataItem[field] || 0).reduce((a, b) => a + b, 0);

                    footer.dataItem = {
                        date: 'í•©ê³„',
                        sales_count: getSum('sales_count'),
                        sales: getSum('sales'),
                        accin_count: getSum('accin_count'),
                        accin: getSum('accin'),
                    };
                });

                new FlexGridContextMenu(this.depositGrid);
                this.depositGrid.downloadFileName = 'ì…ê¸ˆë‚´ì—­';


                this.wdrawGrid = new wijmo.grid.FlexGrid('#wdraw_grid', {
                    autoGenerateColumns: false,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    showMarquee: true,
                    formatItem: (s, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        {binding: 'id', visible:false},
                        // {binding: 'JumunDate', header: 'No', width: '*', align: 'center', isReadOnly: true},
                        {binding: 'date', header: 'ì¼ì', width: '*', align: 'center', isReadOnly: true},
                        {binding: 'purchase_count', header: 'ë§¤ì…ê±´ìˆ˜', width: '*', align: 'right', isReadOnly: true},
                        {binding: 'purchase', header: 'ë§¤ì…', width: '*', align: 'right', isReadOnly: true},
                        {binding: 'payment_count', header: 'ì§€ê¸‰ê±´ìˆ˜', width: '*', align: 'right', isReadOnly: true},
                        {binding: 'payment', header: 'ì§€ê¸‰', width: '*', align: 'right', isReadOnly: true},
                    ],
                    itemsSource: new wijmo.collections.CollectionView([]),
                });
                // âœ… Footer íŒ¨ë„ ì‚¬ìš© ì„¤ì •
                this.wdrawGrid.columnFooters.rows.push(new wijmo.grid.Row());
                this.wdrawGrid.bottomLeftCells.setCellData(0, 0, 'ì´í•©');

                // âœ… Footer í•©ê³„ ê°’ ì„¤ì • (ìˆ˜ë™)
                this.wdrawGrid.updatedView.addHandler(() => {
                    const rows = this.wdrawGrid.rows;
                    const footer = this.wdrawGrid.columnFooters.rows[0];
                    if (!rows.length) return; // ë°ì´í„° ì—†ì„ ë•Œ skip

                    const getSum = (field) =>
                        rows.map(r => parseFloat((r.dataItem[field] + '').replace(/,/g, '')) || 0)
                            .reduce((a, b) => a + b, 0);

                    footer.dataItem = {
                        date: 'í•©ê³„',
                        purchase_count: getSum('purchase_count'),
                        purchase: getSum('purchase'),
                        payment_count: getSum('payment_count'),
                        payment: getSum('payment'),
                    };
                });

                new FlexGridContextMenu(this.wdrawGrid);
                this.wdrawGrid.downloadFileName = 'ì¶œê¸ˆë‚´ì—­';

            }

            getDetail () {
                const it = this.grid.selectedItems && this.grid.selectedItems[0];
                if (!it) return;

                const data   = { id: it.head_id, division: it.division, company_id: it.company_id, JumunDate: it.JumunDate, startDate: document.getElementById('date_from').value, endDate: document.getElementById('date_to').value};
                const result = AjaxUtil.getSyncData(this.baseUrl + '/detail', data);
                if (!result || !result.data) return;

                const isSuju = String(it.division) === 'ìˆ˜ì£¼';
                const isDeposit = String(it.division) === 'ì…ê¸ˆ';
                const isWdraw = String(it.division) === 'ì¶œê¸ˆ';
                const isSales = String(it.division) === 'ë§¤ì¶œ';
                const isBalju = String(it.division) === 'ë°œì£¼';
                const isPurchase = String(it.division) === 'ë§¤ì…';

                const resultGridContainer = document.querySelector('#result-grid').closest('.container-fluid');
                const depositContainer = document.querySelector('#deposit-container');
                const wdrawContainer = document.querySelector('#wdraw-container');

                // íŠ¸ë¦¬ ëª¨ë“œ on/off
                this.resultGrid.childItemsPath = isSuju ? 'children' : null;

                if (isSuju) {
                    // ìˆ˜ì£¼ì¼ ë•Œ: íŠ¸ë¦¬ êµ¬ì¡° í‘œì‹œ
                    const tree = toTree(result.data);
                    this.resultGrid.itemsSource = new wijmo.collections.CollectionView(tree);
                    this.resultGrid.collapseGroupsToLevel(0);

                    // í‘œì‹œ ì „í™˜
                    resultGridContainer.style.display = 'flex';
                    depositContainer.style.display = 'none';
                    wdrawContainer.style.display = 'none';
                }
                else if (isDeposit || isSales) {
                    // ì…ê¸ˆ, ë§¤ì¶œ ë•Œ: ë¯¸ìˆ˜ë‚´ì—­ í‘œì‹œ + resultGrid ìˆ¨ê¹€
                    this.depositGrid.itemsSource = new wijmo.collections.CollectionView(result.data[0].TotalList);
                    document.getElementById('totalDeposit').value = result.data[0].getDetail[0].misu_total;
                    document.getElementById('totalUnDeposit').value = result.data[0].getDetail[0].miji_total;
                    document.getElementById('totalRowDeposit').value = result.data[0].getDetail[0].balance;
                    resultGridContainer.style.display = 'none';
                    depositContainer.style.display = 'flex';
                    wdrawContainer.style.display = 'none';
                }
                else if(isWdraw || isPurchase || isBalju){
                    //ì¶œê¸ˆ, ë§¤ì… ë•Œ: ë¯¸ìˆ˜ë‚´ì—­ í‘œì‹œ + resultGrid ìˆ¨ê¹€
                    this.wdrawGrid.itemsSource = new wijmo.collections.CollectionView(result.data[0].TotalList);
                    document.getElementById('totalDeposit2').value = result.data[0].getDetail[0].misu_total;
                    document.getElementById('totalUnDeposit2').value = result.data[0].getDetail[0].miji_total;
                    document.getElementById('totalRowDeposit2').value = result.data[0].getDetail[0].balance;
                    resultGridContainer.style.display = 'none';
                    depositContainer.style.display = 'none';
                    wdrawContainer.style.display = 'flex';
                }
                else {
                    // ì¼ë°˜ í‰ë©´ ë°ì´í„°
                    this.resultGrid.itemsSource = new wijmo.collections.CollectionView(result.data);

                    resultGridContainer.style.display = 'flex';
                    depositContainer.style.display = 'none';
                    wdrawContainer.style.display = 'none';
                }

                // ì„ íƒ/ìŠ¤í¬ë¡¤ ì´ˆê¸°í™”(ì„ íƒ)
                // this.resultGrid.select(-1, -1);
                // this.resultGrid.scrollPosition = new wijmo.Point(0, 0);
            }

            getHistory () {
                let _this = this;

                const it = _this.grid.selectedItems && _this.grid.selectedItems[0];
                let data = {
                    id: it.head_id,
                    division: it.division,
                };
                // 1) ë°ì´í„° ë¡œë“œ
                let result = AjaxUtil.getSyncData(this.baseUrl + '/history', data);
                if (result.data) {
                    const rows = result.data.map(r => ({
                        ...r,
                        event_time: new Date(r.event_time) // ISO â†’ Date
                    }));

                    // 2) ê·¸ë£¹/ì •ë ¬ ì„¤ì •
                    const labelMap = { suju: 'ìˆ˜ì£¼', job: 'ìƒì‚°', shipment: 'ì¶œê³ ', balju: 'ë°œì£¼', input: 'ì…ê³ ',
                        sales: "ë§¤ì¶œ" , purchase:'ë§¤ì…', receive: 'ì…ê¸ˆ', payment: 'ì¶œê¸ˆ' };

                    const cv = new wijmo.collections.CollectionView(rows);
                    // event_typeìœ¼ë¡œ ê·¸ë£¹ (ì •ë ¬ í‚¤ë¥¼ ì ‘ë‘ë¡œ ë¶™ì—¬ ìˆœì„œ ê³ ì •)
                    cv.groupDescriptions.push(new wijmo.collections.PropertyGroupDescription(
                        'event_type',
                        item => {
                            const t = item.event_type;
                            const label = labelMap[t] ?? t;  // 'ìˆ˜ì£¼' ë“±
                            return `${label}`;      // ê·¸ë£¹ ê°’(value)ì´ ë¨
                        }
                    ));
                    // ê·¸ë£¹ ë‚´ ì‹œê°„ìˆœ ì •ë ¬
                    cv.sortDescriptions.push(new wijmo.collections.SortDescription('event_time', true));

                    this.historyGrid.itemsSource = cv;

                    // 3) ì»¬ëŸ¼ íƒ€ì…/í¬ë§·(ì„ íƒ)
                    const col = this.historyGrid.columns.getColumn('event_time');
                    if (col) {
                        col.dataType = wijmo.DataType.Date;
                        col.format = 'yyyy-MM-dd HH:mm:ss';
                    }

                    // 4) ê·¸ë£¹ í—¤ë” í‘œì‹œ ì˜ˆì˜ê²Œ (ì ‘ë‘ "1:" ì œê±° + ê±´ìˆ˜ í‘œì‹œ)
                    this.historyGrid.groupHeaderFormat = '{value} ';
                    this.historyGrid.formatItem = (s, e) => {
                        // ê¸°ì¡´ í—¤ë” ê°€ìš´ë° ì •ë ¬ ìœ ì§€
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                        // ê·¸ë£¹ í—¤ë” ê¾¸ë¯¸ê¸°
                        if (e.panel === s.cells) {
                            const row = s.rows[e.row];
                            if (row instanceof wijmo.grid.GroupRow) {
                                const g = row.dataItem; // CollectionViewGroup
                                if (e.col === 0) {
                                    const raw = String(g.name);            // "1:ìˆ˜ì£¼" ê°™ì€ ë¬¸ìì—´
                                    const label = raw.replace(/^\d+:/, ''); // "ìˆ˜ì£¼"ë§Œ ì¶”ì¶œ
                                    e.cell.textContent = `${label} (${g.items.length}ê±´)`;
                                    e.cell.style.fontWeight = '600';
                                } else {
                                    // ê·¸ë£¹ í—¤ë”ì˜ ë‚˜ë¨¸ì§€ ì¹¼ëŸ¼ì€ ë¹„ìš°ê¸°
                                    e.cell.textContent = '';
                                }
                            }
                        }
                    };
                }
            };


            getCompany () {
                let _this = this;

                const it = _this.grid.selectedItems && _this.grid.selectedItems[0];
                let data = {
                    company_id: it.company_id
                };
                let result = AjaxUtil.getSyncData('/api/definition/company/detail', data);
                if (result.data) {
                    const d = { ...result.data };
                    d.business_number = formatBizNo(d.business_number);
                    d.tel_number      = formatPhone(d.tel_number);
                    d.fax_number      = formatPhone(d.fax_number);
                    FormUtil.BindDataForm(d, $('#companyForm'));
                    document.getElementById('description').value = (it && it.Description) ? it.Description : '';
                }

            };

            // ì‘ì—…ëª©ë¡ ì¡°íšŒ
            searchMainData() {
                let _this = this;

                let param = {
                    'date_from': $('#date_from').val(),
                    'date_to': $('#date_to').val(),
                    'choComp': $('#choComp').val(),
                };

                let result = AjaxUtil.getSyncData(this.baseUrl + '/read', param);
                if (result.data && _this.grid.itemsSource) {
                    const rows = result.data.map(r => ({
                        ...r,
                        BusinessNumber: formatBizNo(r.BusinessNumber) // â† ê° í•­ëª©ì— í•˜ì´í”ˆ ì ìš©
                    }));
                    _this.grid.itemsSource = new wijmo.collections.CollectionView(rows);
                }
            }

        }

        function toTree(rows) {
            const byId = new Map();

            // 1) ë¶€ëª¨ ìƒì„± (ë™ì¼)
            for (const r of rows || []) {
                const id = r.id;
                if (!byId.has(id)) {
                    byId.set(id, {
                        __type: 'parent',
                        id: r.id,
                        head_id: r.head_id,
                        Material_id: r.Material_id,
                        product_code: r.product_code,
                        JumunDate: r.JumunDate,
                        product_name: r.product_name,
                        unit: r.unit,
                        standard: r.header_standard_label ?? r.header_standard ?? r.standard ?? '',
                        // í•©ê³„ ì¤‘ë³µ ë°©ì§€ ê¸°ë³¸ê°’
                        quantity: null, unit_price: null, supply_amount: null, vat_amount: null, total_amount: null,
                        // í™”ë©´ í‘œì‹œìš©
                        _display_quantity: r.header_quantity ?? r.quantity ?? null,
                        _display_unit_price: r.header_unit_price ?? r.unit_price ?? null,
                        _display_supply_amount: r.header_supply_amount ?? r.supply_amount ?? null,
                        _display_vat_amount: r.header_vat_amount ?? r.vat_amount ?? null,
                        _display_total_amount: r.header_total_amount ?? r.total_amount ?? null,

                        state: r.state, state_name: r.state_name, description: r.description, DIFF_TYPE: r.DIFF_TYPE,
                        __hasNonFallbackChild: false, __sawFallback: false,
                        children: []
                    });
                }
            }

            // 2) ìì‹ ë¶™ì´ê¸° (fallbackì€ ìƒì„±í•˜ì§€ ì•ŠìŒ)
            for (const r of rows || []) {
                const p = byId.get(r.id);
                const isChild = (r.row_type === 'child') || (r.detail_id != null) || (r.is_fallback === true);
                if (!isChild) continue;

                if (r.is_fallback === true) { p.__sawFallback = true; continue; }

                p.__hasNonFallbackChild = true;
                p.children.push({
                    __type: 'child',
                    id: r.id, detail_id: r.detail_id ?? null, JumunDate: r.JumunDate, product_name: r.product_name,
                    standard: r.standard, quantity: r.quantity, unit_price: r.unit_price,
                    supply_amount: r.supply_amount, vat_amount: r.vat_amount, total_amount: r.total_amount,
                    description: r.description, state: r.state, state_name: r.state_name, DIFF_TYPE: r.DIFF_TYPE
                });
            }

            // 3) í›„ì²˜ë¦¬: ë¡¤ì—… + fallback ì²˜ë¦¬
            for (const p of byId.values()) {
                if (p.children.length > 0) {
                    const sum = k => p.children.reduce((a, c) => a + (Number(c[k]) || 0), 0);
                    const hasChildAmounts = p.children.some(c =>
                        c.supply_amount != null || c.vat_amount != null || c.total_amount != null
                    );

                    if (hasChildAmounts) {
                        // (ë°°ë¶„ ëª¨ë“œ) ìì‹ í•©ê³„ + ê°€ì¤‘í‰ê·  ë‹¨ê°€
                        p.quantity      = sum('quantity');
                        p.supply_amount = sum('supply_amount');
                        p.vat_amount    = sum('vat_amount');
                        p.total_amount  = sum('total_amount');
                        p.unit_price    = p.quantity ? Math.round(p.total_amount / p.quantity) : null;
                    } else {
                        // (í—¤ë” ëª¨ë“œ) ìì‹ì€ ìˆìœ¼ë‚˜ ê¸ˆì•¡ì´ ì—†ìœ¼ë©´ í—¤ë” ê¸ˆì•¡ ì‚¬ìš©
                        const n = v => (v == null ? null : Number(v));
                        const childQtySum = sum('quantity');
                        p.quantity      = n(p._display_quantity) ?? childQtySum ?? 0;
                        p.unit_price    = n(p._display_unit_price);
                        p.supply_amount = n(p._display_supply_amount) ?? 0;
                        p.vat_amount    = n(p._display_vat_amount) ?? 0;
                        p.total_amount  = n(p._display_total_amount) ?? 0;

                        p._display_unit_price    = p.unit_price;
                        p._display_quantity      = p.quantity;
                        p._display_supply_amount = p.supply_amount;
                        p._display_vat_amount    = p.vat_amount;
                        p._display_total_amount  = p.total_amount;
                    }
                } else {
                    // ğŸ”§ ìì‹ì´ ì „í˜€ ì—†ëŠ” ë¶€ëª¨(=fallbackë§Œ ìˆì—ˆë˜ ê²½ìš°)ë„ í—¤ë” í‘œì‹œê°’ìœ¼ë¡œ ì±„ì›€
                    const n = v => (v == null ? null : Number(v));
                    p.quantity      = n(p._display_quantity) ?? 0;
                    p.unit_price    = n(p._display_unit_price);
                    p.supply_amount = n(p._display_supply_amount) ?? 0;
                    p.vat_amount    = n(p._display_vat_amount) ?? 0;
                    p.total_amount  = n(p._display_total_amount) ?? 0;

                    p._display_unit_price    = p.unit_price;
                    p._display_quantity      = p.quantity;
                    p._display_supply_amount = p.supply_amount;
                    p._display_vat_amount    = p.vat_amount;
                    p._display_total_amount  = p.total_amount;
                }
            }
            return Array.from(byId.values());
        }

        // ê³µí†µ: ìˆ«ìë§Œ ë‚¨ê¸°ê¸°
        const digits = v => String(v || '').replace(/\D/g, '');

        // ì‚¬ì—…ìë²ˆí˜¸: 10ìë¦¬ â†’ 000-00-00000
        const formatBizNo = v => {
            const d = digits(v);
            return d.length === 10 ? `${d.slice(0,3)}-${d.slice(3,5)}-${d.slice(5)}` : v || '';
        };

        // ì „í™”/íŒ©ìŠ¤
        const formatPhone = v => {
            const d = digits(v);
            if (!d) return '';

            if (d.startsWith('02')) { // ì„œìš¸
                return d.length >= 10
                    ? `02-${d.slice(2, d.length-4)}-${d.slice(-4)}`
                    : `02-${d.slice(2,5)}-${d.slice(5)}`;
            }
            if (/^01[016789]/.test(d)) { // íœ´ëŒ€í°
                return d.length === 11
                    ? `${d.slice(0,3)}-${d.slice(3,7)}-${d.slice(7)}`
                    : `${d.slice(0,3)}-${d.slice(3,6)}-${d.slice(6)}`;
            }
            if (d.startsWith('070')) {
                return `070-${d.slice(3, d.length-4)}-${d.slice(-4)}`;
            }
            if (d.startsWith('050')) {
                return `${d.slice(0,4)}-${d.slice(4,8)}-${d.slice(8)}`;
            }
            // ì¼ë°˜ ì§€ì—­ë²ˆí˜¸(3ìë¦¬ ê°€ì •)
            return d.length >= 9
                ? `${d.slice(0,3)}-${d.slice(3, d.length-4)}-${d.slice(-4)}`
                : v || '';
        };

        function ensureMemoSticker() {
            let sticker = document.getElementById('memo-sticker');
            if (sticker) return sticker;

            sticker = document.createElement('div');
            sticker.id = 'memo-sticker';
            sticker.style.cssText = `
    position:absolute; display:none; z-index:10000;
    width:320px; background:#d1d5db; border:1px solid #d1d5db;
    box-shadow:0 8px 20px rgba(0,0,0,.15); border-radius:10px; padding:10px;
  `;
            sticker.innerHTML = `
    <div id="memoHeader" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;cursor:move;user-select:none;">
      <strong>ë©”ëª¨</strong>
      <button type="button" id="memoCloseBtn" style="border:none;background:transparent;font-size:18px;cursor:pointer;">âœ•</button>
    </div>
    <textarea id="memoText" rows="6" style="width:100%;height:180px;box-sizing:border-box;resize:vertical;"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button type="button" id="memoSaveBtn"   style="padding:6px 10px;border-radius:6px;border:1px solid #d1d5db;cursor:pointer;">ì €ì¥</button>
      <button type="button" id="memoCancelBtn" style="padding:6px 10px;border-radius:6px;border:1px solid #d1d5db;background:#fff;cursor:pointer;">ì·¨ì†Œ</button>
    </div>
  `;
            document.body.appendChild(sticker);

            // â˜… ë“œë˜ê·¸ ê°€ëŠ¥í•˜ê²Œ
            makeStickerDraggable(sticker, sticker.querySelector('#memoHeader'));
            return sticker;
        }

        function makeStickerDraggable(sticker, handle) {
            let dragging = false, startX = 0, startY = 0, startLeft = 0, startTop = 0;
            let prevUserSelect = '';

            const onDown = (clientX, clientY, preventDefault) => {
                dragging = true;
                const rect = sticker.getBoundingClientRect();
                startLeft = rect.left;
                startTop  = rect.top;
                startX = clientX;
                startY = clientY;
                prevUserSelect = document.body.style.userSelect;
                document.body.style.userSelect = 'none';
                preventDefault && preventDefault();
            };

            const onMove = (clientX, clientY) => {
                if (!dragging) return;
                let newLeft = startLeft + (clientX - startX);
                let newTop  = startTop  + (clientY - startY);

                const pad = 8;
                const maxLeft = window.innerWidth  - sticker.offsetWidth  - pad;
                const maxTop  = window.innerHeight - sticker.offsetHeight - pad;
                newLeft = Math.max(pad, Math.min(maxLeft, newLeft));
                newTop  = Math.max(pad, Math.min(maxTop,  newTop));

                sticker.style.left = `${newLeft}px`;
                sticker.style.top  = `${newTop}px`;
                sticker.dataset.dragged = '1'; // ì´í›„ ì—´ ë•Œ ì´ ìœ„ì¹˜ ìœ ì§€
            };

            const onUp = () => {
                if (!dragging) return;
                dragging = false;
                document.body.style.userSelect = prevUserSelect;
            };

            // Mouse
            handle.addEventListener('mousedown', (e) => onDown(e.clientX, e.clientY, () => e.preventDefault()));
            document.addEventListener('mousemove', (e) => onMove(e.clientX, e.clientY));
            document.addEventListener('mouseup', onUp);

            // Touch
            handle.addEventListener('touchstart', (e) => {
                const t = e.touches[0];
                onDown(t.clientX, t.clientY, () => e.preventDefault());
            }, { passive: false });
            document.addEventListener('touchmove', (e) => {
                if (!dragging) return;
                const t = e.touches[0];
                onMove(t.clientX, t.clientY);
            }, { passive: false });
            document.addEventListener('touchend', onUp);
        }

        function openMemoSticker(grid, rect, item, baseUrl) {
            const sticker = ensureMemoSticker();
            const txt = sticker.querySelector('#memoText');
            const btnSave = sticker.querySelector('#memoSaveBtn');
            const btnCancel = sticker.querySelector('#memoCancelBtn');
            const btnClose = sticker.querySelector('#memoCloseBtn');

            sticker.style.display = 'block';

            // â˜… ì‚¬ìš©ìê°€ ë“œë˜ê·¸í•œ ì  ì—†ìœ¼ë©´ ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì„¸íŒ…
            if (sticker.dataset.dragged !== '1') {
                const left = Math.min(rect.left, window.innerWidth - sticker.offsetWidth - 16);
                const top  = Math.min(rect.top + rect.height + 8, window.innerHeight - sticker.offsetHeight - 16);
                sticker.style.left = `${Math.max(8, left)}px`;
                sticker.style.top  = `${Math.max(8, top)}px`;
            }

            txt.value = item.Description || '';
            setTimeout(() => txt.focus(), 0);

            const close = () => { sticker.style.display = 'none'; };

            btnCancel.onclick = btnClose.onclick = close;

            const keyHandler = (e) => {
                if (sticker.style.display !== 'block') return;
                if (e.key === 'Escape') close();
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') btnSave.click();
            };
            document.addEventListener('keydown', keyHandler, { once: true });

            btnSave.onclick = () => {
                const newMemo = txt.value;
                const payload = { head_id: item.head_id, division: item.division, description: newMemo };
                const res = AjaxUtil.postSyncData(baseUrl + '/memo/save', payload);
                if (res && res.success === false) {
                    alert(res.message || 'ì €ì¥ ì‹¤íŒ¨');
                    return;
                }
                item.Description = newMemo;
                grid.collectionView.refresh();
                close();
            };

            const outsideClose = (e) => {
                if (sticker.style.display === 'block' && !sticker.contains(e.target)) {
                    close();
                    document.removeEventListener('mousedown', outsideClose);
                    document.removeEventListener('touchstart', outsideClose);
                }
            };
            document.addEventListener('mousedown', outsideClose);
            document.addEventListener('touchstart', outsideClose);
        }



        let page = null;

        $(document).ready(function (e) {
            page = new DashCustomPage();
            const now  = new Date();
            const jan1 = new Date(now.getFullYear(), 0, 1);
            const nextMonthLast = new Date(now.getFullYear(), now.getMonth() + 2, 0);

            let date_from = CommonUtil.formatYYYYMMDD(jan1);
            let today = CommonUtil.formatYYYYMMDD(nextMonthLast);


            page.today = today;

            $('#date_from').val(date_from);
            $('#date_to').val(today);


            page.searchMainData();

            $('#btnMainSearch').click(function (e) {
                page.searchMainData();
            });

            $('#choComp').on('keydown', function (e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault(); // form submit ë°©ì§€
                    page.searchMainData();
                }
            });

        });
    </script>
</th:block>
</html>
