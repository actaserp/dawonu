<html layout:decorate="~{layout_page}">
<head>
  <style>
      #matListTb input, #matListTb textarea {
          width: 100px;
          height: 40px;
      }

  </style>
</head>
<th:block layout:fragment="content">

  <div class="layout-contents">
    <div class="page-title-wrap">
      <div class="left">
        <h2>수주 및 계획량 등록</h2>
        <a title="북마크" class="bookmark toggle">
          내 메뉴
        </a>
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
        <li>영업 관리</li>
        <li>수주 및 계획량 등록</li>
      </ul>
    </div>

    <section class="section">
      <div class="section-top">
        <div class="search-wrap">
          <!--<dl>
            <dt>
              <label for="cboDateKind">
                검색 구분<span class="eq"></span>
              </label>
            </dt>
            <dd>
              <div class="srch-box">
                <select id="cboDateKind" name="cboDateKind">
                  <option value="sales">수주일</option>
                  <option value="delivery">납기일</option>
                </select>
              </div>
            </dd>
          </dl>-->
          <dl>
            <dt>
              조회기간<span class="eq">*</span>
            </dt>
            <dd>
              <ul class="date-box">
                <li>
                  <input type="date" id="srchStartDt" name="srchStartDt">
                  <label for="srchStartDt" class="hide">시작일</label>
                </li>
                <li>
                  <input type="date" id="srchEndDt" name="srchEndDt">
                  <label for="srchEndDt" class="hide">종료일</label>
                </li>
              </ul>
            </dd>
          </dl>

          <dl>
            <dt>&nbsp;</dt>
            <dd>
              <li>
                <a class="btn btn-delete" title="검색" id="btnSearch">
                  <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                  <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                  검색
                </a>
              </li>
            </dd>
          </dl>
        </div>
        <div class="button-wrap">
          <ul>
            <li>
              <a class="btn" title="견적서 출력" id="btnEstimatePrint">
                견적서 출력
              </a>
            </li>
            <li>
              <a class="btn btn-excell" title="페이지 이동" id="balju_optimal_stock_move">
                적정재고
              </a>
            </li>
            <li>
              <a class="btn btn-excell" title="페이지 이동" id="balju_order_move">
                발주등록
              </a>
            </li>
            <li>
              <a class="btn btn-excell" title="페이지 이동" id="cash_io_move">
                입출금등록
              </a>
            </li>
            <li>
              <a class="btn btn-excell" title="페이지 이동" id="sales_invoice_move">
                매출등록
              </a>
            </li>
            <li>
              <a class="btn btn-excell" title="등록" id="btnAddNew">
                <img src="/images/icon/ico-plus.svg" alt="등록 아이콘">
                등록
              </a>
            </li>
            <li>
              <a class="btn btn-delete" title="삭제" id="btnDelete">
                <img src="/images/icon/ico-delete.svg" alt="삭제 아이콘">
                삭제
              </a>
            </li>
            <li>
              <a class="btn btn-edit" title="수정" id="btnEdit">
                <img src="/images/icon/ico-edit.svg" alt="수정 아이콘">
                수정
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div class="container-fluid">
        <div id="theGrid" style="height: 730px;"></div>
      </div>
      <!--        <div class="grid_box">-->

      <!--            <div class="h-640" data-ax5grid="sujuGrid" ></div>-->
      <!--        </div>-->
    </section>
  </div>
  <script type="text/x-tmpl" id="sujuTemplate">
    <style>
        /* 아이템 테이블 전체 설정 */
        .item-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            margin-top: 10px;
        }

        /* 헤더 셀 스타일 */
        .item-table th {
            background-color: #EDEFF5;
            text-align: center;
            font-weight: bold;
            padding: 8px;
            border: 1px solid #ccc;
        }

        /* 바디 셀 스타일 */
        .item-table td {
            padding: 6px;
            text-align: center;
            border: 1px solid #ccc;
        }

        /* 입력 필드 기본 스타일 */
        .item-table input {
            width: 100%;
            box-sizing: border-box;
            padding: 4px;
        }

        /* 품목 & 비고 왼쪽 정렬 */
        .item-table td:first-child,
        .item-table td:nth-child(6) {
            text-align: left;
        }

        /* 공통 버튼 스타일 */
        .item-table .btn.in_btn {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            padding: 0;
            border: 1px solid #B3B3B3;
            background-color: #fff;
            cursor: pointer;
            transition: background-color 0.2s;
            line-height: 0;
        }

        /* + 버튼 전용 스타일 */
        .item-table .btn.in_btn.plus img {
            width: 10px;
            height: 10px;
            display: block;
        }

        /* 공통 아이콘 버튼 이미지 (삭제, 검색 포함) */
        .item-table .btn.in_btn img {
            width: 12px;
            height: 12px;
            display: block;
            margin-right: 5px;
        }

        .input-with-button {
            display: flex;
            gap: 4px; /* 버튼과 input 사이 여백 */
            align-items: center;
        }

        .input-with-button input {
            flex: 1; /* 나머지 영역 차지 */
            min-width: 0;
            padding: 4px;
        }

        .input-with-button .btn.in_btn {
            flex-shrink: 0;
        }

        .content_wrap.popup {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .table-wrap {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        .popup-button {
            flex-shrink: 0;
            padding: 10px;
            background: #fff;
            border-top: 1px solid #ddd;
        }

        .input-with-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .input-with-checkbox input[type="number"] {
            flex: 1;
            min-width: 0;
            padding: 4px;
        }

        .input-with-checkbox input[type="checkbox"] {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
        }
        #plusCompany{
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            padding: 0;
            border: 1px solid #B3B3B3;
            background-color: #fff;
            cursor: pointer;
            transition: background-color 0.2s;
            line-height: 0;
        }
        #plusCompany > img{
           width: 12px;
           height: 12px;
           display: block;
           margin-right: 5px;
        }
    </style>
    <div class="content_wrap popup" id="div_excel_upload">
        <div class="table-wrap">
        <form id="sujuForm">
            <table class="write-table">
                <caption>주문등록 테이블</caption>
                <input type="hidden" id="id" name="id">
                <tbody>
                    <tr>
                        <th style="text-align: center">
                            <label for="JumunDate">수주일<span class="eq">*</span></label>
                        </th>
                        <td>
                            <input type="date" id="JumunDate" name="JumunDate">
                        </td>
                        <th style="text-align: center">
                            <label for="DueDate">납기일<span class="eq">*</span></label>
                        </th>
                        <td>
                            <input type="date" id="DueDate" name="DueDate">
                        </td>
                    </tr>
                    <tr>
                       <th style="text-align: center">
                            <label for="cboOrder">수주처<span class="eq">*</span></label>
                        </th>
                        <td >
                            <input id="SuJuOrderId" name="SuJuOrderId" type="hidden">
                            <input class="form-control2" type="text" id="SuJuOrderName" name="SuJuOrderName"
                            placeholder="수주처 검색 버튼을 클릭하여 판매처를 검색하세요" readonly/>
                            &nbsp;
                            <a class="btn btn-delete" title="검색" id="btnOrderSearch">
                                <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                수주처 검색
                            </a>
                            <a class="btn in_btn plus" id="plusCompany" title="거래처등록">
                                <img src="/images/icon/ico-plus.svg" alt="등록 아이콘" />
                            </a>
                        </td>
                        <th style="text-align: center">
                            <label for="cboSujuType">수주구분</label>
                        </th>
                        <td colspan="3">
                            <select id="cboSujuType" name="SujuType"></select>
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="cboCompany">판매처<span class="eq">*</span></label>
                        </th>
                        <td >
                            <input id="cboCompany" name="Company_id" type="hidden">
                            <input class="form-control2" type="text" id="CompanyName" name="CompanyName"
                            placeholder="판매처 검색 버튼을 클릭하여 판매처를 검색하세요" readonly/>
                            &nbsp;
                            <a class="btn btn-delete" title="검색" id="btnCompanySearch">
                                <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                판매처 검색
                            </a>
                        </td>
                        <th style="text-align: center">
                            <label for="delivery">납품처<span class="eq">*</span></label>
                        </th>
                        <td colspan="3">
                            <input class="form-control2" type="text" id="DeliveryName" name="DeliveryName" placeholder="납품처"/>
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="Description">비고</label>
                        </th>
                        <td colspan="3">
                            <textarea id="Description" name="Description" style="height:80px;"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="EstimateMemo">견적 메모</label>
                        </th>
                        <td colspan="3">
                            <textarea id="EstimateMemo" name="EstimateMemo" style="height:80px;"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="StateName">상태</label>
                        </th>
                        <td>
                            <input type="text" id="StateName" name="StateName" readonly disabled>
                        </td>
                        <th style="text-align: center">
                            <label for="totalAmountSum">총액</label>
                        </th>
                        <td>
                            <input id="totalAmountSum" name="totalAmountSum" style="text-align:right;" readonly>
                        </td>
                    </tr>
                </tbody>
            </table>
            <table class="item-table">
                <table class="item-table">
                <colgroup>
                    <col style="width: 6%">
                    <col style="width: 20%">
                    <col style="width: 6%">
                    <col style="width: 11%">
                    <col style="width: 6%">
                    <col style="width: 13%">
                    <col style="width: 9%">
                    <col style="width: 9%">
                    <col style="width: 9%">
                    <col style="width: 11%">
                    <col style="width: 4%">
                </colgroup>
                <thead>
                <tr id="itemHeaderRow">
                    <th>코드</th>
                    <th>품목</th>
                    <th>단위</th>
                    <th>규격</th>
                    <th>수량</th>
                    <th>단가 <span style="font-size: 13px;">(선택시 부가세 포함)</span></th>
                    <th>공급가액</th>
                    <th>부가세</th>
                    <th>합계</th>
                    <th>비고</th>
                    <th>
                        <a class="btn in_btn plus" id="addRemark" title="추가">
                            <img src="/images/icon/ico-plus.svg" alt="등록 아이콘" />
                        </a>
                    </th>
                </tr>
                </thead>
                <tr class="item-template-row" style="display: none;">
                    <td>
                        <input type="text" style="text-align:center;" name="product_code" placeholder="코드" readonly/>
                    </td>
                    <td>
                        <div class="input-with-button">
                            <input type="hidden" name="suju_id" />
                            <input type="text" name="txtProductName" placeholder="코드 또는 품명 입력 후 엔터" autocomplete="off" />
                            <input type="hidden" name="MaterialGroupName" />
                            <input type="hidden" name="Material_id" />
                            <input type="hidden" name="standard_locked">
                            <a class="btn in_btn" title="품목 신규등록" id="btnProductSave">
                                <img src="/images/icon/ico-plus.svg" alt="등록 아이콘" />
                            </a>
                        </div>
                    </td>
                    <td><input type="text" style="text-align:center;" name="unit" placeholder="단위" readonly/></td>
                    <td>
                      <div class="input-with-button">
                        <input type="hidden" id = "standard_id" name="standard_id" />
                        <input type="text" style="text-align:center;" name="standard" placeholder="규격" />
                        <a class="btn in_btn" title="상세규격 등록" id="btnStandard" name="btnStandard" style="display: none;" >
                            <img src="/images/icon/ico-plus.svg" alt="등록 아이콘" />
                        </a>
                      </div>
                    </td>
                    <td><input type="text" style="text-align:right;" name="quantity" placeholder="수량" /></td>
                    <td>
                        <div class="input-with-checkbox">
                            <input style="text-align:right;" type="text" name="unitPrice" placeholder="단가" />
                            <input type="hidden" name="originalUnitPrice" />
                            <input type="checkbox" name="VatIncluded" />
                        </div>
                    </td>
                    <td><input type="text" style="text-align:right;" name="supplyAmount" placeholder="공급가액" /></td>
                    <td><input type="text" style="text-align:right;" name="VatAmount" placeholder="부과세"/></td>
                    <td><input type="text" style="text-align:right;" name="totalAmount" placeholder="합계" /></td>
                    <td><input type="text" name="description" placeholder="비고" /></td>
                    <td class="al_c item_border">
                        <a class="btn in_btn" title="삭제" onclick="removeItemRow(this)">
                            <img src="/images/icon/ico-delete.svg" alt="삭제 아이콘" />
                        </a>
                    </td>
                </tr>
                </tbody>
            </table>
        </form>
        </div>
        <div id="notUpdate" style="display:none;">*계획 또는 출하가 진행된 수주는 수정이 불가합니다.</div>
        <div class="popup-button">
                <button type="button" class="btn-popup y_write_auth" id="btnPopSujuSave">저장</button>
                <button type="button" class="btn-popup" id="modal-close-button">닫기</button>
        </div>
    </div>
  </script>

  <script type="text/x-tmpl" id="excelUploadTemplate">
    <div class="content_wrap popup" id="div_excel_upload">

        <div class="table-wrap">
            <form id="excelUploadForm">
            <table class="write-table">
                <colgroup>
                    <col style="width: 25%;">
                    <col style="width: 75%;">
                </colgroup>
                <tbody>
                    <tr>
                        <th style="text-align: center">
                            <label>일자</label>
                        </th>
                        <td>
                            <input style="width:300px;" type="date" id="data_date" name="data_date" value=""  />
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label>첨부파일</label>
                        </th>
                        <td>
                            <input style="width:300px; height: 44px;" type="file" id="upload_file" name="upload_file" enctype="multipart/form-data" accept=".xls, .xlsx"/>
                        </td>
                    </tr>
                </tbody>
            </table>
            </form>
        </div>
        <div class="pt-2">
            <textarea id="upload_message" style='display:none;width:100%;height:150px;'></textarea>
        </div>

        </section>

        <div class="popup-button">
            <button type="button" class="btn-popup y_write_auth" id="btn_excel_save" >저장</button>
            <button type="button" class="btn-popup" id="modal-close-button">닫기</button>
        </div>
    </div>
  </script>

  <script type="text/x-tmpl" id="StandardTemplate">
    <style>
  /* 공통 버튼 스타일 */
  .item-Standard-table .btn.in_btn{
    display:inline-flex; justify-content:center; align-items:center;
    width:32px; height:32px; border-radius:4px; padding:0;
    border:1px solid #B3B3B3; background-color:#fff; cursor:pointer;
    transition:background-color .2s; line-height:0;
  }
/* 공통 아이콘 버튼 이미지 (삭제, 검색 포함) */
.item-Standard-table .btn.in_btn img {
  width:12px; height:12px; display:block; margin-right:2px;
}

/* + 버튼 전용 (공통보다 아래에 둬서 덮어쓰기) */
.item-Standard-table .btn.in_btn.plus img {
  width:10px; height:10px; display:block;
}

  /* 입력 공통 */
  .item-Standard-table input{
    width:100%; box-sizing:border-box; padding:6px; text-align:center;
  }
  .item-Standard-table th, .item-Standard-table td{ height:32px; }

  /* (선택) 호버/비활성 효과 */
  .item-Standard-table .btn.in_btn:hover{ background-color:#f6f6f6; }
  .item-Standard-table .btn.in_btn:disabled{ opacity:.6; cursor:not-allowed; }
</style>
   <div class="content_wrap popup" id="div_excel_upload">
     <div class="table-wrap">
       <form id="FormStandard">
         <table class="write-table">
           <tbody>
             <tbody>
                <tr>
                  <th style="text-align: center">
                      <label for="ProductName">품목</label>
                  </th>
                  <td>
                     <input type="text" name="ProductName" placeholder="품명" readonly />
                  </td>
                </tr>
            </tbody>
             <table class="item-Standard-table">
               <colgroup>
                 <col style="width: 15%">
                 <col style="width: 15%">
                 <col style="width: 10%">
                 <col style="width: 15%">
                 <col style="width: 15%">
                 <col style="width: 15%">
                 <col style="width: 15%">
                 <col style="width: 4%">
               </colgroup>
               <thead>
               <tr id="itemStandardRow">
                 <th>규격</th>
                 <th>단위</th>
                 <th>수량</th>
                 <th>단가</th>
                 <th>공급가액</th>
                 <th>부가세</th>
                 <th>합계</th>
                 <th>
                   <a class="btn in_btn plus" id="addRemark" title="추가">
                     <img src="/images/icon/ico-plus.svg" alt="등록 아이콘"/>
                   </a>
                 </th>
               </tr>
               </thead>
               <tr class="item-template-row" style="display: none;">
                 <td>
                   <input type="text" style="text-align:center;" name="standard" placeholder="규격"/>
                 </td>
                 <td>
                  <input type="text" style="text-align:center;" name="UnitName" placeholder="단위"/>
                 </td>
                 <td>
                   <input type="text" style="text-align:center;" name="qty" placeholder="수량"/>
                 </td>
                 <td>
                   <input type="text" style="text-align:center;" name="sd_UnitPrice" placeholder="단가"/>
                 </td>
                 <td>
                   <input type="text" style="text-align:center;" name="sd_price" placeholder="공급가액" readonly/>
                 </td>
                 <td>
                   <input type="text" style="text-align:center;" name="sd_vat" placeholder="부가세" readonly/>
                 </td>
                 <td>
                   <input type="text" style="text-align:center;" name="TotalAmount" placeholder="합계" readonly />
                 </td>
                 <td class="al_c item_border">
                   <a class="btn in_btn" title="삭제" onclick="removeItemRow(this)">
                     <img src="/images/icon/ico-delete.svg" alt="삭제 아이콘"/>
                   </a>
                 </td>
               </tr>
             </table>
           </tbody>
         </table>
       </form>
     </div>
     <div class="pt-2">
       <textarea id="upload_message" style='display:none;width:100%;height:150px;'></textarea>
     </div>
   </section>
   <div class="popup-button">
     <button type="button" class="btn-popup y_write_auth" id="btn_standard_save">저장</button>
     <button type="button" class="btn-popup" id="modal-close-button">닫기</button>
   </div>
   </div>
  </script>

</th:block>

<th:block layout:fragment="scripts">
  <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>
  <th:block th:replace="/common/popup_company :: popup_company"></th:block>
  <th:block th:replace="/sales/popup_company_new_save :: popup_company_new_save"></th:block>
  <th:block th:replace="/sales/popup_material_save :: popup_material_new_save"></th:block>
  <th:block th:replace="/sales/print_estimate :: print_estimate"></th:block>
  <script type="text/javascript">

    let isInternalFormatting = false;

    class SujuUploadPage {
      constructor() {
        this.url = '/api/sales/suju';
        this.grid = null;
        this.$btnEdit = $('#btnEdit');
        this.$btnAddNew = $('#btnAddNew');
        this.viewData = new wijmo.collections.CollectionView();
        this.init();

      }

      resetSujuListIndex() {
        this.sujuListIndex = 0;
      }

      nextSujuListIndex() {
        return this.sujuListIndex++;
      }

      init() {
        let _this = this;
        this.grid = new wijmo.grid.FlexGrid('#theGrid', {
          selectionMode: wijmo.grid.SelectionMode.Row,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          formatItem: (sender, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              e.cell.style.textAlign = 'center';
            }
          },
          columns: [
            {binding: 'CompanyName', header: '판매처', width: 190, align: 'left'},
            {binding: 'JumunDate', header: '수주일', width: 120, align: 'center'},
            {binding: 'JumunNumber', header: '수주 번호', width: 150, align: 'center', visible: false},
            {binding: 'product_name', header: '제품명', width: 400},
            {binding: 'TotalPrice', header: '총액', width: 120, align: 'right', format: 'n0'},
            {binding: 'DueDate', header: '납기일', width: 120, align: 'center'},
            {binding: 'StateName', header: '작업상태', width: 100, align: 'center'},
            {binding: 'ShipmentStateName', header: '출하상태', width: 100, align: 'center'},
            {binding: 'SujuTypeName', header: '수주구분', width: 100, align: 'center'},
            {
              binding: 'suju_action',
              header: '견적확정',
              width: 80,
              align: 'center',
              isReadOnly: true
            },
            {binding: 'Description', header: '비고', width: '*'}
          ],
          itemsSource: this.viewData, // 데이터를 설정할 배열
        });

        new FlexGridContextMenu(this.grid);
        this.grid.downloadFileName = '수주 내역';

        _this.grid.formatItem.addHandler(function (s, e) {
          if (e.panel.cellType === wijmo.grid.CellType.Cell) {
            let col = s.columns[e.col];

            if (col.binding === 'suju_action' && userinfo.can_write()) {
              const item = s.rows[e.row]?.dataItem;
              e.cell.innerHTML = '';
              if (String(item?.SujuTypeName ?? '').trim() === '견적') {
                const btn = document.createElement('button');
                btn.className = 'btn-default';
                btn.style.width = '100%';
                btn.style.height = '25px';
                btn.innerText = '확정';
                btn.onclick = function () {
                  _this.selectedIndex = s.rows.findIndex(r => r.dataItem === item);
                  handleOrderClick(_this.selectedIndex, item);
                };
                e.cell.appendChild(btn);
              }
            }

          }
        });

        function handleOrderClick(rowIndex, selectedItem) {

          let data = {
            JumunNumber: selectedItem.JumunNumber,
          };

          Alert.confirm('', '견적을 확정하시겠습니까?', function () {
            _this.makeOrder(data);
          });
        }

        this.grid.hostElement.addEventListener('dblclick', function (e) {
          let items = _this.grid.selectedItems;
          if (items.length === 0) {
            return false;
          }
          _this.$btnEdit.trigger('click');
        });

        let nowDate = CommonUtil.getYYYYMMDD();
        let dueDate = CommonUtil.getYYYYMMDD(10);

        //수주등록 클릭
        this.$btnAddNew.click(function (e) {
          let defaultData = {
            id: '',
            mode: 'new',
            JumunDate: nowDate,
            DueDate: dueDate,
          };
          _this.showSujuForm(defaultData);
        });

        // 수주 수정 클릭
        this.$btnEdit.click(function (e) {
          let selectedItems = _this.grid.selectedItems;
          const it = _this.grid.selectedItems && _this.grid.selectedItems[0];

          if (selectedItems.length === 1) {
            window.selectedGridId = it.id;
            let data = {
              id: selectedItems[0].id,
              action: 'detail'
            };
            let fnsuccess = function (result) {
              result.data['mode'] = 'edit';
              const selected = selectedItems[0];
              // 기본 설정
              if (selected.StateName) {
                result.data['StateName'] = selected.StateName;
              }
              if (selected.State) {
                result.data['State'] = selected.State;
              }

              // 출하 상태가 있다면 덮어쓰기
              if (selected.ShipmentStateName) {
                result.data['StateName'] = selected.ShipmentStateName;
              }
              _this.showSujuForm(result.data);
            };
            AjaxUtil.getAsyncData(_this.url + '/detail', data, fnsuccess);
          } else {
            Alert.alert('', '선택된 데이터가 없습니다.');
          }

        });

        // 삭제 버튼
        $('#btnDelete').click(function (e) {
          let items = _this.grid.selectedItems;
          if (items.length > 0) {
            Alert.confirm('', '삭제하시겠습니까?',
              function () {
                let id = items[0].id;
                let state = items[0].State;
                let ShipmentStateName = items[0].ShipmentStateName;
                _this.deleteSujuData(id, state, ShipmentStateName);
              },
              function () {
              }
            );
          } else {
            Alert.alert('', '삭제할 항목을 선택해주세요.', function () {
              $(this).focus();
            });
          }
        });

        // ====== 유틸 ======
        function toNum(v, d = 0) {
          const n = Number.parseFloat(String(v ?? '').replace(/,/g, ''));
          return Number.isFinite(n) ? n : d;
        }
        function toStr(v, d = '') {
          return (v == null ? d : String(v)).trim();
        }

        // ====== 상세 호출 설정 ======
        const DETAIL_URL = _this.url + '/print_list';
        const buildDetailParams = (row) => ({ id: row.id, _ts: Date.now() }); // 캐시 버스터

        // AjaxUtil → Promise 래핑
        function getDetailAsync(url, data) {
          return new Promise((resolve, reject) => {
            AjaxUtil.getAsyncData(url, data, (res) => resolve(res), (err) => reject(err));
          });
        }

        // 응답 적응 + items 정규화(템플릿 키에 맞춤)
        // - 품목명 꼬리표 " ... 외 N개" 방지(안전 차원 후처리)
        function adaptDetailResponse(resp) {
          const raw  = resp?.data ?? resp ?? {};
          const head = raw.head ?? {};
          const rows = raw.items ?? raw.lines ?? raw.Rows ?? raw.rows ?? [];

          let s = raw.supplier ?? raw.supplierSql ?? {};
          if (Array.isArray(s)) s = s[0] ?? {};

          const supplier = {
            SupplierBizNo:   toStr(s.biz_no   ?? s.saupnum   ?? s.SupplierBizNo   ?? ''),
            SupplierName:    toStr(s.name     ?? s.spjangnm  ?? s.SupplierName    ?? ''),
            SupplierCeo:     toStr(s.ceo      ?? s.prenm     ?? s.RepresentativeName ?? s.supplierceo ?? ''),
            SupplierAddress: toStr(s.address  ?? s.adresa    ?? s.SupplierAddress ?? ''),
            SupplierBizType: toStr(s.biz_type ?? s.biztype   ?? s.SupplierBizType ?? ''),
            SupplierBizItem: toStr(s.biz_item ?? s.item      ?? s.SupplierBizItem ?? ''),
            SupplierTel:     toStr(s.tel      ?? s.tel1      ?? s.SupplierTel     ?? '')
          };


          const items = Array.isArray(rows) ? rows.map(r => ({
            head_id: r.head_id ?? r.HEAD_ID,
            suju_id: r.suju_id ?? r.SUJU_ID,
            product_name: toStr(r.product_name ?? r.ProductName ?? r.PNAME).replace(/\s*외\s*\d+\s*개$/u, ''),
            Standard:     toStr(r.Standard ?? r.Spec ?? r.length ?? r.LEN ?? ''), // 인쇄 보존용 문자열
            Qty:          toNum(r.Qty ?? r.quantity ?? r.QTY),
            UnitName:     toStr(r.UnitName ?? r.Unit ?? r.unit ?? r.unit_name ?? ''),
            UnitPrice:    toNum(r.UnitPrice ?? r.unit_price ?? r.PRICE),
            SupplyAmount: toNum(r.SupplyAmount ?? r.supply_amount ?? r.AMT),
            VatAmount:    toNum(r.VatAmount ?? r.vat_amount ?? r.VAT),
            TotalAmount:  toNum(r.TotalAmount ?? r.total_amount ?? (toNum(r.SupplyAmount) + toNum(r.VatAmount))),
            Description:  toStr(r.Description ?? r.head_description ?? ''),
            SujuQty2:     toNum(r.SujuQty2 ?? r.sujuqty2 ?? r.SUJUQTY2 ?? 0),
          })) : [];

          return { head, items, supplier };
        }

        function buildPrintDataFromRow(row, detail) {
          const head = detail?.head ?? {};
          const date = toStr(head.JumunDate || row.JumunDate || row.ProductionDate || head.DueDate || row.DueDate, '');
          const [y, m, d] = date.includes('-') ? date.split('-') : ['', '', ''];
          const qty       = toNum(head.OrderQty ?? row.OrderQty ?? row.SujuQty);
          const headTotal = toNum(head.TotalPrice ?? row.TotalPrice);
          const note      = toStr(head.Description || row.Description || '').replace(/\r\n?/g, '\n');

          // items 정규화 + 유령행 제거
          const itemsFromDetail = Array.isArray(detail?.items) ? detail.items : [];
          const isPhantom = (it) => {
            const nameEmpty  = toStr(it.product_name) === '';
            const zeros4     = [it.Qty, it.UnitPrice, it.SupplyAmount, it.VatAmount].every(v => toNum(v) === 0);
            const totalZeroOrHead = (toNum(it.TotalAmount) === 0) || (headTotal && toNum(it.TotalAmount) === headTotal);
            return nameEmpty && zeros4 && totalZeroOrHead;
          };
          const finalItems = itemsFromDetail.filter(it => !isPhantom(it));

          // ── 공급자 정보 병합 (head 우선, 없으면 detail.supplier)
          const supSrc = detail?.supplier ?? {};
          const SupplierBizNo   = toStr(head.SupplierBizNo   || supSrc.SupplierBizNo   || '');
          const SupplierName    = toStr(head.SupplierName    || supSrc.SupplierName    || '');
          const SupplierCeo    = toStr(head.SupplierCeo     || supSrc.SupplierCeo     || '');
          const SupplierAddress = toStr(head.SupplierAddress || supSrc.SupplierAddress || '');
          const SupplierBizType = toStr(head.SupplierBizType || supSrc.SupplierBizType || '');
          const SupplierBizItem = toStr(head.SupplierBizItem || supSrc.SupplierBizItem || '');
          const SupplierTel     = toStr(head.SupplierTel     || supSrc.SupplierTel     || '');

          // 템플릿 우측 “거래처 … 귀하” 표시용
          const CustomerName = toStr(
            head.CustomerName || head.CompanyName || row.CustomerName || row.CompanyName || ''
          );

          return {
            // 타이틀 & 날짜
            title: '견 적 서',
            ProductionDate: date,   // 템플릿에서 koDate()로 표시됨
            JumunDate: date,        // 혹시 다른 템플릿에서도 쓰일 수 있어 같이 둠
            DueDate: toStr(head.DueDate || row.DueDate),

            // 상단 우측
            CustomerName,
            CompanyName: toStr(head.CompanyName || row.CompanyName), // 하위 호환

            // 공급자(템플릿이 직접 읽음)
            SupplierBizNo,
            SupplierName,
            SupplierCeo,
            SupplierAddress,
            SupplierBizType,
            SupplierBizItem,
            SupplierTel,

            // 본문
            SuJuOrderName: toStr(head.SuJuOrderName || ''),
            DeliveryName:  toStr(head.DeliveryName || ''),
            WorkcenterName: toStr(head.WorkcenterName || row.WorkcenterName),
            OrderQty: qty,
            ShiftName: toStr(row.ShiftName),
            month: m, day: d, // (현재 템플릿은 사용하지 않지만 유지)
            items: finalItems,
            totalMeter: finalItems.reduce((s, v) => s + toNum(v.Standard, 0), 0),
            SujuQty2: toNum(head.SujuQty2 ?? row.SujuQty2 ?? 0),

            // 합계/메모
            HeadTotalPrice: headTotal,
            JumunNumber: toStr(head.JumunNumber || row.JumunNumber),
            SujuTypeName: toStr(row.SujuTypeName),
            note
          };
        }

        // 1) 유틸: URL → data URI (인쇄 안전)
        async function toDataURL(url) {
          const res = await fetch(url, { cache: 'reload' }); // 캐시 우회
          const blob = await res.blob();
          return await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          });
        }

// 2) 유틸: 문서 내 모든 이미지 로딩 대기
        async function waitImages(doc) {
          const imgs = Array.from(doc.images || []);
          await Promise.all(imgs.map(img => (
            img.complete ? Promise.resolve()
              : new Promise(res => { img.onload = img.onerror = res; })
          )));
        }

// 3) 클릭 핸들러
        $('#btnEstimatePrint').off('click').on('click', async function () {
          const grid = _this.grid;
          const selected = grid?.selectedItems || [];
          if (!selected.length) return Alert.alert('', '출력할 행을 먼저 선택하세요.');

          // ‘견적’만 선택
          const targets = selected.filter(it => toStr(it?.SujuTypeName) === '견적');
          if (!targets.length) return Alert.alert('', '선택한 행 중 견적 건이 없습니다.');

          if (typeof tmpl !== 'function') return Alert.alert('오류', '템플릿 엔진(tmpl)이 로드되지 않았습니다.');
          const TEMPLATE_ID = 'print_estimate';
          if (!document.getElementById(TEMPLATE_ID)) return Alert.alert('오류', `#${TEMPLATE_ID} 템플릿을 찾을 수 없습니다.`);

          // ✅ 직인 이미지 data URI 준비(한 번만)
          const ctx =
            window.APP_CONTEXT_PATH
            || document.querySelector('base')?.getAttribute('href')?.replace(/\/$/, '')
            || '';
          const sealHttpUrl = `${ctx}/images/sample/stamp.png`;

          let sealDataUri = null;
          try {
            sealDataUri = await toDataURL(sealHttpUrl);
          } catch (e) {
            console.warn('직인 dataURI 변환 실패, 원본 URL 사용', e);
            sealDataUri = sealHttpUrl; // 폴백
          }

          // 출력용 HTML 조립
          let allHtml = `
  <html><head><title>견적서 출력</title>
  <style>body{font-family:'Malgun Gothic';margin:20px}
  @media print{.print-page{page-break-after:always}}</style>
  </head><body>`;

          // 상세 병렬 조회
          const responses = await Promise.allSettled(
            targets.map(row => getDetailAsync(DETAIL_URL, buildDetailParams(row)))
          );

          for (let i = 0; i < targets.length; i++) {
            const row = targets[i];
            let detail = { head: {}, items: [] };

            if (responses[i].status === 'fulfilled' && responses[i].value) {
              try { detail = adaptDetailResponse(responses[i].value); }
              catch (e) { console.warn('상세 적응 실패 → 빈 아이템', e); }
            } else {
              console.warn('상세 조회 실패', responses[i].reason);
            }

            const data = buildPrintDataFromRow(row, detail);

            // ✅ 직인 URL 주입 (data에 넣어 템플릿 o.*로 전달)
            if (!data.SupplierSealUrl) data.SupplierSealUrl = sealDataUri;

            // (선택) 품목 없으면 건너뛰기
            if (!data.items || data.items.length === 0) {
              Alert.alert('', '이 견적은 품목이 없습니다. (상세 등록 또는 서버 응답 확인)');
              continue;
            }

            allHtml += `<div class="print-page">${tmpl(TEMPLATE_ID, data)}</div>`;
          }

          allHtml += `</body></html>`;

          // 새 창 열어 출력
          const w = window.open('', '_blank', 'width=850,height=1000');
          if (!w) return Alert.alert('', '팝업이 차단되었습니다. 팝업 허용 후 다시 시도해 주세요.');
          w.document.open(); w.document.write(allHtml); w.document.close();

          // ✅ 인쇄 전: 새 창의 이미지/폰트 로딩 완료 보장
          const doPrint = async () => {
            try { await waitImages(w.document); } catch(e) {}
            if ('fonts' in w.document) {
              try { await w.document.fonts.ready; } catch(e){}
            }
            w.focus();
            w.print();
          };

          if (w.document.readyState === 'complete') {
            w.requestAnimationFrame(() => w.requestAnimationFrame(doPrint));
          } else {
            w.onload = () => w.requestAnimationFrame(() => w.requestAnimationFrame(doPrint));
          }
        });



        // 엔터키 검색
        $('#keyword').on('keypress', function (e) {
          if (e.keyCode === 13) {
            _this.searchMainData();
          }
        });
      }

      makeOrder(data) {
        let _this = this;
        let url = _this.url + '/estimate_confirm';

        let fnsuccess = function (result) {
          if (result.success) {
            Alert.alert('', '견적이 확정 되었습니다.');
            _this.searchMainData();
          }
        };

        AjaxUtil.postAsyncData(url, data, fnsuccess);
      }

      showSujuForm(data) {
        //sujuTemplate
        let _this = this;
        let content = tmpl('sujuTemplate', data);
        let $content = $(content);
        const $root = $content;
        const STD_BTN_SEL = 'a[name="btnStandard"], a#btnStandard[title="상세규격 등록"]';

        let modalContainer = null;
        if (data.mode === 'new') {
          modalContainer = new PopupDraggable('등록');
        } else {
          modalContainer = new PopupDraggable('수정');
        }
        modalContainer.open({width: 1400, height: 600, $content});

        // 제품검색
        let $btnProductSearch = $content.find('#btnProductSearch');
        let $sujuForm = $content.find('#sujuForm');

        let $cboSujuType = $content.find('#cboSujuType');

        if (data.mode === 'new') {
          $btnProductSearch.removeAttr('disabled');
        }
        function getUnitVal($row) {
          const $u = $row.find('input[name="unit"], input[name^="unit_"]');
          return (($u.first().val() || '') + '').trim();
        }

        function isMeter(unit) {
          const v = (unit || '').trim();
          return v === 'M(미터)' || v === 'M' || v.includes('미터');
        }

        function isLocked($row) {
          const raw = (($row.find('input[name^="standard_locked_"], input[name="standard_locked"]').val() || '') + '')
            .trim()
            .toUpperCase();
          return raw === 'Y' || raw === 'TRUE' || raw === '1' || raw === 'ON';
        }

        function refreshStdBtn($row) {
          const unit = getUnitVal($row);
          const showByUnit = isMeter(unit);
          const locked = isLocked($row);
          // console.log('unit=', unit, ' -> showByUnit=', showByUnit, ' locked=', locked);
          $row.find(STD_BTN_SEL).css('display', showByUnit && !locked ? 'inline-flex' : 'none');
        }

        // 초기 렌더된 '버튼 있는' 행만 반영
        $root.on(
          'input change',
          'input[name="unit"], input[name^="unit_"], input[name^="standard_locked_"], input[name="standard_locked"]',
          function () {
            refreshStdBtn($(this).closest('tr'));
          }
        );

        // unit 값 변경(사용자/프로그램 모두) 시 해당 행만 갱신
        $root.on('input change', 'input[name="unit"], input[name^="unit_"]', function () {
          refreshStdBtn($(this).closest('tr'));
        });

        $root.off('click.btnStandard').on('click.btnStandard', STD_BTN_SEL, (e) => {
          e.preventDefault();
          const $row = $(e.currentTarget).closest('tr');
          const productName = ($row.find('input[name^="txtProductName_"]:visible').val() || '').trim();
          const Data = { id:'', mode:'standard', productName, _row:$row };

          const target = (_this && typeof _this.showStandardForm === 'function') ? _this : window;
          if (typeof target.showStandardForm !== 'function') return console.error('showStandardForm not found');
          target.showStandardForm(Data);
        });


        $root.off('click.btnStandard').on('click.btnStandard', '#btnStandard', (e) => {
          e.preventDefault();

          const $row = $(e.currentTarget).closest('tr');
          const productName = ($row.find('input[name^="txtProductName_"]:visible').val() || '').trim();
          const suju_id = ($row.find('input[name^="suju_id"]:visible').val() || '').trim();
          const standard_id = ($row.find('input[name^="standard_id_"]:visible').val() || '').trim();

          const getRowIndex = ($r) => {
            const $any = $r.find('input[name]').first();
            const m = ($any.attr('name') || '').match(/_(\d+)$/);
            return m ? parseInt(m[1], 10) : null;
          };
          const idx = getRowIndex($row);
          const jsonName = (idx != null) ? `standard_detail_json_${idx}` : 'standard_detail_json';
          let localDetails = null;
          try {
            const raw = $row.find(`input[type="hidden"][name="${jsonName}"]`).val();
            if (raw) localDetails = JSON.parse(raw);
          } catch (e) {}

          const Data = {
            id: standard_id,
            suju_id: suju_id,
            mode: 'standard',
            productName,
            _row: $row,
            details: Array.isArray(localDetails) ? localDetails : null
          };

          const target = (_this && typeof _this.showStandardForm === 'function') ? _this : window;
          if (typeof target.showStandardForm !== 'function') {
            console.error('showStandardForm not found');
            return;
          }
          target.showStandardForm(Data);
        });


        $content.find('#btnCompanySearch').click(function () {
          let poppage = new PopCompComponent();
          let $poppage = $(poppage);
          let searchcallback = function (items) {
            $content.find('#cboCompany').val(items.id);
            $content.find('#CompanyName').val(items.compname);

            // if ($Material_id.val() && $cboCompany.val()) {
            //     tryShowPrice();
            // }
          };

          poppage.show(searchcallback);
        });

        $content.find('#btnOrderSearch').click(function () {
          let poppage = new PopCompComponent();
          let $poppage = $(poppage);
          let searchcallback = function (items) {
            $content.find('#SuJuOrderId').val(items.id);
            $content.find('#SuJuOrderName').val(items.compname);

            $content.find('#cboCompany').val(items.id);
            $content.find('#CompanyName').val(items.compname);

            setTimeout(() => {
              const $delivery = $content.find('#DeliveryName');
              if ($delivery.length) {
                $delivery.focus();
                // 커서를 맨 뒤로 이동(선택 범위 = 길이,길이)
                const el = $delivery.get(0);
                if (el && el.setSelectionRange) {
                  const v = $delivery.val() || '';
                  el.setSelectionRange(v.length, v.length);
                }
              } else {
                const $fallback = $('#DeliveryName');
                if ($fallback.length) $fallback.focus();
              }
            }, 120);
          };

          poppage.show(searchcallback);
        });

        //거래처 신규등록 팝업
        $content.on('click', '#plusCompany', function () {
          const popup = new PopCompSaveComponent(); // 필요 시 { saveUrl: '/api/sales/suju/save_Comp' }로 교체
          popup.show({
            onSaved: (saved) => {
              if (typeof window.searchCompanyList === 'function') searchCompanyList();
              if (saved) {
                $content.find('#SuJuOrderId').val(saved.id);
                $content.find('#SuJuOrderName').val(saved.name);

                $content.find('#cboCompany').val(saved.id);
                $content.find('#CompanyName').val(saved.name);

                setTimeout(() => {
                  const $delivery = $content.find('#DeliveryName');
                  if ($delivery.length) {
                    $delivery.focus();
                    // 커서를 맨 뒤로 이동(선택 범위 = 길이,길이)
                    const el = $delivery.get(0);
                    if (el && el.setSelectionRange) {
                      const v = $delivery.val() || '';
                      el.setSelectionRange(v.length, v.length);
                    }
                  } else {
                    const $fallback = $('#DeliveryName');
                    if ($fallback.length) $fallback.focus();
                  }
                }, 120);
              };
            },
            focusAfterClose: this
          });
        });


        // 저장버튼
        let $btnPopSujuSave = $('#btnPopSujuSave');

        //수주구분
        AjaxUtil.fillSelectOptions($cboSujuType, 'system_code', 'choose', 'sales', 'suju_type');

        setTimeout(() => {
          FormUtil.BindDataSujuForm(data, $sujuForm);

          if (data.mode === 'new') {
            // 신규는 기본 해제 + 값도 N으로 맞춰서 extractForm 시 누락 방지
            $content.find('input[type="checkbox"][name^="VatIncluded"]')
                    .prop('checked', false)
                    .val('N')
                    .trigger('change'); // 계산식 즉시 반영
          }else{
            //edit
            let nextElementIndex = data.sujuList.length;

            const $checkbox = $content.find(`input[name="VatIncluded_${nextElementIndex}"]`);
            $checkbox.prop('checked', false).val('N').trigger('change');
          }

          // ✅ 여기: 초기 행 상태 세팅(수정 모드일 때 기존 금액 보존)
          const $rows = $content.find('.item-table tbody tr:visible').not('.item-template-row');
          $rows.each(function () {
            const $r = $(this);
            const hasSupply = !!String($r.find('input[name^="supplyAmount_"]').val() || '').trim();
            const hasVat    = !!String($r.find('input[name^="VatAmount_"]').val()   || '').trim();

            if (data.mode === 'new') {
              calculateAmounts($r, 'unit');
            } else {
              if (hasSupply || hasVat) {
                $r.data('supplyEdited', true);
                $r.data('vatEdited', true);
                // 보기 포맷만
                ['supplyAmount_', 'VatAmount_', 'totalAmount_'].forEach(prefix => {
                  const $inp = $r.find(`input[name^="${prefix}"]`);
                  const n = Number(String($inp.val()||'').replace(/,/g,''));
                  if (Number.isFinite(n)) $inp.val(n ? n.toLocaleString('ko-KR') : '');
                });
              } else {
                calculateAmounts($r, 'unit');
              }
            }
          });

          // (선택) 전체 합계 한 번 계산
          calculateTotalSum($content);

          // 기존 동작 유지: 단위에 따른 버튼/표시 갱신 트리거
          $root.find('input[name="unit"], input[name^="unit_"]').trigger('input');

        }, 100);

        //버튼 조건
        applyEditability(data);

        // if (data.StateName && data.StateName !== '수주') {
        //   $('#btnPopSujuSave').hide();
        //   $('#notUpdate')
        //     .css('margin-top', '10px') // 조건 만족 시 margin-top 적용
        //     .show();
        //   $('.popup-button').css('margin-top', '10px');
        // }

        if (data.SujuQty > 0) {
          $SujuQty.val(data.SujuQty.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
        }


        function canEditSuju(data) {
          const state = String(data?.StateName ?? '').trim();
          const ship  = String(data?.ShipmentStateName ?? '').trim();

          if (ship) return false;                                        // 출하 진행됨 → 수정 불가
          if (!state) return true;                                       // 상태 미지정이면 일단 허용(원하면 false로)
          return ['수주', '지시', '계획'].includes(state);               // 허용 상태만 통과
        }

        function applyEditability(data) {
          const editable = canEditSuju(data);

          if (editable) {
            $('#btnPopSujuSave').show();
            $('#notUpdate').hide();
            $('.popup-button').css('margin-top', '');
          } else {
            $('#btnPopSujuSave').hide();
            // 메시지: 출하상태가 있으면 해당 이유로, 아니면 기존 메시지
            const ship = String(data?.ShipmentStateName ?? '').trim();
            const reason = ship ? '* 출하가 진행된 건은 수정이 불가합니다.'
              : '* 출하가 진행된 수주는 수정이 불가합니다.';
            $('#notUpdate').text(reason).css('margin-top', '10px').show();
            $('.popup-button').css('margin-top', '10px');
          }
        }

        // 수주등록 팝업 저장버튼 클릭
        $btnPopSujuSave.click(function (e) {

          //수주일, 납기일 체크?
          let data = FormUtil.extractForm($sujuForm);
          console.log('데이터 확인:', data);

          if (!$('#SuJuOrderName').val()) {
            Alert.alert('', '수주처를 선택하세요.');
            return;
          }
          if (!$('#DeliveryName').val()) {
            Alert.alert('', '납품처를 입력하세요.');
            return;
          }
          if (!$('#cboCompany').val()) {
            Alert.alert('', '판매처를 선택하세요.');
            return;
          }

          // 2. 각 행의 유효성 체크
          let index = 0;
          while (true) {
            const materialId = data[`Material_id_${index}`];

            if (materialId === undefined) break; // 끝까지 체크

            if (materialId !== null && materialId !== '') {
              const qty = data[`quantity_${index}`];
              const price = data[`unitPrice_${index}`];

              if (!qty) {
                Alert.alert('', `(${index + 1}번째 행) 수량을 입력하세요.`);
                return;
              }
            }

            index++;
          }

          Alert.confirm('', '저장하시겠습니까?', function () {
            const items = [];
            for (let i = 0; i < page.sujuListIndex; i++) {
              const materialId = data[`Material_id_${i}`];
              const normMaterialId = (materialId === '' || materialId == null) ? null : Number(materialId);

              const productName = data[`txtProductName_${i}`];

              //if (!materialId) continue;
              if (!productName) continue;
              // ✅ 상세 JSON 파싱
              let standardDetails = [];
              try {
                const raw = data[`standard_detail_json_${i}`];
                if (raw) standardDetails = JSON.parse(raw);
              } catch(e){ standardDetails = []; }

              items.push({
                suju_id: data[`suju_id_${i}`] || '',
                Material_id: normMaterialId,
                MaterialGroupName: data[`MaterialGroupName_${i}`] || '',
                product_code: data[`product_code_${i}`] || '',
                txtProductName: productName,
                //txtProductName: data[`txtProductName_${i}`] || '',
                quantity: (data[`quantity_${i}`] || '0').replace(/,/g, ''),
                unitPrice: (data[`unitPrice_${i}`] || '0').replace(/,/g, ''),
                supplyAmount: (data[`supplyAmount_${i}`] || '0').replace(/,/g, ''),
                VatAmount: data[`VatAmount_${i}`] === '면세' ? '0' : (data[`VatAmount_${i}`] || '0').replace(/,/g, ''),
                totalAmount: (data[`totalAmount_${i}`] || '0').replace(/,/g, ''),
                description: data[`description_${i}`] || '',
                VatIncluded: data[`VatIncluded_${i}`] === undefined ? 'N' : 'Y',
                projectHidden: data[`projectHidden_${i}`] || '',
                unitPriceChanged: (() => {
                  const ori = parseFloat(data[`originalUnitPrice_${i}`] || '0');
                  const cur = parseFloat((data[`unitPrice_${i}`] || '0').replace(/,/g, ''));
                  return ori !== cur;
                })(),
                standard: data[`standard_${i}`] || '',
                standardDetails: standardDetails
              });
            }


            // 공통 정보 + 리스트 전송
            const payload = {
              id: data.id,
              JumunDate: data.JumunDate,
              DueDate: data.DueDate,
              Company_id: data.Company_id,
              CompanyName: data.CompanyName,
              SujuType: data.SujuType,
              spjangcd: data.spjangcd,
              totalAmountSum: data.totalAmountSum,
              Description: data.Description,
              order_id: data.SuJuOrderId,
              OrderName: data.SuJuOrderName,
              DeliveryName: data.DeliveryName,
              EstimateMemo : data.EstimateMemo,
              items: items
            };

            AjaxUtil.postJsonData(_this.url + '/manual_save', payload, function (res) {
              if (res.success) {
                Notify.success("저장되었습니다.");
                _this.searchMainData();
                modalContainer.close();
              } else {
                Alert.alert('저장 실패', res.message || '알 수 없는 오류');
              }
            });
          });
        });

        // 단가 정보 가져오기
        function tryShowPrice($row) {
          const mat_pk = $row.find('input[name^="Material_id_"]').val();
          const company_id = $content.find('#cboCompany').val();
          const JumunDate = $content.find('#JumunDate').val();
          const SujuQty = parseFloat($row.find('input[name^="quantity"]').val().replace(/,/g, '') || '0');

          let url = _this.url + '/readPriceSuju';
          let data = {
            'mat_pk': mat_pk,
            'company_id': company_id,
            'JumunDate': JumunDate
          };

          if (mat_pk && company_id && JumunDate) {

            let fnsuccess = function (result) {

              let unitPrice = 0;
              if (result != null && result.data && result.data.length > 0) {
                unitPrice = parseFloat(result.data[0].UnitPrice);
                $row.find('input[name^="unitPrice_"]').val(unitPrice.toLocaleString());
                $row.find('input[name^="originalUnitPrice_"]').val(unitPrice.toLocaleString());

              } else {
                $row.find('input[name^="unitPrice"]').val('0');
                $row.find('input[name^="originalUnitPrice"]').val('0');
              }
              // unitType이 비어있으면 unit_에서 보정(EA/M만)
              if (!$row.data('unitType')) {
                const unitNameRaw = ($row.find('input[name^="unit_"]').val() || '')
                  .toString().trim().toUpperCase();
                $row.data('unitType', unitNameRaw.startsWith('M') ? 'M' : 'EA');
              }

              // ✅ 단가 반영 직후, 분기 계산 강제
              calculateAmounts($row, 'unit');
            };

            AjaxUtil.getAsyncData(url, data, fnsuccess);
          }
        }

        // 빈 값은 항상 숫자 0으로 처리
        function getNumericValue($input, def = 0, allowNegative = false) {
          if ($input.length === 0) return def;
          let raw = (($input.val() || '') + '');
          // 허용 문자만 남기기
          raw = raw.replace(allowNegative ? /[^0-9.\-]/g : /[^0-9.]/g, '').trim();
          if (allowNegative) {
            // 선행 '-' 하나만 허용, 그 외 '-' 제거
            raw = raw.replace(/(?!^)-/g, '');
          }
          if (raw === '' || raw === '-' || raw === '.') return def;
          const n = parseFloat(raw);
          return Number.isFinite(n) ? n : def;
        }


        function isAdjustmentRow($row) {
          const code = (($row.find('input[name^="product_code_"]').val() ?? '') + '').trim();
          return code === ''; // 상품코드 비어있으면 단수정리 행
        }

        let isInternalFormatting = false;

        function calculateAmounts($row, source = null) {
          if (isInternalFormatting) return;
          isInternalFormatting = true;
          try {
            const quantity  = getNumericValue($row.find('input[name^="quantity_"]'), 0);
            const unitPrice = getNumericValue($row.find('input[name^="unitPrice_"]'), 0);

            // 단가 입력 유무(빈칸이거나 NaN이면 자동계산 금지)
            const unitPriceRaw = String($row.find('input[name^="unitPrice_"]').val() || '').replace(/,/g, '');
            const hasUnitPrice = unitPriceRaw !== '' && !isNaN(Number(unitPriceRaw));

            const $standard = $row.find('input[type="text"][name^="standard_"]');
            const standardRaw    = (($standard.val() ?? '') + '').trim();
            const standardNumStr = standardRaw.replace(/,/g, '');
            const isStandardNumeric = standardNumStr !== '' && /^\d+(\.\d+)?$/.test(standardNumStr);
            const standardNum = isStandardNumeric ? parseFloat(standardNumStr) : 0;

            const baseQty    = Number.isFinite(quantity) ? quantity : 0;
            const qtyForCalc = isStandardNumeric ? (standardNum * baseQty) : baseQty;

            const isVatIncluded = $row.find('input[name^="VatIncluded_"]').is(':checked');
            const isVatExempt   = false;

            let supplyAmount     = getNumericValue($row.find('input[name^="supplyAmount_"]'), 0);
            let vatAmount        = getNumericValue($row.find('input[name^="VatAmount_"]'), 0);
            const isSupplyEdited = $row.data('supplyEdited') === true;
            const isVatEdited    = $row.data('vatEdited') === true;

            const adjustment = isAdjustmentRow($row);

            // 단가 없으면 자동계산 금지
            const shouldAuto = !adjustment && hasUnitPrice && ((source === 'unit') || (!isSupplyEdited && !isVatEdited));

            if (adjustment) {
              let supplyAmount = getNumericValue($row.find('input[name^="supplyAmount_"]'), 0, true); // 음수 허용
              // (정책상 단수정리 필요하면 여기서 Math.floor 등 적용)
              $row.find('input[name^="VatAmount_"]').val(''); // VAT=0 표기
              $row.find('input[name^="totalAmount_"]').val(
                supplyAmount === 0 ? '' : supplyAmount.toLocaleString('ko-KR')
              );
              calculateTotalSum($content);
              return; // 조정행은 여기서 종료(일반 자동계산 덮어쓰기 방지)
            }

            if (shouldAuto) {
              const lineTotal = qtyForCalc * unitPrice;

              if (isVatExempt) {
                supplyAmount = lineTotal;
                vatAmount    = 0;
              } else if (isVatIncluded) {
                supplyAmount = Math.round(lineTotal / 1.1);
                vatAmount    = lineTotal - supplyAmount;
              } else {
                supplyAmount = lineTotal;
                vatAmount    = Math.floor(supplyAmount * 0.1);
              }

              if (!isSupplyEdited) {
                $row.find('input[name^="supplyAmount_"]').val(supplyAmount === 0 ? '' : supplyAmount.toLocaleString());
              }
              if (!isVatEdited) {
                $row.find('input[name^="VatAmount_"]').val(isVatExempt ? '면세' : (vatAmount === 0 ? '' : vatAmount.toLocaleString()));
              }
            } else if (!hasUnitPrice && !adjustment && !isSupplyEdited && !isVatEdited) {

            }
            // 합계(표시용)
            const sNum = getNumericValue($row.find('input[name^="supplyAmount_"]'), 0);
            const vNum = getNumericValue($row.find('input[name^="VatAmount_"]'), 0);
            const autoSum = sNum + vNum;

            $row.find('input[name^="totalAmount_"]').val(autoSum === 0 ? '' : autoSum.toLocaleString('ko-KR') );

            // 표기 포맷
            $row.find('input[name^="quantity_"]').val(quantity  === 0 ? '' : quantity.toLocaleString());
            $row.find('input[name^="unitPrice_"]').val(unitPrice === 0 ? '' : unitPrice.toLocaleString());

            calculateTotalSum($content);
          } finally {
            isInternalFormatting = false;
          }
        }


        // 총합 계산(부모 폼 헤더 반영) — 통합 버전
        function calculateTotalSum($scope) {
          const $root = $scope && $scope.length ? $scope : $('#sujuForm');

          let sum = 0;
          $root.find('.item-table tr:visible').each(function () {
            const $row = $(this);
            const $totalInput =
              $row.find('input[name="totalAmount"]').first().length
                ? $row.find('input[name="totalAmount"]').first()
                : $row.find('input[name^="totalAmount_"]').first();
            if (!$totalInput.length) return;

            const raw = String($totalInput.val() || '').replace(/,/g, '').trim();
            if (raw === '' || raw === '-' || raw === '.') return;

            const n = parseFloat(raw);
            if (Number.isFinite(n)) sum += n;
          });

          const $target = $root.find('#totalAmountSum').first().length
            ? $root.find('#totalAmountSum').first()
            : $('#totalAmountSum');

          $target.val(sum !== 0 ? Number(sum).toLocaleString() : '');
        }

        // 수량/단가 입력 시
        $content.on('input', 'input[name^="quantity_"], input[name^="unitPrice_"]', function () {
          const $row = $(this).closest('tr');
          $row.removeData('supplyEdited');
          $row.removeData('vatEdited');
          calculateAmounts($row, 'unit');
        });

        // 공급가 입력
        $content.on('input', 'input[name^="supplyAmount_"]', function () {
          const $row = $(this).closest('tr');
          $row.data('supplyEdited', true);
          calculateAmounts($row);
        });

        // 세액 입력
        $content.on('input', 'input[name^="VatAmount_"]', function () {
          const $row = $(this).closest('tr');
          $row.data('vatEdited', true);
          calculateAmounts($row);
        });

        // 합계 직접 입력 시 총합 계산
        $content.on('input', 'input[name^="totalAmount_"]', function () {
          calculateTotalSum($content);
        });

        // 부가세 체크 변경
        $content.on('change', 'input[name^="VatIncluded_"]', function () {
          const $row = $(this).closest('tr');
          $(this).val(this.checked ? 'Y' : 'N');
          $row.removeData('supplyEdited');
          $row.removeData('vatEdited');
          calculateAmounts($row, 'unit');
        });

        // 표준 변경 시 즉시 재계산
        $content.on('input change', 'input[name^="standard_"]', function () {
          const $row = $(this).closest('tr');
          calculateAmounts($row, 'unit'); // ← 'standard-change' 말고 'unit'으로
        });

        // 숫자 포맷 (input 중 formatting) - 소수점/천단위 지원
        // 1) 입력 중: 포맷(천단위)만, 소수 고정 금지
        $content.off('input.numfmt')
          .on('input.numfmt',
            'input[name^="quantity_"], input[name^="unitPrice_"],' +
            ' input[name^="supplyAmount_"], input[name^="VatAmount_"],' +
            ' input[name^="totalAmount_"]',
            function (e) {
              if (isInternalFormatting) return;
              if (e.originalEvent && e.originalEvent.isComposing) return;

              isInternalFormatting = true;
              const input = this;
              const $this = $(this);
              const name  = input.name || '';
              const $row  = $this.closest('tr');

              // 커서 보정
              const prevLen = input.value.length;
              const cursorPos = input.selectionStart;
              const rightRemain = prevLen - cursorPos;

              // ── supplyAmount_ 전용: 조정 행일 때만 '-' 허용 ──
              if (name.startsWith('supplyAmount_')) {
                const adjustment = isAdjustmentRow($row);
                let raw = String($this.val() || '').replace(/,/g, '');

                // 조정행만 '-' 허용, 소수점은 불허(정수)
                raw = raw.replace(adjustment ? /[^0-9\-]/g : /[^0-9]/g, '');
                if (adjustment) raw = raw.replace(/(?!^)-/g, ''); // 선행 '-' 하나만 허용

                if (raw === '' || raw === '-') { isInternalFormatting = false; return; }
                const num = Number(raw);
                if (!isFinite(num)) { isInternalFormatting = false; return; }

                const formatted = num.toLocaleString('ko-KR');
                $this.val(formatted);

                const newLen = formatted.length;
                const pos = Math.max(0, newLen - rightRemain);
                input.setSelectionRange(pos, pos);
                isInternalFormatting = false;
                return;
              }

              // ── totalAmount_ 전용: 조정 행일 때만 '-' 허용 ──
              if (name.startsWith('totalAmount_')) {
                const adjustment = isAdjustmentRow($row);
                let raw = String($this.val() || '').replace(/,/g, '');
                raw = raw.replace(adjustment ? /[^0-9.\-]/g : /[^0-9.]/g, '');
                if (adjustment) raw = raw.replace(/(?!^)-/g, ''); // 선행 '-' 하나만
                // 점 하나만
                raw = raw.replace(/\.(?=.*\.)/g, '');
                if (raw === '' || raw === '-' || raw === '.') { isInternalFormatting = false; return; }
                const num = Number(raw);
                if (!isFinite(num)) { isInternalFormatting = false; return; }
                const formatted = num.toLocaleString('ko-KR');
                $this.val(formatted);

                const newLen = formatted.length;
                const pos = Math.max(0, newLen - rightRemain);
                input.setSelectionRange(pos, pos);
                isInternalFormatting = false;
                return;
              }

              // ── 이하 기존 로직(수량 소수1자리, 그 외 정수) ──
              let allowDecimal = false;
              let decimals = 0;
              if (name.startsWith('quantity_')) { allowDecimal = true; decimals = 2; }

              let raw = String($this.val() || '').replace(/,/g, '');

              if (allowDecimal) {
                raw = raw.replace(/[^0-9.]/g, '').replace(/\.(?=.*\.)/g, '');
                if (raw === '' || raw === '.') { $this.val(''); isInternalFormatting = false; return; }
                const hasDot = raw.includes('.');
                let [intPart, fracPart = ''] = raw.split('.');
                intPart = intPart.replace(/^0+(?=\d)/, '');
                if (fracPart.length > decimals) fracPart = fracPart.slice(0, decimals);
                const intFormatted = (intPart === '' ? '0' : String(Number(intPart))).toLocaleString('ko-KR');
                const formatted = hasDot ? `${intFormatted}.${fracPart}` : intFormatted;
                $this.val(formatted);
                const newLen = formatted.length;
                const pos = Math.max(0, newLen - rightRemain);
                input.setSelectionRange(pos, pos);
              } else {
                raw = raw.replace(/[^0-9]/g, '');
                if (raw === '') { $this.val(''); isInternalFormatting = false; return; }
                const formatted = Number(raw).toLocaleString('ko-KR');
                $this.val(formatted);
                const newLen = formatted.length;
                const pos = Math.max(0, newLen - rightRemain);
                input.setSelectionRange(pos, pos);
              }

              isInternalFormatting = false;
            }
          );

        // 블러 시: totalAmount_는 조정 행에서 음수 유지
        $content.off('blur.numfmt')
          .on('blur.numfmt',
            'input[name^="quantity_"], input[name^="unitPrice_"], ' +
            'input[name^="supplyAmount_"], input[name^="VatAmount_"], ' +
            'input[name^="totalAmount_"]',
            function () {
              const $this = $(this);
              const name = this.name || '';
              const $row = $this.closest('tr');
              let v = String($this.val() || '').replace(/,/g, '');
              if (!v) return;

              if (name.startsWith('supplyAmount_')) {
                const adjustment = isAdjustmentRow($row);
                v = v.replace(/,/g, '');
                v = v.replace(adjustment ? /[^0-9\-]/g : /[^0-9]/g, '');
                if (adjustment) v = v.replace(/(?!^)-/g, '');
                if (v === '' || v === '-') { $this.val(''); return; }

                const num = Number(v);
                if (!isFinite(num)) { $this.val(''); return; }

                // 필요 시 여기서 단수정리(절사/반올림) 수행
                // num = Math.floor(num); // 정책에 맞게

                $this.val(num.toLocaleString('ko-KR'));

                // 조정행이면 공급가 수동편집 플래그 세우고 재계산(VAT=0 정책이라면 calculateAmounts에서 처리)
                if (adjustment) {
                  $row.data('supplyEdited', true);
                  $row.removeData('vatEdited');
                  calculateAmounts($row);
                }
                return;
              }

              //  totalAmount_ 분기 대체
              if (name.startsWith('totalAmount_')) {
                const adjustment = isAdjustmentRow($row);

                // 숫자 정리(+ 조정행은 음수 허용)
                v = v.replace(adjustment ? /[^0-9.\-]/g : /[^0-9.]/g, '');
                if (adjustment) v = v.replace(/(?!^)-/g, '');
                v = v.replace(/\.(?=.*\.)/g, '');
                if (v === '' || v === '-' || v === '.') { $this.val(''); return; }

                const num = Number(v);
                if (!isFinite(num)) { $this.val(''); return; }

                if (adjustment) {
                  // ✅ 합계 입력값을 '공급가액'으로 이관
                  const $sup = $row.find('input[name^="supplyAmount_"]');
                  $sup.val(num ? Number(num).toLocaleString('ko-KR') : '');

                  // 부가세는 단수정리 행에서는 0으로(관례) —— 필요 시 정책으로 바꾸세요.
                  $row.find('input[name^="VatAmount_"]').val('');
                  $row.data('supplyEdited', true);
                  $row.removeData('vatEdited');

                  // 합계는 supply+vat로 자동 반영
                  calculateAmounts($row);
                  return; // total은 사용자가 직접 넣는 필드가 아님
                }

                // 일반행: 기존 포맷만 유지
                $this.val(num.toLocaleString('ko-KR'));
                return;
              }

              // quantity_ 블러 처리 (소수 2자리)
              if (name.startsWith('quantity_')) {
                v = v.replace(/[^0-9.]/g, '').replace(/\.(?=.*\.)/g, '');
                if (v === '' || v === '.') { $this.val(''); return; }
                let num = Number(v);
                if (!isFinite(num)) { $this.val(''); return; }

                // ⬇ 여기만 1→2자리로
                num = Math.round(num * 100) / 100;

                const parts = String(num).split('.');
                const intStr = Number(parts[0]).toLocaleString('ko-KR');

                if (parts.length === 1 || Number(parts[1]) === 0) {
                  $this.val(intStr);
                } else {
                  // 최대 2자리, 뒤의 0은 제거
                  const frac = (parts[1] + '00').slice(0, 2).replace(/0+$/, '');
                  $this.val(frac ? `${intStr}.${frac}` : intStr);
                }
              } else {
                const iv = v.replace(/[^0-9]/g, '');
                if (iv === '') { $this.val(''); return; }
                $this.val(Number(iv).toLocaleString('ko-KR'));
              }
            }
          );

        $content.off('change.productCodeGuard')
          .on('change.productCodeGuard', 'input[name^="product_code_"]', function () {
            const $row = $(this).closest('tr');
            const code = (this.value ?? '').toString().trim();
            if (code !== '') {
              // totalAmount_에서 음수 제거 후 재계산
              const $tot = $row.find('input[name^="totalAmount_"]');
              const cleaned = (($tot.val() ?? '') + '').replace(/,/g, '').replace(/-/g, '');
              $tot.val(cleaned ? Number(cleaned).toLocaleString('ko-KR') : '');
              // 일반 모드 강제 재계산
              $row.removeData('supplyEdited');
              $row.removeData('vatEdited');
              calculateAmounts($row, 'unit');
            }
          });

        // 검색 버튼 클릭 시 팝업
        $content.on('click', 'a[title="품목 신규등록"]', function () {
          //현재 클릭한 버튼이 속한 행을 기준 컨텍스트로 사용
          const $row = $(this).closest('tr');

          const pop = new PopMatSaveComponent();
          pop.show({
            onSaved: (saved) => {
              if (typeof window.searchMatList === 'function') searchMatList();
              if (!saved) return;

              //prefix로 찾는 헬퍼 (보이는 텍스트/셀렉트만 타겟)
              const setByPrefix = (prefix, val) => {
                const $target = $row.find(
                  `input[type="text"][name^="${prefix}"]:visible,
                     textarea[name^="${prefix}"]:visible,
                     select[name^="${prefix}"]:visible`
                ).first();

                if ($target.length) {
                  $target.val(val ?? '').trigger('input').trigger('change');
                } else {
                  // 숨김 필드만 있는 경우 대비해 한 번 더 시도(텍스트 우선)
                  const $fallback = $row.find(`[name^="${prefix}"]`).filter(':input').first();
                  if ($fallback.length) {
                    $fallback.val(val ?? '').trigger('input').trigger('change');
                  } else {
                    console.warn(`No target found for prefix: ${prefix}`);
                  }
                }
              };

              setByPrefix('product_code_',   saved.Code);
              setByPrefix('Material_id_',    saved.id);
              setByPrefix('txtProductName_', saved.name);
              setByPrefix('standard_',       saved.standard);
              setByPrefix('unit_',       saved.unit_name);

              // 읽기전용 토글
              const $std = $row.find('input[type="text"][name^="standard_"]:visible').first();
              const hasStd = !!(saved.standard && String(saved.standard).trim().length);
              if ($std.length) $std.prop('readonly', hasStd);
            },

            // 포커스 복귀
            focusAfterClose: this
          });
        });

        $content.on('keydown', 'input[name^="txtProductName_"]', function (e) {
          if (e.key !== 'Enter' && e.keyCode !== 13) return;

          e.preventDefault();

          const $field = $(this);
          const $row = $field.closest('tr');

          const $productInput = $row.find('input[name^="txtProductName_"]');
          const $productId = $row.find('input[name^="Material_id_"]');
          const $productCode = $row.find('input[name^="product_code_"]');
          const $Standard = $row.find('input[name^="standard_"]');
          const $standard_locked = $row.find('input[name^="standard_locked_"]');
          const $unit_name = $row.find('input[name^="unit_"]');

          const keyword = $field.val().trim();
          const pop = new PopMatComponent();
          pop.material_type = 'product,sangpum';

          const callback = function (item) {
            $productId.val(item.id || '');
            $productInput.val(item.Name || '');
            $productCode.val(item.Code || '');
            $unit_name.val(item.unit_name || '').trigger('input');
            $Standard.val(item.Spec || '');
            if (item.Spec && item.Spec.trim() !== '') {
              $standard_locked.val('Y').trigger('change');
            } else {
              $standard_locked.val('').trigger('change');
            }

            tryShowPrice($row);
          };

          if (!keyword) {
            pop.focusAfterClose = $field[0];
            pop.show(callback);
            return;
          }

          const data = {
            keyword: keyword,
            spjangcd: sessionStorage.getItem('spjangcd')
          };

          const result = AjaxUtil.getSyncData('/api/popup/search_material', data);
          const rows = result?.data || [];

          if (rows.length === 1) {
            callback(rows[0]);
          } else {
            pop.show(callback);
            setTimeout(() => {
              pop.$keyword.val(keyword);
              pop.$btnMaterialSearch.trigger('click');
            }, 50);
          }
        });

        // 품목명 지우면 코드들도 같이 지워지게
        $content.on('input', 'input[name^="txtProductName_"]', function () {
          const $field = $(this);
          const $row = $field.closest('tr');

          const $productId = $row.find('input[name^="Material_id_"]');
          const $productCode = $row.find('input[name^="product_code_"]');
          const $Standard = $row.find('input[name^="standard_"]');
          const $standard_locked = $row.find('input[name^="standard_locked_"]');
          const $unit_name = $row.find('input[name^="unit_"]');

          if ($field.val().trim() === '') {
            // 값이 비었을 경우 연관된 필드 초기화
            $productId.val('');
            $productCode.val('');
            $Standard.val('');
            $unit_name.val('');
            $standard_locked.val('').trigger('change');
            $Standard.prop('readonly', false);
          }
        });

        $content.find('#addRemark').click(function () {
          const $tbody = $content.find('.item-table tbody');
          const $template = $tbody.find('.item-template-row');

          for (let i = 0; i < 3; i++) {
            const $newRow = $template.clone().removeClass('item-template-row').show();
            const index = page.nextSujuListIndex();
            $newRow.find('input').each(function () {
              const baseName = $(this).attr('name');
              if (baseName) {
                $(this).attr('name', `${baseName}_${index}`);
              }
            });

            $newRow.find('a[title="삭제"]').attr('id', `btnDelItem_${index}`);
            $tbody.append($newRow);
          }
        });

        // 포커스 자동 이동: Enter + 방향키(←→↑↓)
        $content.on('keydown', 'input', function (e) {
          const key = e.key;

          if (!['Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(key)) return;
          e.preventDefault();

          const $input = $(this);
          const $row = $input.closest('tr');
          const nameAttr = $input.attr('name') || '';

          const focusOrder = [
            'txtProductName_',
            'standard_',
            'quantity_',
            'unitPrice_',
            'supplyAmount_',
            'VatAmount_',
            'totalAmount_',
            'project_',
            'description_',
          ];

          const currentIndex = focusOrder.findIndex(prefix => nameAttr.startsWith(prefix));
          if (currentIndex === -1) return;

          let $nextInput = null;

          // ↔️ 좌우 이동
          if (key === 'ArrowRight' && currentIndex < focusOrder.length - 1) {
            const nextPrefix = focusOrder[currentIndex + 1];
            $nextInput = $row.find(`input[name^="${nextPrefix}"]`);
          } else if (key === 'ArrowLeft' && currentIndex > 0) {
            const prevPrefix = focusOrder[currentIndex - 1];
            $nextInput = $row.find(`input[name^="${prevPrefix}"]`);
          }

          // ↕️ 상하 이동
          if (key === 'ArrowDown' || key === 'ArrowUp') {
            const $targetRow = key === 'ArrowDown'
              ? $row.nextAll('tr:visible').first()
              : $row.prevAll('tr:visible').first();

            const allowAutoAdd = ['txtProductName_', 'description_'];
            const isAllowedField = allowAutoAdd.some(prefix => nameAttr.startsWith(prefix));

            // ⬇️ 방향키 + 현재 행이 마지막 + 허용된 필드일 경우 → 행 자동 추가
            if (key === 'ArrowDown' && !$targetRow.length && isAllowedField) {
              $content.find('#addRemark').trigger('click');

              setTimeout(() => {
                const $rows = $content.find('.item-table tbody tr:visible').not('.item-template-row');
                const $newRow = $rows.last();
                const $newInput = $newRow.find('input[name^="txtProductName_"]');
                if ($newInput.length) $newInput.focus().select();
              }, 50);
              return;
            }
            // 일반 상하 이동
            $nextInput = $targetRow.find(`input[name^="${focusOrder[currentIndex]}"]`);
          }

          // ↵ Enter 키: 현재 행 내 다음 필드
          if (key === 'Enter' && currentIndex < focusOrder.length - 1) {
            const nextPrefix = focusOrder[currentIndex + 1];
            $nextInput = $row.find(`input[name^="${nextPrefix}"]`);
          } else if (key === 'Enter' && nameAttr.startsWith('description_')) {
            const $nextRow = $row.nextAll('tr:visible').first();
            if (!$nextRow.length) {
              //console.log('다음 행 없음. 행 자동 추가 트리거.');
              $content.find('#addRemark').trigger('click');

              setTimeout(() => {
                const $rows = $content.find('.item-table tbody tr:visible').not('.item-template-row');
                const $newRow = $rows.last();
                const $newInput = $newRow.find('input[name^="txtProductName_"]');
                if ($newInput.length) $newInput.focus().select();
              }, 50);
              return;
            } else {
              $nextInput = $nextRow.find('input[name^="txtProductName_"]');
            }
          }

          if ($nextInput && $nextInput.length) {
            $nextInput.focus().select();
          }
        });

      }

      // 규격/수량 등록
      showStandardForm(Data){
        const _this = this;
        const html = tmpl('StandardTemplate', Data);
        const $popup = $(html);
        const modal = new PopupDraggable('규격/수량 입력');
        modal.open({ width: 900, height: 400, $content: $popup });

        $popup.find('input[name="ProductName"]').val(Data.productName || '');
        $popup.find('input[name="unit"]').val(Data.unit || '');

        //행 추가 함수 (표준행 표시용 클래스 부여)
        const addRow = () => {
          const $table = $popup.find('.item-Standard-table');
          const $tpl   = $table.find('.item-template-row').first();
          const $row   = $tpl.clone(true, true)
            .removeClass('item-template-row')
            .addClass('std-row')
            .show();
          $table.append($row);
          return $row;
        };
        function isMeter(unit) {
          const v = (unit || '').trim();
          return v === 'M(미터)' || v === 'M' || v.includes('미터');
        }

        function isUnitMeter(unit) {
          const v = (unit || '').toString().trim();
          return v === 'M(미터)' || v === 'M' || v.includes('미터');
        }

        function num(v) {
          const s = (v == null ? '' : String(v)).replace(/,/g,'').trim();
          const n = parseFloat(s);
          return Number.isFinite(n) ? n : 0;
        }
        function fmt(n) {
          const x = num(n);
          return x ? x.toLocaleString() : '';
        }
        function formatMoneyRow($r) {
          $r.find('input[name="sd_UnitPrice"]').val(fmt($r.find('input[name="sd_UnitPrice"]').val()));
          $r.find('input[name="sd_price"]').val(fmt($r.find('input[name="sd_price"]').val()));
          $r.find('input[name="sd_vat"]').val(fmt($r.find('input[name="sd_vat"]').val()));
          $r.find('input[name="TotalAmount"]').val(fmt($r.find('input[name="TotalAmount"]').val()));
        }
        function formatAllMoney($root) {
          $root.find('.item-Standard-table tr.std-row').each(function () {
            formatMoneyRow($(this));
          });
        }
        //서버/신규 데이터 → UI 채우기
        function setRows(details){
          // 기존 표준행 제거
         $popup.find('.item-Standard-table tr.std-row').remove();

          const list = (details || []); // 최대 3행
          if (list.length === 0) {
            // 신규: 기본 2행
            addRow(); addRow();
            return;
          }

          list.forEach(d => {
            const $r = addRow();
            $r.find('input[name="standard"]').val(d.Standard ?? d.standard ?? '' );
            $r.find('input[name="qty"]').val(d.Qty ?? d.qty ?? '' );
            $r.find('input[name="UnitName"]').val(d.UnitName ?? d.unit ?? d.unitName ?? d.Unit ?? '' );
            $r.find('input[name="sd_UnitPrice"]').val(d.sd_UnitPrice ?? d.UnitPrice ?? d.unitPrice ?? '' );
            $r.find('input[name="sd_price"]').val(d.sd_price ?? d.Price ?? d.price ?? '' );
            $r.find('input[name="sd_vat"]').val(d.sd_vat ?? d.Vat ?? d.vat ?? '' );
            $r.find('input[name="TotalAmount"]').val(d.TotalAmount ?? '' );
            // ✅ 이 행만 즉시 포맷
            formatMoneyRow($r);
          });

          // 최소 2행 보장
          if ($popup.find('.item-Standard-table tr.std-row').length === 1) addRow();

          formatAllMoney($popup);
        }

        // suju_id 추출 (Data 또는 부모행 입력에서)
        const $parentRow = Data._row;
        let sujuId = 0;
        if (Data.suju_id) sujuId = parseInt(Data.suju_id, 10) || 0;
        else if ($parentRow && $parentRow.length) {
          sujuId = parseInt(($parentRow.find('input[name^="suju_id_"]').val() || '0'), 10) || 0;
        }

        // 1) 호출자가 전달한 로컬 초안(details) 우선
        if (Array.isArray(Data.details) && Data.details.length > 0) {
          setRows(Data.details);
        } else {
          // 2) 부모행 히든 JSON 시도
          const idx = getRowIndex($parentRow); // 아래에 선언된 함수(호이스팅으로 사용 가능)
          const jsonName = (idx != null) ? `standard_detail_json_${idx}` : 'standard_detail_json';

          let localParsed = null;
          try {
            const raw = $parentRow.find(`input[type="hidden"][name="${jsonName}"]`).val();
            if (raw) {
              const arr = JSON.parse(raw);
              if (Array.isArray(arr) && arr.length > 0) localParsed = arr;
            }
          } catch(e) { /* ignore */ }

          if (localParsed) {
            setRows(localParsed);
          } else if (sujuId > 0) {
            // 3) 서버 조회
            $.getJSON('/api/sales/suju/detail_list', { sujuId })
              .done(res => {
                const rows = (res && (res.data || res.rows)) || [];
                setRows(rows);
              })
              .fail(err => {
                console.error('detail_list load error', err);
                setRows([]); // 실패 시 기본 2행
              });
          } else {
            // 4) 신규 기본
            setRows([]);
          }
        }

        //버튼
        $popup.on('click', '#addRemark', function(e){
          e.preventDefault();
          addRow();
        });

        // 🗑 최소 2행 유지
        $popup.on('click', 'a[title="삭제"]', function(e){
          e.preventDefault();
          const $table = $popup.find('.item-Standard-table');
          const $rows  = $table.find('tr.std-row');
          const $targetRow = $(this).closest('tr.std-row');

          if ($rows.length <= 2) {
            $targetRow.find('input[type="text"], input[type="number"]').val('');
            $targetRow.find('input[type="hidden"]').val('');
            return;
          }
          $targetRow.remove();
        });

        // 🔎 유틸
        function getRowIndex($row){
          const names = $row.find('input[name]').map((i,el)=>el.name).get();
          for (const n of names) {
            const m = n.match(/_(\d+)$/);
            if (m) return parseInt(m[1], 10);
          }
          return null;
        }
        function upsertHidden($row, name, value){
          const $cell = $row.find('td').last();
          let $hid = $cell.find(`input[type="hidden"][name="${name}"]`);
          if ($hid.length) $hid.val(value);
          else $('<input>', {type:'hidden', name, value}).appendTo($cell);
        }

        function attachStdNav($root, addRow) {
          // 1) 열 정의(이 순서대로 좌/우/엔터 이동)
          const COLS = ['standard', 'UnitName', 'qty','sd_UnitPrice' ];  //'sd_price', 'sd_vat','TotalAmount'

          // 2) selector 생성 (오타/불필요 쉼표 제거)
          const selector = COLS.map(n => `.item-Standard-table tr.std-row input[name="${n}"]`).join(', ');

          // 중복 바인딩 방지
          $root.off('keydown.stdNav').on('keydown.stdNav', selector, function (e) {
            const key = e.key;
            if (!['Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(key)) return;

            const el = /** @type {HTMLInputElement} */(e.target);
            const $input = $(el);

            const $rows = $root.find('.item-Standard-table tr.std-row');
            const $row  = $input.closest('tr.std-row');
            const rowIdx = $rows.index($row);

            const name = $input.attr('name') || '';
            const colIdx = COLS.indexOf(name);
            if (colIdx < 0) return;

            const atStart = el.selectionStart === 0;
            const atEnd   = el.selectionEnd === el.value.length;

            const moveFocus = (nextRowIdx, nextColIdx) => {
              while (nextRowIdx >= $root.find('.item-Standard-table tr.std-row').length) {
                addRow();
              }
              const $r = $root.find('.item-Standard-table tr.std-row').eq(nextRowIdx);
              const $c = $r.find(`input[name="${COLS[nextColIdx]}"]`);
              if ($c.length) $c.focus().select();
            };

            // Enter: 다음 칼럼, 마지막이면 다음 행 첫 칼럼
            if (key === 'Enter') {
              e.preventDefault();
              const nextCol = colIdx + 1;
              if (nextCol < COLS.length) moveFocus(rowIdx, nextCol);
              else moveFocus(rowIdx + 1, 0);
              return;
            }

            // ▶ ArrowRight: 마지막 칼럼이면 다음 행 첫 칼럼(standard)로 래핑
            if (key === 'ArrowRight' && atEnd) {
              e.preventDefault();
              if (colIdx === COLS.length - 1) {
                // 마지막 칼럼 → 다음 행의 첫 칼럼
                moveFocus(rowIdx + 1, 0);
              } else {
                moveFocus(rowIdx, colIdx + 1);
              }
              return;
            }

            // ◀ ArrowLeft: (옵션) 첫 칼럼에서 이전 행의 마지막 칼럼로 래핑
            if (key === 'ArrowLeft' && atStart) {
              e.preventDefault();
              if (colIdx === 0) {
                const prevRow = Math.max(0, rowIdx - 1);
                moveFocus(prevRow, COLS.length - 1);
              } else {
                moveFocus(rowIdx, colIdx - 1);
              }
              return;
            }

            if (key === 'ArrowDown') {
              e.preventDefault();
              moveFocus(rowIdx + 1, colIdx);
              return;
            }

            if (key === 'ArrowUp') {
              e.preventDefault();
              moveFocus(Math.max(0, rowIdx - 1), colIdx);
              return;
            }
          });

          // (선택) 계산 자동화: qty/단가 변경 시 공급가액/부가세 갱신
          $root.off('input.stdCalc').on('input.stdCalc',
            '.item-Standard-table tr.std-row input[name="qty"], ' +
            '.item-Standard-table tr.std-row input[name="sd_UnitPrice"]',
            function () {
              const $r = $(this).closest('tr.std-row');
              const qty  = parseFloat(($r.find('input[name="qty"]').val() || '').toString().replace(/,/g,'')) || 0;
              const unit = parseFloat(($r.find('input[name="sd_UnitPrice"]').val() || '').toString().replace(/,/g,'')) || 0;
              const price = Math.round(qty * unit);  // 공급가액
              const vat   = Math.round(price * 0.1); // 부가세(10%)
              const total = price + vat;
              $r.find('input[name="sd_price"]').val(price.toLocaleString());
              $r.find('input[name="sd_vat"]').val(vat.toLocaleString());
              $r.find('input[name="TotalAmount"]').val(total.toLocaleString());

              // 행 계산 후 합계 갱신
              updateTotals($root);
            }
          );

          // 별도 포맷 핸들러
          $root
            .off('focus.stdFmt blur.stdFmt')
            .on('focus.stdFmt',
              '.item-Standard-table tr.std-row input[name="sd_UnitPrice"], ' +
              '.item-Standard-table tr.std-row input[name="sd_price"], ' +
              '.item-Standard-table tr.std-row input[name="sd_vat"]',
              function () {
                this.value = (this.value || '').replace(/,/g, ''); // 편집 전 콤마 제거
              }
            )
            .on('blur.stdFmt',
              '.item-Standard-table tr.std-row input[name="sd_UnitPrice"],' +
              ' .item-Standard-table tr.std-row input[name="sd_price"], ' +
              '.item-Standard-table tr.std-row input[name="sd_vat"]',
              function () {
                const raw = (this.value || '').replace(/,/g, '');
                const n = parseFloat(raw);
                this.value = Number.isFinite(n) ? n.toLocaleString() : '';

                // 포맷 후에도 계산/합계 반영 보장
                $(this).trigger('input');
                updateTotals($root);
              }
            );
        }

        attachStdNav($popup, addRow);
        // 저장: 합계 바인딩 + 상세 JSON 부모행에 보관
        $popup.off('click.btnStdSave')
          .on('click.btnStdSave', '#btn_standard_save', function () {
            const toNum = v => {
              if (v == null) return 0;
              const n = parseFloat(String(v).replace(/,/g, ''));
              return Number.isFinite(n) ? n : 0;
            };

            // 1) 행 수집
            const toStr = v => (v == null ? '' : String(v)).trim();
            const rows = [];
            $popup.find('.item-Standard-table tr.std-row').each(function () {
              const $r = $(this);

              const standard      = toStr($r.find('input[name="standard"]').val());
              const UnitName      = toStr($r.find('input[name="UnitName"]').val());
              const qtyStr        = toStr($r.find('input[name="qty"]').val());
              const unitPriceStr  = toStr($r.find('input[name="sd_UnitPrice"]').val()).replace(/,/g,'');
              const priceStr      = toStr($r.find('input[name="sd_price"]').val()).replace(/,/g,'');
              const vatStr        = toStr($r.find('input[name="sd_vat"]').val()).replace(/,/g,'');
              const totalStr      = toStr($r.find('input[name="TotalAmount"]').val()).replace(/,/g,'');

              // 숫자 변환
              const qty       = parseFloat(qtyStr)       || 0;
              const unitPrice = parseFloat(unitPriceStr) || 0;
              let   price     = parseFloat(priceStr);
              let   vat       = parseFloat(vatStr);
              let   total     = parseFloat(totalStr);

              // 금액 보정(누락 시 계산)
              const VAT_RATE = 0.1; // 필요시 변경
              if (!Number.isFinite(price)) price = Math.round(qty * unitPrice);
              if (!Number.isFinite(vat))   vat   = Math.round(price * VAT_RATE);
              if (!Number.isFinite(total)) total = price + vat;

              // 완전 빈 행은 제외(규격/수량 모두 비었으면 스킵)
              if (standard !== '' || qtyStr !== '') {
                rows.push({
                  standard,
                  UnitName,
                  qty: qtyStr,                     // 원문 문자열 보존(필요 시 qty로 바꿔도 됨)
                  sd_UnitPrice: String(unitPrice), // 콤마 제거된 원시값
                  sd_price:     String(price),
                  sd_vat:       String(vat),
                  TotalAmount:  String(total)
                });
              }
            });

            // 2) 합계 계산
            const num = v => {
              const s = (v == null ? '' : String(v)).replace(/,/g, '').trim();
              if (s === '' || s === '-' || s === '.') return 0;
              const n = Number(s);
              return Number.isFinite(n) ? n : 0;
            }

            const sumStd  = rows.reduce((a, r) => a + num(r.standard), 0);               // Σ 규격
            const sumQty  = rows.reduce((a, r) => a + num(r.qty), 0);                     // Σ 수량
            const sumMul  = rows.reduce((a, r) => a + num(r.standard) * num(r.qty), 0);   // Σ(규격×수량)

            // 3) 부모행 타깃(standard_0 / quantity_0 우선)
            const $qty0 = $parentRow.find('input[type="text"][name="quantity_0"]:visible');
            const $std0 = $parentRow.find('input[type="text"][name="standard_0"]:visible');

            let $qtyTarget = $qty0.length
              ? $qty0
              : $parentRow.find('input[type="text"][name^="quantity_"]:visible').first()
                .add($parentRow.find('input[name="quantity"]').first()).first();

            let $stdTarget = $std0.length
              ? $std0
              : $parentRow.find('input[type="text"][name^="standard_"]:visible').first()
                .add($parentRow.find('input[name="standard"]').first()).first();

            // 4) 단위에 따라 값 세팅
            const unitVal =
              (Data.unit || '').trim() ||
              ($parentRow.find('input[name="UnitName"], input[name="unit"], input[name^="unit_"]').first().val() || '').trim();

            const unitIsMeter = isUnitMeter(unitVal);

            // 규격이 숫자인 행이 하나라도 있는지 (숫자면 '장'이어도 총길이로 처리)
            const hasNumericStandard = rows.some(r => {
              const s = String(r.standard ?? '').replace(/,/g, '').trim();
              return /^\d+(\.\d+)?$/.test(s);
            });

            // 총길이 사용 여부
            const useTotalLength = unitIsMeter || hasNumericStandard;

            // 수량 채우기 (총길이: Σ(규격×수량), 아니면 Σ수량)
            if ($qtyTarget.length) {
              const v = useTotalLength ? sumMul : sumQty;
              $qtyTarget.val(v ? v.toFixed(2) : '').trigger('input').trigger('change');
            }

          // 규격 표시 라벨
            const stdList   = rows.map(r => (r.standard || '').trim()).filter(s => s !== '');
            const firstStd  = stdList[0] || '';
            const restCount = Math.max(0, stdList.length - 1);

            const stdLabel  = unitIsMeter
              ? '총(M)'
              : (firstStd ? (restCount > 0 ? `${firstStd} 외 ${restCount}개` : firstStd) : '');

            if ($stdTarget.length) {
              $stdTarget.val(stdLabel).trigger('input').trigger('change');
            }

            // 수량: 미터면 총길이(Σ 규격×수량), 아니면 Σ수량
            if ($qtyTarget.length) {
              const v = isMeter ? sumMul : sumQty;
              $qtyTarget.val(v.toFixed(2)).trigger('input').trigger('change');
            }

            // 5) 상세 JSON 저장
            const idx = getRowIndex($parentRow);
            const jsonName = (idx != null) ? `standard_detail_json_${idx}` : 'standard_detail_json';
            upsertHidden($parentRow, jsonName, JSON.stringify(rows));

            // 5-1) 부모행 금액 반영(공급/부가세/합계)
            (() => {
              const sumSupply = rows.reduce((a, r) => a + num(r.sd_price), 0);
              const sumVat    = rows.reduce((a, r) => a + num(r.sd_vat),   0);
              const sumTotal  = sumSupply + sumVat;

              const findAny = (base) => $parentRow.find(`input[name="${base}"], input[name^="${base}_"]`).first();
              const $supply = findAny('supplyAmount');
              const $vat    = findAny('VatAmount');
              const $total  = findAny('totalAmount');

              if ($supply.length) $supply.val(sumSupply ? sumSupply.toLocaleString() : '').trigger('input').trigger('change');
              if ($vat.length)    $vat.val(sumVat ? sumVat.toLocaleString() : '').trigger('input').trigger('change');
              if ($total.length)  $total.val(sumTotal ? sumTotal.toLocaleString() : '').trigger('input').trigger('change');

              upsertHidden($parentRow, 'standard_popup_total_supply', String(sumSupply));
              upsertHidden($parentRow, 'standard_popup_total_vat',    String(sumVat));
              upsertHidden($parentRow, 'standard_popup_total_amount', String(sumTotal));

              if (typeof calculateTotalSum === 'function') {
                calculateTotalSum($('#sujuForm'));
              }
            })();

            modal.close?.();
        });

        // 닫기
        $popup.on('click', '#modal-close-button', function(){ modal.close(); });
      }


      deleteSujuData(id, state, ShipmentStateName) {
        let _this = this;
        let url = _this.url + '/delete';
        let data = {'id': id, 'State': state, 'ShipmentStateName': ShipmentStateName}
        let fnsuccess = function (res) {
          if (res.success) {
            Notify.success('삭제되었습니다.');
            _this.searchMainData();
          } else {
            Alert.alert('', res.message);
          }
        };

        AjaxUtil.postAsyncData(url, data, fnsuccess);
      }

      // exportExcel() {
      //     var targetview = this.grid;
      //     targetview.exportExcel('수주내역.xls');
      // }

      searchMainData() {
        let _this = this;
        let start = $('#srchStartDt').val();
        let end = $('#srchEndDt').val();
        let url = this.url + '/read';

        let data = {
          'start': start,
          'end': end,
          'action': 'read'
        };

        let fnsuccess = function (result) {
          if (result != null) {
            _this.viewData.sourceCollection = result.data;

            if (window.selectedGridId) {
              GridUtil.selectRowById(_this.grid, window.selectedGridId);
              window.selectedGridId = null;
            }
          }
        };
        AjaxUtil.getAsyncData(url, data, fnsuccess);

      }

      // 엑셀 업로드 버튼
      showPopupExcelUpload(data) {
        let _this = this;
        let content = tmpl('excelUploadTemplate', data);
        let $content = $(content);
        $content.find('#data_date').val(data.data_date);
        $content.find('#day_index').val(data.day_index);

        //팝업공통모듈
        let modalContainer = new PopupDraggable('엑셀 업로드');
        modalContainer.open({width: 440, height: 220, $content});


        $content.find('#btn_excel_save').on('click', function () {
          let $form = $content.find('#excelUploadForm');
          Alert.confirm('',
            '저장하시겠습니까?',
            function () {
              _this.saveSujuBulkData($form, modalContainer);
              //modalContainer.close();
            },
            function () {
            }
          );
        });
      }

      // 엑셀 업로드 저장
      saveSujuBulkData($form, modalContainer) {
        let _this = this;
        var form = $('#excelUploadForm')[0];
        var formData = new FormData(form);

        formData['data_date'] = $('#srchStartDt').val();
        formData.append("uploadfile", $('#upload_file')[0].files[0].name);

        let result = AjaxUtil.postFileSyncData(_this.url + '/upload_save', formData);

        if (result) {
          let message = '저장되었습니다.';
          if (result.success) {
            Notify.success(message);
            _this.searchMainData();
            modalContainer.close();
          } else {

            Alert.alert('', result.message);

            /*let $divMessage = modalContainer.$content.find('#upload_message');
            $divMessage.text(JSON.stringify(result.error_items));
            $divMessage.show();*/
          }
        }

      }

      downloadExcelForm() {
        let _this = this;
        //let url = '/api/files/mes_form?action=suju_upload';
        let fileName = "수주업로드양식.xlsx";
        let url = '/api/files/mes_form?file_name=' + fileName;
        /*
        let data = {
            //'tableName' : tableName,
            'file_name': "수주업로드양식.xlsx",
        };
        */
        AjaxUtil.downloadFile(url, fileName);
      }

    }

    // ===== 합계 집계 (규격/수량 팝업) =====
    function updateTotals($root) {
      // 금액 합계 계산
      let sumPrice = 0; // 공급가액 합계
      let sumVat   = 0; // 부가세 합계

      $root.find('.item-Standard-table tr.std-row').each(function () {
        const p = parseFloat(($(this).find('input[name="sd_price"]').val() || '').replace(/,/g,'')) || 0;
        const v = parseFloat(($(this).find('input[name="sd_vat"]').val()   || '').replace(/,/g,'')) || 0;
        sumPrice += p;
        sumVat   += v;
      });

      const total = sumPrice + sumVat;

      // 1) 표시용 영역이 있으면 채우기 (선택: 없으면 무시됨)
      // 예: <span id="total_price"></span> / <span id="total_vat"></span> / <span id="total_amount"></span>
      const fmt = n => Number(n).toLocaleString();
      $root.find('#total_price').text(fmt(sumPrice));
      $root.find('#total_vat').text(fmt(sumVat));
      $root.find('#total_amount').text(fmt(total));

      // 2) 히든 값으로도 보관 (서버 전송/부모행 반영용)
      // name="TotalAmount" 히든 인풋을 팝업 내에 유지 (콤마 없는 원시값)
      let $hid = $root.find('input[type="hidden"][name="TotalAmount"]');
      if ($hid.length) $hid.val(String(total));
      else $('<input>', { type: 'hidden', name: 'TotalAmount', value: String(total) }).appendTo($root);

      // (선택) 공급가/부가세 히든도 원하면 유지
      let $hidP = $root.find('input[type="hidden"][name="TotalSupplyPrice"]');
      if ($hidP.length) $hidP.val(String(sumPrice));
      else $('<input>', { type: 'hidden', name: 'TotalSupplyPrice', value: String(sumPrice) }).appendTo($root);

      let $hidV = $root.find('input[type="hidden"][name="TotalVat"]');
      if ($hidV.length) $hidV.val(String(sumVat));
      else $('<input>', { type: 'hidden', name: 'TotalVat', value: String(sumVat) }).appendTo($root);
    }

    //행 삭제 함수
    function removeItemRow(el) {
      const $tbody = $(el).closest('tbody');
      const $rows = $tbody.find('tr:not(.item-template-row)');
      const $targetRow = $(el).closest('tr');

      if ($rows.length <= 3) {
        // 입력값이 있으면 초기화만 하고 리턴
        const hasData = $targetRow.find('input[type="text"], input[type="number"]').filter(function () {
          return $(this).val().trim() !== '';
        }).length > 0;

        if (hasData) {
          $targetRow.find('input[type="text"], input[type="number"]').val('');
          // hidden 값도 초기화하고 싶다면 아래 추가
          $targetRow.find('input[type="hidden"]').val('');
        }

        return;
      }

      // 4개 이상이면 정상 삭제
      $targetRow.remove();
    }

    // other-page.js
    $(document).on('click', '.js-open-tab', function (e) {
      e.preventDefault();
      const id    = $(this).data('objid');
      const title = $(this).data('title') || id;
      const url   = $(this).attr('menuurl') || ('/gui/' + id + '/default');

      // index 창(부모 프레임/최상위 창)에 함수가 있으면 호출
      if (window.top && typeof window.top.openTabInMain === 'function') {
        window.top.openTabInMain({ id, title, url });
      } else if (window.opener && typeof window.opener.openTabInMain === 'function') {
        // 팝업으로 열린 경우
        window.opener.openTabInMain({ id, title, url });
      } else {
        Alert.alert('','메인 탭 컨테이너를 찾을 수 없습니다.');
      }
    });

    $('#balju_order_move').on('click', function (e) {
      e.preventDefault();
      const id = 'wm_balju_order';
      const title = '발주등록';
      const url = '/gui/wm_balju_order/default';

      if (window.top && typeof window.top.openTabInMain === 'function') {
        window.top.openTabInMain({ id, title, url });
      } else if (window.opener && typeof window.opener.openTabInMain === 'function') {
        window.opener.openTabInMain({ id, title, url });
      } else {
        Alert.alert('','메인 탭 컨테이너를 찾을 수 없습니다.');
      }
    });

    $('#balju_optimal_stock_move').on('click', function (e) {
      e.preventDefault();
      const id = 'wm_balju_optimal_stock';
      const title = '수주량대비 적정재고현황';
      const url = '/gui/wm_balju_optimal_stock/default';

      if (window.top && typeof window.top.openTabInMain === 'function') {
        window.top.openTabInMain({ id, title, url });
      } else if (window.opener && typeof window.opener.openTabInMain === 'function') {
        window.opener.openTabInMain({ id, title, url });
      } else {
        Alert.alert('','메인 탭 컨테이너를 찾을 수 없습니다.');
      }
    });

    $('#cash_io_move').on('click', function (e) {
      e.preventDefault();
      const id = 'wm_transaction_input';
      const title = '입출금 입력';
      const url = '/gui/wm_transaction_input/default';

      if (window.top && typeof window.top.openTabInMain === 'function') {
        window.top.openTabInMain({ id, title, url });
      } else if (window.opener && typeof window.opener.openTabInMain === 'function') {
        window.opener.openTabInMain({ id, title, url });
      } else {
        Alert.alert('','메인 탭 컨테이너를 찾을 수 없습니다.');
      }
    });

    $('#sales_invoice_move').on('click', function (e) {
      e.preventDefault();
      const id = 'wm_sales_invoice';
      const title = '매출 계산서 관리';
      const url = '/gui/wm_sales_invoice/default';

      if (window.top && typeof window.top.openTabInMain === 'function') {
        window.top.openTabInMain({ id, title, url });
      } else if (window.opener && typeof window.opener.openTabInMain === 'function') {
        window.opener.openTabInMain({ id, title, url });
      } else {
        Alert.alert('','메인 탭 컨테이너를 찾을 수 없습니다.');
      }
    });

    let page = null;

    $(document).ready(function (e) {

      page = new SujuUploadPage();


      $('#srchStartDt').val(CommonUtil.getYYYYMMDD(-7));
      $('#srchEndDt').val(CommonUtil.getYYYYMMDD());

      page.searchMainData();


      // 검색
      $('#btnSearch').click(function (e) {
        page.searchMainData();
      });

      // 양식 다운로드
      $('#btnDownloadTemplate').click(function (e) {
        page.downloadExcelForm();
      });

      // 엑셀 업로드 버튼
      $('#btnShowUpload').click(function (e) {
        let data = {
          'id': '',
          'data_date': CommonUtil.getYYYYMMDD(),
        };
        page.showPopupExcelUpload(data);
      });

    })
  </script>
</th:block>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>