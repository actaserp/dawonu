<html layout:decorate="~{layout_page}">
<head>
  <style>
      #matListTb input, #matListTb textarea {
          width: 100px;
          height: 40px;
      }

  </style>
</head>
<th:block layout:fragment="content">

  <div class="layout-contents">
    <div class="page-title-wrap">
      <div class="left">
        <h2>ìˆ˜ì£¼ ë° ê³„íšëŸ‰ ë“±ë¡</h2>
        <a title="ë¶ë§ˆí¬" class="bookmark toggle">
          ë‚´ ë©”ë‰´
        </a>
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
        <li>ì˜ì—… ê´€ë¦¬</li>
        <li>ìˆ˜ì£¼ ë° ê³„íšëŸ‰ ë“±ë¡</li>
      </ul>
    </div>

    <section class="section">
      <div class="section-top">
        <div class="search-wrap">
          <dl>
            <dt>
              <label for="cboDateKind">
                ê²€ìƒ‰ êµ¬ë¶„<span class="eq"></span>
              </label>
            </dt>
            <dd>
              <div class="srch-box">
                <select id="cboDateKind" name="cboDateKind">
                  <option value="sales">ìˆ˜ì£¼ì¼</option>
                  <option value="delivery">ë‚©ê¸°ì¼</option>
                </select>
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              ì¡°íšŒê¸°ê°„<span class="eq">*</span>
            </dt>
            <dd>
              <ul class="date-box">
                <li>
                  <input type="date" id="srchStartDt" name="srchStartDt">
                  <label for="srchStartDt" class="hide">ì‹œì‘ì¼</label>
                </li>
                <li>
                  <input type="date" id="srchEndDt" name="srchEndDt">
                  <label for="srchEndDt" class="hide">ì¢…ë£Œì¼</label>
                </li>
              </ul>
            </dd>
          </dl>

          <dl>
            <dt>&nbsp;</dt>
            <dd>
              <li>
                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                  <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                  <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                  ê²€ìƒ‰
                </a>
              </li>
            </dd>
          </dl>
        </div>
        <div class="button-wrap">
          <ul>
            <li>
              <a class="btn btn-excell" title="ë“±ë¡" id="btnAddNew">
                <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜">
                ë“±ë¡
              </a>
            </li>
            <li>
              <a class="btn btn-delete" title="ì‚­ì œ" id="btnDelete">
                <img src="/images/icon/ico-delete.svg" alt="ì‚­ì œ ì•„ì´ì½˜">
                ì‚­ì œ
              </a>
            </li>
            <li>
              <a class="btn btn-edit" title="ìˆ˜ì •" id="btnEdit">
                <img src="/images/icon/ico-edit.svg" alt="ìˆ˜ì • ì•„ì´ì½˜">
                ìˆ˜ì •
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div class="container-fluid">
        <div id="theGrid" style="height: 730px;"></div>
      </div>
      <!--        <div class="grid_box">-->

      <!--            <div class="h-640" data-ax5grid="sujuGrid" ></div>-->
      <!--        </div>-->
    </section>
  </div>
  <script type="text/x-tmpl" id="sujuTemplate">
    <style>
      .write-table th {
        width: auto;
      }
      /* ì•„ì´í…œ í…Œì´ë¸” ì „ì²´ ì„¤ì • */
      .item-table {
          width: 100%;
          border-collapse: collapse;
          table-layout: fixed;
          margin-top: 10px;
      }

      /* í—¤ë” ì…€ ìŠ¤íƒ€ì¼ */
      .item-table th {
          background-color: #EDEFF5;
          text-align: center;
          font-weight: bold;
          padding: 8px;
          border: 1px solid #ccc;
      }

      /* ë°”ë”” ì…€ ìŠ¤íƒ€ì¼ */
      .item-table td {
          padding: 6px;
          text-align: center;
          border: 1px solid #ccc;
      }

      /* ì…ë ¥ í•„ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
      .item-table input {
          width: 100%;
          box-sizing: border-box;
          padding: 4px;
      }

      /* í’ˆëª© & ë¹„ê³  ì™¼ìª½ ì •ë ¬ */
      .item-table td:first-child,
      .item-table td:nth-child(6) {
          text-align: left;
      }

      /* ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      .item-table .btn.in_btn {
          display: inline-flex;
          justify-content: center;
          align-items: center;
          width: 32px;
          height: 32px;
          border-radius: 4px;
          padding: 0;
          border: 1px solid #B3B3B3;
          background-color: #fff;
          cursor: pointer;
          transition: background-color 0.2s;
          line-height: 0;
      }

      /* + ë²„íŠ¼ ì „ìš© ìŠ¤íƒ€ì¼ */
      .item-table .btn.in_btn.plus img {
          width: 10px;
          height: 10px;
          display: block;
      }

      /* ê³µí†µ ì•„ì´ì½˜ ë²„íŠ¼ ì´ë¯¸ì§€ (ì‚­ì œ, ê²€ìƒ‰ í¬í•¨) */
      .item-table .btn.in_btn img {
          width: 12px;
          height: 12px;
          display: block;
          margin-right: 5px;
      }

      .input-with-button {
          display: flex;
          gap: 4px; /* ë²„íŠ¼ê³¼ input ì‚¬ì´ ì—¬ë°± */
          align-items: center;
      }

      .input-with-button input {
          flex: 1; /* ë‚˜ë¨¸ì§€ ì˜ì—­ ì°¨ì§€ */
          min-width: 0;
          padding: 4px;
      }

      .input-with-button .btn.in_btn {
          flex-shrink: 0;
      }

      .content_wrap.popup {
          display: flex;
          flex-direction: column;
          height: 100%;
      }

      .table-wrap {
          flex: 1;
          overflow-y: auto;
          padding-right: 5px;
      }

      .popup-button {
          flex-shrink: 0;
          padding: 10px;
          background: #fff;
          border-top: 1px solid #ddd;
      }

      .input-with-checkbox {
          display: flex;
          align-items: center;
          gap: 6px;
      }

      .input-with-checkbox input[type="number"] {
          flex: 1;
          min-width: 0;
          padding: 4px;
      }

      .input-with-checkbox input[type="checkbox"] {
          flex-shrink: 0;
          width: 18px;
          height: 18px;
      }
      #plusCompany{
          display: inline-flex;
          justify-content: center;
          align-items: center;
          width: 32px;
          height: 32px;
          border-radius: 4px;
          padding: 0;
          border: 1px solid #B3B3B3;
          background-color: #fff;
          cursor: pointer;
          transition: background-color 0.2s;
          line-height: 0;
      }
      #plusCompany > img{
         width: 12px;
         height: 12px;
         display: block;
         margin-right: 5px;
      }
    </style>
    <div class="content_wrap popup" id="div_excel_upload">
        <div class="table-wrap">
        <form id="sujuForm">
            <table class="write-table">
                <caption>ì£¼ë¬¸ë“±ë¡ í…Œì´ë¸”</caption>
                <input type="hidden" id="id" name="id">
                <tbody>
                    <tr>
                        <th style="text-align: center">
                            <label for="JumunDate">ìˆ˜ì£¼ì¼<span class="eq">*</span></label>
                        </th>
                        <td>
                            <input type="date" id="JumunDate" name="JumunDate">
                        </td>
                        <th style="text-align: center">
                            <label for="DueDate">ë‚©ê¸°ì¼<span class="eq">*</span></label>
                        </th>
                        <td>
                            <input type="date" id="DueDate" name="DueDate">
                        </td>
                    </tr>
                    <tr>
                       <th style="text-align: center">
                           <label for="cboCompany">íŒë§¤ì²˜<span class="eq">*</span></label>
                        </th>
                        <td >
                            <input id="cboCompany" name="Company_id" type="hidden">
                            <input class="form-control2" type="text" id="CompanyName" name="CompanyName"
                            placeholder="íŒë§¤ì²˜ ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ íŒë§¤ì²˜ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”" readonly/>
                            &nbsp;
                            <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnCompanySearch">
                                <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                íŒë§¤ì²˜ ê²€ìƒ‰
                            </a>
                            <a class="btn in_btn plus" id="plusCompany" title="ê±°ë˜ì²˜ë“±ë¡">
                                <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜" />
                            </a>
                        </td>
                        <th style="text-align: center">
                            <label for="cboSujuType">ìˆ˜ì£¼êµ¬ë¶„</label>
                        </th>
                        <td colspan="3">
                            <select id="cboSujuType" name="SujuType"></select>
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="Description">ë¹„ê³ </label>
                        </th>
                        <td colspan="5">
                            <textarea id="Description" name="Description" style="height:80px;"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label for="StateName">ìƒíƒœ</label>
                        </th>
                        <td>
                            <input type="text" id="StateName" name="StateName" readonly disabled>
                        </td>
                        <th style="text-align: center">
                            <label for="totalAmountSum">ì´ì•¡</label>
                        </th>
                        <td>
                            <input id="totalAmountSum" name="totalAmountSum" style="text-align:right;" readonly>
                        </td>
                    </tr>
                </tbody>
            </table>
            <table class="item-table">
                <table class="item-table">
                <colgroup>
                    <col style="width: 6%">
                    <col style="width: 20%">
                    <col style="width: 6%">
                    <col style="width: 11%">
                    <col style="width: 6%">
                    <col style="width: 13%">
                    <col style="width: 9%">
                    <col style="width: 9%">
                    <col style="width: 9%">
                    <col style="width: 11%">
                    <col style="width: 4%">
                </colgroup>
                <thead>
                <tr id="itemHeaderRow">
                    <th>ì½”ë“œ</th>
                    <th>í’ˆëª©</th>
                    <th>ë‹¨ìœ„</th>
                    <th>ê·œê²©</th>
                    <th>ìˆ˜ëŸ‰</th>
                    <th>ë‹¨ê°€ <span style="font-size: 13px;">(ì„ íƒì‹œ ë¶€ê°€ì„¸ í¬í•¨)</span></th>
                    <th>ê³µê¸‰ê°€ì•¡</th>
                    <th>ë¶€ê°€ì„¸</th>
                    <th>í•©ê³„</th>
                    <th>ë¹„ê³ </th>
                    <th>
                        <a class="btn in_btn plus" id="addRemark" title="ì¶”ê°€">
                            <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜" />
                        </a>
                    </th>
                </tr>
                </thead>
                <tr class="item-template-row" style="display: none;">
                    <td>
                        <input type="text" style="text-align:center;" name="product_code" placeholder="ì½”ë“œ" readonly/>
                    </td>
                    <td>
                        <div class="input-with-button">
                            <input type="hidden" name="suju_id" />
                            <input type="text" name="txtProductName" placeholder="ì½”ë“œ ë˜ëŠ” í’ˆëª… ì…ë ¥ í›„ ì—”í„°" autocomplete="off" />
                            <input type="hidden" name="MaterialGroupName" />
                            <input type="hidden" name="Material_id" />
                            <input type="hidden" name="standard_locked">
                            <a class="btn in_btn" title="í’ˆëª© ì‹ ê·œë“±ë¡" id="btnProductSave">
                                <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜" />
                            </a>
                        </div>
                    </td>
                    <td><input type="text" style="text-align:center;" name="unit" placeholder="ë‹¨ìœ„" readonly/></td>
                    <td>
                      <div class="input-with-button">
                        <input type="hidden" id = "standard_id" name="standard_id" />
                        <input type="text" style="text-align:center;" name="standard" placeholder="ê·œê²©" />
                        <a class="btn in_btn" title="ìƒì„¸ê·œê²© ë“±ë¡" id="btnStandard" name="btnStandard" style="display: none;" >
                            <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜" />
                        </a>
                      </div>
                    </td>
                    <td><input type="text" style="text-align:right;" name="quantity" placeholder="ìˆ˜ëŸ‰" /></td>
                    <td>
                        <div class="input-with-checkbox">
                            <input style="text-align:right;" type="text" name="unitPrice" placeholder="ë‹¨ê°€" />
                            <input type="hidden" name="originalUnitPrice" />
                            <input type="checkbox" name="VatIncluded" />
                        </div>
                    </td>
                    <td><input type="text" style="text-align:right;" name="supplyAmount" placeholder="ê³µê¸‰ê°€ì•¡" /></td>
                    <td><input type="text" style="text-align:right;" name="VatAmount" placeholder="ë¶€ê³¼ì„¸"/></td>
                    <td><input type="text" style="text-align:right;" name="totalAmount" placeholder="í•©ê³„" /></td>
                    <td><input type="text" name="description" placeholder="ë¹„ê³ " /></td>
                    <td class="al_c item_border">
                        <a class="btn in_btn" title="ì‚­ì œ" onclick="removeItemRow(this)">
                            <img src="/images/icon/ico-delete.svg" alt="ì‚­ì œ ì•„ì´ì½˜" />
                        </a>
                    </td>
                </tr>
                </tbody>
            </table>
        </form>
        </div>
        <div id="notUpdate" style="display:none;">*ê³„íš ë˜ëŠ” ì¶œí•˜ê°€ ì§„í–‰ëœ ìˆ˜ì£¼ëŠ” ìˆ˜ì •ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.</div>
        <div class="popup-button">
                <button type="button" class="btn-popup y_write_auth" id="btnPopSujuSave">ì €ì¥</button>
                <button type="button" class="btn-popup" id="modal-close-button">ë‹«ê¸°</button>
        </div>
    </div>
  </script>

  <script type="text/x-tmpl" id="excelUploadTemplate">
    <div class="content_wrap popup" id="div_excel_upload">

        <div class="table-wrap">
            <form id="excelUploadForm">
            <table class="write-table">
                <colgroup>
                    <col style="width: 25%;">
                    <col style="width: 75%;">
                </colgroup>
                <tbody>
                    <tr>
                        <th style="text-align: center">
                            <label>ì¼ì</label>
                        </th>
                        <td>
                            <input style="width:300px;" type="date" id="data_date" name="data_date" value=""  />
                        </td>
                    </tr>
                    <tr>
                        <th style="text-align: center">
                            <label>ì²¨ë¶€íŒŒì¼</label>
                        </th>
                        <td>
                            <input style="width:300px; height: 44px;" type="file" id="upload_file" name="upload_file" enctype="multipart/form-data" accept=".xls, .xlsx"/>
                        </td>
                    </tr>
                </tbody>
            </table>
            </form>
        </div>
        <div class="pt-2">
            <textarea id="upload_message" style='display:none;width:100%;height:150px;'></textarea>
        </div>

        </section>

        <div class="popup-button">
            <button type="button" class="btn-popup y_write_auth" id="btn_excel_save" >ì €ì¥</button>
            <button type="button" class="btn-popup" id="modal-close-button">ë‹«ê¸°</button>
        </div>
    </div>
  </script>

</th:block>

<th:block layout:fragment="scripts">
  <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>
<!--  <th:block th:replace="/common/popup_company :: popup_company"></th:block>-->
  <th:block th:replace="/sales/popup_suju_company :: popup_suju_company"></th:block>
  <th:block th:replace="/sales/popup_company_new_save :: popup_company_new_save"></th:block>
  <th:block th:replace="/sales/popup_material_save :: popup_material_new_save"></th:block>
  <th:block th:replace="/sales/print_estimate :: print_estimate"></th:block>
  <script type="text/javascript">

    let isInternalFormatting = false;

    class SujuUploadPage {
      constructor() {
        this.url = '/api/sales/suju';
        this.grid = null;
        this.$btnEdit = $('#btnEdit');
        this.$btnAddNew = $('#btnAddNew');
        this.viewData = new wijmo.collections.CollectionView();
        this.init();

      }

      resetSujuListIndex() {
        this.sujuListIndex = 0;
      }

      nextSujuListIndex() {
        return this.sujuListIndex++;
      }

      init() {
        let _this = this;
        this.grid = new wijmo.grid.FlexGrid('#theGrid', {
          selectionMode: wijmo.grid.SelectionMode.Row,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          formatItem: (sender, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              e.cell.style.textAlign = 'center';
            }
          },
          columns: [
            {binding: 'CompanyName', header: 'íŒë§¤ì²˜', width: 190, align: 'left'},
            {binding: 'JumunDate', header: 'ìˆ˜ì£¼ì¼', width: 120, align: 'center'},
            {binding: 'JumunNumber', header: 'ìˆ˜ì£¼ ë²ˆí˜¸', width: 150, align: 'center', visible: false},
            {binding: 'product_name', header: 'ì œí’ˆëª…', width: 400},
            {binding: 'TotalPrice', header: 'ì´ì•¡', width: 120, align: 'right', format: 'n0'},
            {binding: 'DueDate', header: 'ë‚©ê¸°ì¼', width: 120, align: 'center'},
            {binding: 'StateName', header: 'ì‘ì—…ìƒíƒœ', width: 100, align: 'center'},
            {binding: 'ShipmentStateName', header: 'ì¶œí•˜ìƒíƒœ', width: 100, align: 'center'},
            {binding: 'SujuTypeName', header: 'ìˆ˜ì£¼êµ¬ë¶„', width: 100, align: 'center'},
            {binding: 'Description', header: 'ë¹„ê³ ', width: '*'}
          ],
          itemsSource: this.viewData, // ë°ì´í„°ë¥¼ ì„¤ì •í•  ë°°ì—´
        });

        new FlexGridContextMenu(this.grid);
        this.grid.downloadFileName = 'ìˆ˜ì£¼ ë‚´ì—­';

        this.grid.hostElement.addEventListener('dblclick', function (e) {
          let items = _this.grid.selectedItems;
          if (items.length === 0) {
            return false;
          }
          _this.$btnEdit.trigger('click');
        });

        let nowDate = CommonUtil.getYYYYMMDD();
        let dueDate = CommonUtil.getYYYYMMDD(10);

        //ìˆ˜ì£¼ë“±ë¡ í´ë¦­
        this.$btnAddNew.click(function (e) {
          let defaultData = {
            id: '',
            mode: 'new',
            JumunDate: nowDate,
            DueDate: dueDate,
          };
          _this.showSujuForm(defaultData);
        });

        // ìˆ˜ì£¼ ìˆ˜ì • í´ë¦­
        this.$btnEdit.click(function (e) {
          let selectedItems = _this.grid.selectedItems;
          const it = _this.grid.selectedItems && _this.grid.selectedItems[0];

          if (selectedItems.length === 1) {
            window.selectedGridId = it.id;
            let data = {
              id: selectedItems[0].id,
              action: 'detail'
            };
            let fnsuccess = function (result) {
              result.data['mode'] = 'edit';
              const selected = selectedItems[0];
              // ê¸°ë³¸ ì„¤ì •
              if (selected.StateName) {
                result.data['StateName'] = selected.StateName;
              }
              if (selected.State) {
                result.data['State'] = selected.State;
              }

              // ì¶œí•˜ ìƒíƒœê°€ ìˆë‹¤ë©´ ë®ì–´ì“°ê¸°
              if (selected.ShipmentStateName) {
                result.data['StateName'] = selected.ShipmentStateName;
              }
              _this.showSujuForm(result.data);
            };
            AjaxUtil.getAsyncData(_this.url + '/detail', data, fnsuccess);
          } else {
            Alert.alert('', 'ì„ íƒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          }

        });

        // ì‚­ì œ ë²„íŠ¼
        $('#btnDelete').click(function (e) {
          let items = _this.grid.selectedItems;
          if (items.length > 0) {
            Alert.confirm('', 'ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
              function () {
                let id = items[0].id;
                let state = items[0].State;
                let ShipmentStateName = items[0].ShipmentStateName;
                _this.deleteSujuData(id, state, ShipmentStateName);
              },
              function () {
              }
            );
          } else {
            Alert.alert('', 'ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', function () {
              $(this).focus();
            });
          }
        });

        // ====== ìœ í‹¸ ======
        function toNum(v, d = 0) {
          const n = Number.parseFloat(String(v ?? '').replace(/,/g, ''));
          return Number.isFinite(n) ? n : d;
        }
        function toStr(v, d = '') {
          return (v == null ? d : String(v)).trim();
        }

        // ====== ìƒì„¸ í˜¸ì¶œ ì„¤ì • ======
        const DETAIL_URL = _this.url + '/print_list';
        const buildDetailParams = (row) => ({ id: row.id, _ts: Date.now() }); // ìºì‹œ ë²„ìŠ¤í„°

        // AjaxUtil â†’ Promise ë˜í•‘
        function getDetailAsync(url, data) {
          return new Promise((resolve, reject) => {
            AjaxUtil.getAsyncData(url, data, (res) => resolve(res), (err) => reject(err));
          });
        }

        // ì‘ë‹µ ì ì‘ + items ì •ê·œí™”(í…œí”Œë¦¿ í‚¤ì— ë§ì¶¤)
        // - í’ˆëª©ëª… ê¼¬ë¦¬í‘œ " ... ì™¸ Nê°œ" ë°©ì§€(ì•ˆì „ ì°¨ì› í›„ì²˜ë¦¬)
        function adaptDetailResponse(resp) {
          const raw  = resp?.data ?? resp ?? {};
          const head = raw.head ?? {};
          const rows = raw.items ?? raw.lines ?? raw.Rows ?? raw.rows ?? [];

          let s = raw.supplier ?? raw.supplierSql ?? {};
          if (Array.isArray(s)) s = s[0] ?? {};

          const supplier = {
            SupplierBizNo:   toStr(s.biz_no   ?? s.saupnum   ?? s.SupplierBizNo   ?? ''),
            SupplierName:    toStr(s.name     ?? s.spjangnm  ?? s.SupplierName    ?? ''),
            SupplierCeo:     toStr(s.ceo      ?? s.prenm     ?? s.RepresentativeName ?? s.supplierceo ?? ''),
            SupplierAddress: toStr(s.address  ?? s.adresa    ?? s.SupplierAddress ?? ''),
            SupplierBizType: toStr(s.biz_type ?? s.biztype   ?? s.SupplierBizType ?? ''),
            SupplierBizItem: toStr(s.biz_item ?? s.item      ?? s.SupplierBizItem ?? ''),
            SupplierTel:     toStr(s.tel      ?? s.tel1      ?? s.SupplierTel     ?? '')
          };


          const items = Array.isArray(rows) ? rows.map(r => ({
            head_id: r.head_id ?? r.HEAD_ID,
            suju_id: r.suju_id ?? r.SUJU_ID,
            product_name: toStr(r.product_name ?? r.ProductName ?? r.PNAME).replace(/\s*ì™¸\s*\d+\s*ê°œ$/u, ''),
            Standard:     toStr(r.Standard ?? r.Spec ?? r.length ?? r.LEN ?? ''), // ì¸ì‡„ ë³´ì¡´ìš© ë¬¸ìì—´
            Qty:          toNum(r.Qty ?? r.quantity ?? r.QTY),
            UnitName:     toStr(r.UnitName ?? r.Unit ?? r.unit ?? r.unit_name ?? ''),
            UnitPrice:    toNum(r.UnitPrice ?? r.unit_price ?? r.PRICE),
            SupplyAmount: toNum(r.SupplyAmount ?? r.supply_amount ?? r.AMT),
            VatAmount:    toNum(r.VatAmount ?? r.vat_amount ?? r.VAT),
            TotalAmount:  toNum(r.TotalAmount ?? r.total_amount ?? (toNum(r.SupplyAmount) + toNum(r.VatAmount))),
            Description:  toStr(r.Description ?? r.head_description ?? ''),
            SujuQty2:     toNum(r.SujuQty2 ?? r.sujuqty2 ?? r.SUJUQTY2 ?? 0),
          })) : [];

          return { head, items, supplier };
        }

        // ì—”í„°í‚¤ ê²€ìƒ‰
        $('#keyword').on('keypress', function (e) {
          if (e.keyCode === 13) {
            _this.searchMainData();
          }
        });
      }

      showSujuForm(data) {
        //sujuTemplate
        let _this = this;
        let content = tmpl('sujuTemplate', data);
        let $content = $(content);
        const $root = $content;

        let modalContainer = null;
        if (data.mode === 'new') {
          modalContainer = new PopupDraggable('ë“±ë¡');
        } else {
          modalContainer = new PopupDraggable('ìˆ˜ì •');
        }
        modalContainer.open({width: 1400, height: 600, $content});

        // ì œí’ˆê²€ìƒ‰
        let $btnProductSearch = $content.find('#btnProductSearch');
        let $sujuForm = $content.find('#sujuForm');

        let $cboSujuType = $content.find('#cboSujuType');

        if (data.mode === 'new') {
          $btnProductSearch.removeAttr('disabled');
        }
        function getUnitVal($row) {
          const $u = $row.find('input[name="unit"], input[name^="unit_"]');
          return (($u.first().val() || '') + '').trim();
        }

        function isMeter(unit) {
          const v = (unit || '').trim();
          return v === 'm' || v === 'm(ë¯¸í„°)' || v === 'meter' || v.includes('ë¯¸í„°');
        }

        $content.find('#btnCompanySearch').click(function () {
          let poppage = new PopCompSuJuComponent();
          let $poppage = $(poppage);
          let searchcallback = function (items) {
            $content.find('#cboCompany').val(items.id);
            $content.find('#CompanyName').val(items.compname);

            // if ($Material_id.val() && $cboCompany.val()) {
            //     tryShowPrice();
            // }
          };

          poppage.show(searchcallback);
        });

        $content.find('#btnOrderSearch').click(function () {
          let poppage = new PopCompSuJuComponent();
          let $poppage = $(poppage);
          let searchcallback = function (items) {
            $content.find('#SuJuOrderId').val(items.id);
            $content.find('#SuJuOrderName').val(items.compname);

            $content.find('#cboCompany').val(items.id);
            $content.find('#CompanyName').val(items.compname);

            setTimeout(() => {
              const $delivery = $content.find('#DeliveryName');
              if ($delivery.length) {
                $delivery.focus();
                // ì»¤ì„œë¥¼ ë§¨ ë’¤ë¡œ ì´ë™(ì„ íƒ ë²”ìœ„ = ê¸¸ì´,ê¸¸ì´)
                const el = $delivery.get(0);
                if (el && el.setSelectionRange) {
                  const v = $delivery.val() || '';
                  el.setSelectionRange(v.length, v.length);
                }
              } else {
                const $fallback = $('#DeliveryName');
                if ($fallback.length) $fallback.focus();
              }
            }, 120);
          };

          poppage.show(searchcallback);
        });

        //ê±°ë˜ì²˜ ì‹ ê·œë“±ë¡ íŒì—…
        $content.on('click', '#plusCompany', function () {
          const popup = new PopCompSaveComponent(); // í•„ìš” ì‹œ { saveUrl: '/api/sales/suju/save_Comp' }ë¡œ êµì²´
          popup.show({
            onSaved: (saved) => {
              if (typeof window.searchCompanyList === 'function') searchCompanyList();
              if (saved) {
                $content.find('#cboCompany').val(saved.id);
                $content.find('#CompanyName').val(saved.name);

                setTimeout(() => {
                  const $delivery = $content.find('#DeliveryName');
                  if ($delivery.length) {
                    $delivery.focus();
                    // ì»¤ì„œë¥¼ ë§¨ ë’¤ë¡œ ì´ë™(ì„ íƒ ë²”ìœ„ = ê¸¸ì´,ê¸¸ì´)
                    const el = $delivery.get(0);
                    if (el && el.setSelectionRange) {
                      const v = $delivery.val() || '';
                      el.setSelectionRange(v.length, v.length);
                    }
                  } else {
                    const $fallback = $('#DeliveryName');
                    if ($fallback.length) $fallback.focus();
                  }
                }, 120);
              };
            },
            focusAfterClose: this
          });
        });


        // ì €ì¥ë²„íŠ¼
        let $btnPopSujuSave = $('#btnPopSujuSave');

        //ìˆ˜ì£¼êµ¬ë¶„
        AjaxUtil.fillSelectOptions($cboSujuType, 'system_code', 'choose', 'sales', 'suju_type');

        setTimeout(() => {
          FormUtil.BindDataSujuForm(data, $sujuForm);

          if (data.mode === 'new') {
            // ì‹ ê·œëŠ” ê¸°ë³¸ í•´ì œ + ê°’ë„ Nìœ¼ë¡œ ë§ì¶°ì„œ extractForm ì‹œ ëˆ„ë½ ë°©ì§€
            $content.find('input[type="checkbox"][name^="VatIncluded"]')
                    .prop('checked', false)
                    .val('N')
                    .trigger('change'); // ê³„ì‚°ì‹ ì¦‰ì‹œ ë°˜ì˜
          }else{
            //edit
            let nextElementIndex = data.sujuList.length;

            const $checkbox = $content.find(`input[name="VatIncluded_${nextElementIndex}"]`);
            $checkbox.prop('checked', false).val('N').trigger('change');
          }

          // âœ… ì—¬ê¸°: ì´ˆê¸° í–‰ ìƒíƒœ ì„¸íŒ…(ìˆ˜ì • ëª¨ë“œì¼ ë•Œ ê¸°ì¡´ ê¸ˆì•¡ ë³´ì¡´)
          const $rows = $content.find('.item-table tbody tr:visible').not('.item-template-row');
          $rows.each(function () {
            const $r = $(this);
            const hasSupply = !!String($r.find('input[name^="supplyAmount_"]').val() || '').trim();
            const hasVat    = !!String($r.find('input[name^="VatAmount_"]').val()   || '').trim();

            if (data.mode === 'new') {
              calculateAmounts($r, 'unit');
            } else {
              if (hasSupply || hasVat) {
                $r.data('supplyEdited', true);
                $r.data('vatEdited', true);
                // ë³´ê¸° í¬ë§·ë§Œ
                ['supplyAmount_', 'VatAmount_', 'totalAmount_'].forEach(prefix => {
                  const $inp = $r.find(`input[name^="${prefix}"]`);
                  const n = Number(String($inp.val()||'').replace(/,/g,''));
                  if (Number.isFinite(n)) $inp.val(n ? n.toLocaleString('ko-KR') : '');
                });
              } else {
                calculateAmounts($r, 'unit');
              }
            }
          });

          // (ì„ íƒ) ì „ì²´ í•©ê³„ í•œ ë²ˆ ê³„ì‚°
          calculateTotalSum($content);

          // ê¸°ì¡´ ë™ì‘ ìœ ì§€: ë‹¨ìœ„ì— ë”°ë¥¸ ë²„íŠ¼/í‘œì‹œ ê°±ì‹  íŠ¸ë¦¬ê±°
          $root.find('input[name="unit"], input[name^="unit_"]').trigger('input');

        }, 100);

        //ë²„íŠ¼ ì¡°ê±´
        applyEditability(data);

        // if (data.StateName && data.StateName !== 'ìˆ˜ì£¼') {
        //   $('#btnPopSujuSave').hide();
        //   $('#notUpdate')
        //     .css('margin-top', '10px') // ì¡°ê±´ ë§Œì¡± ì‹œ margin-top ì ìš©
        //     .show();
        //   $('.popup-button').css('margin-top', '10px');
        // }

        if (data.SujuQty > 0) {
          $SujuQty.val(data.SujuQty.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
        }


        function canEditSuju(data) {
          const state = String(data?.StateName ?? '').trim();
          const ship  = String(data?.ShipmentStateName ?? '').trim();

          if (ship) return false;          // ì¶œí•˜ ì§„í–‰ë¨ â†’ ìˆ˜ì • ë¶ˆê°€
          if (!state) return true;        // ìƒíƒœ ë¯¸ì§€ì •ì´ë©´ ì¼ë‹¨ í—ˆìš©(ì›í•˜ë©´ falseë¡œ)
          return ['ìˆ˜ì£¼'].includes(state);// í—ˆìš© ìƒíƒœë§Œ í†µê³¼
        }

        function applyEditability(data) {
          const editable = canEditSuju(data);

          if (editable) {
            $('#btnPopSujuSave').show();
            $('#notUpdate').hide();
            $('.popup-button').css('margin-top', '');
          } else {
            $('#btnPopSujuSave').hide();
            // ë©”ì‹œì§€: ì¶œí•˜ìƒíƒœê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì´ìœ ë¡œ, ì•„ë‹ˆë©´ ê¸°ì¡´ ë©”ì‹œì§€
            const ship = String(data?.ShipmentStateName ?? '').trim();
            const reason = ship ? '* ì¶œí•˜ê°€ ì§„í–‰ëœ ê±´ì€ ìˆ˜ì •ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.'
              : '* ì¶œí•˜ê°€ ì§„í–‰ëœ ìˆ˜ì£¼ëŠ” ìˆ˜ì •ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.';
            $('#notUpdate').text(reason).css('margin-top', '10px').show();
            $('.popup-button').css('margin-top', '10px');
          }
        }

        // ìˆ˜ì£¼ë“±ë¡ íŒì—… ì €ì¥ë²„íŠ¼ í´ë¦­
        $btnPopSujuSave.click(function (e) {

          //ìˆ˜ì£¼ì¼, ë‚©ê¸°ì¼ ì²´í¬?
          let data = FormUtil.extractForm($sujuForm);
          console.log('ë°ì´í„° í™•ì¸:', data);

          if (!$('#cboCompany').val()) {
            Alert.alert('', 'íŒë§¤ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
            return;
          }

          // 2. ê° í–‰ì˜ ìœ íš¨ì„± ì²´í¬
          let index = 0;
          while (true) {
            const materialId = data[`Material_id_${index}`];

            if (materialId === undefined) break; // ëê¹Œì§€ ì²´í¬

            if (materialId !== null && materialId !== '') {
              const qty = data[`quantity_${index}`];
              const price = data[`unitPrice_${index}`];

              if (!qty) {
                Alert.alert('', `(${index + 1}ë²ˆì§¸ í–‰) ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.`);
                return;
              }
            }

            index++;
          }

          Alert.confirm('', 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
            const items = [];
            for (let i = 0; i < page.sujuListIndex; i++) {
              const materialId = data[`Material_id_${i}`];
              const normMaterialId = (materialId === '' || materialId == null) ? null : Number(materialId);

              const productName = data[`txtProductName_${i}`];

              //if (!materialId) continue;
              if (!productName) continue;
              // âœ… ìƒì„¸ JSON íŒŒì‹±
              let standardDetails = [];
              try {
                const raw = data[`standard_detail_json_${i}`];
                if (raw) standardDetails = JSON.parse(raw);
              } catch(e){ standardDetails = []; }

              items.push({
                suju_id: data[`suju_id_${i}`] || '',
                Material_id: normMaterialId,
                MaterialGroupName: data[`MaterialGroupName_${i}`] || '',
                product_code: data[`product_code_${i}`] || '',
                txtProductName: productName,
                //txtProductName: data[`txtProductName_${i}`] || '',
                quantity: (data[`quantity_${i}`] || '0').replace(/,/g, ''),
                unitPrice: (data[`unitPrice_${i}`] || '0').replace(/,/g, ''),
                supplyAmount: (data[`supplyAmount_${i}`] || '0').replace(/,/g, ''),
                VatAmount: data[`VatAmount_${i}`] === 'ë©´ì„¸' ? '0' : (data[`VatAmount_${i}`] || '0').replace(/,/g, ''),
                totalAmount: (data[`totalAmount_${i}`] || '0').replace(/,/g, ''),
                description: data[`description_${i}`] || '',
                VatIncluded: data[`VatIncluded_${i}`] === undefined ? 'N' : 'Y',
                projectHidden: data[`projectHidden_${i}`] || '',
                unitPriceChanged: (() => {
                  const ori = parseFloat(data[`originalUnitPrice_${i}`] || '0');
                  const cur = parseFloat((data[`unitPrice_${i}`] || '0').replace(/,/g, ''));
                  return ori !== cur;
                })(),
                standard: data[`standard_${i}`] || '',
              });
            }


            // ê³µí†µ ì •ë³´ + ë¦¬ìŠ¤íŠ¸ ì „ì†¡
            const payload = {
              id: data.id,
              JumunDate: data.JumunDate,
              DueDate: data.DueDate,
              Company_id: data.Company_id,
              CompanyName: data.CompanyName,
              SujuType: data.SujuType,
              spjangcd: data.spjangcd,
              totalAmountSum: data.totalAmountSum,
              Description: data.Description,
              items: items
            };

            AjaxUtil.postJsonData(_this.url + '/manual_save', payload, function (res) {
              if (res.success) {
                Notify.success("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                _this.searchMainData();
                modalContainer.close();
              } else {
                Alert.alert('ì €ì¥ ì‹¤íŒ¨', res.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
              }
            });
          });
        });

        // ë‹¨ê°€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        function tryShowPrice($row) {
          const mat_pk = $row.find('input[name^="Material_id_"]').val();
          const company_id = $content.find('#cboCompany').val();
          const JumunDate = $content.find('#JumunDate').val();
          const SujuQty = parseFloat($row.find('input[name^="quantity"]').val().replace(/,/g, '') || '0');

          let url = _this.url + '/readPriceSuju';
          let data = {
            'mat_pk': mat_pk,
            'company_id': company_id,
            'JumunDate': JumunDate
          };

          if (mat_pk && company_id && JumunDate) {

            let fnsuccess = function (result) {

              let unitPrice = 0;
              if (result != null && result.data && result.data.length > 0) {
                unitPrice = parseFloat(result.data[0].UnitPrice);
                $row.find('input[name^="unitPrice_"]').val(unitPrice.toLocaleString());
                $row.find('input[name^="originalUnitPrice_"]').val(unitPrice.toLocaleString());

              } else {
                $row.find('input[name^="unitPrice"]').val('0');
                $row.find('input[name^="originalUnitPrice"]').val('0');
              }
              // unitTypeì´ ë¹„ì–´ìˆìœ¼ë©´ unit_ì—ì„œ ë³´ì •(EA/Më§Œ)
              if (!$row.data('unitType')) {
                const unitNameRaw = ($row.find('input[name^="unit_"]').val() || '')
                  .toString().trim().toUpperCase();
                $row.data('unitType', unitNameRaw.startsWith('M') ? 'M' : 'EA');
              }

              // âœ… ë‹¨ê°€ ë°˜ì˜ ì§í›„, ë¶„ê¸° ê³„ì‚° ê°•ì œ
              calculateAmounts($row, 'unit');
            };

            AjaxUtil.getAsyncData(url, data, fnsuccess);
          }
        }

        // ë¹ˆ ê°’ì€ í•­ìƒ ìˆ«ì 0ìœ¼ë¡œ ì²˜ë¦¬
        function getNumericValue($input, def = 0, allowNegative = false) {
          if ($input.length === 0) return def;
          let raw = (($input.val() || '') + '');
          // í—ˆìš© ë¬¸ìë§Œ ë‚¨ê¸°ê¸°
          raw = raw.replace(allowNegative ? /[^0-9.\-]/g : /[^0-9.]/g, '').trim();
          if (allowNegative) {
            // ì„ í–‰ '-' í•˜ë‚˜ë§Œ í—ˆìš©, ê·¸ ì™¸ '-' ì œê±°
            raw = raw.replace(/(?!^)-/g, '');
          }
          if (raw === '' || raw === '-' || raw === '.') return def;
          const n = parseFloat(raw);
          return Number.isFinite(n) ? n : def;
        }


        function isAdjustmentRow($row) {
          const code = (($row.find('input[name^="product_code_"]').val() ?? '') + '').trim();
          return code === ''; // ìƒí’ˆì½”ë“œ ë¹„ì–´ìˆìœ¼ë©´ ë‹¨ìˆ˜ì •ë¦¬ í–‰
        }

        let isInternalFormatting = false;

        function calculateAmounts($row, source = null) {
          if (isInternalFormatting) return;
          isInternalFormatting = true;
          try {
            const quantity  = getNumericValue($row.find('input[name^="quantity_"]'), 0);
            const unitPrice = getNumericValue($row.find('input[name^="unitPrice_"]'), 0);

            // ë‹¨ê°€ ì…ë ¥ ìœ ë¬´(ë¹ˆì¹¸ì´ê±°ë‚˜ NaNì´ë©´ ìë™ê³„ì‚° ê¸ˆì§€)
            const unitPriceRaw = String($row.find('input[name^="unitPrice_"]').val() || '').replace(/,/g, '');
            const hasUnitPrice = unitPriceRaw !== '' && !isNaN(Number(unitPriceRaw));

           const $standard = $row.find('input[type="text"][name^="standard_"]');
           const standardRaw    = (($standard.val() ?? '') + '').trim();
           const standardNumStr = standardRaw.replace(/,/g, '');
           const isStandardNumeric = standardNumStr !== '' && /^\d+(\.\d+)?$/.test(standardNumStr);
           const standardNum = isStandardNumeric ? parseFloat(standardNumStr) : 0;

           const baseQty = Number.isFinite(quantity) ? quantity : 0;

// ğŸ”¹ ë‹¨ìœ„ ì½ê¸°
           const unitVal = String(
            $row.find('input[name^="unit_"], input[name="unit"]').val() || ''
           ).trim();

// ğŸ”¹ ë‹¨ìœ„ + ê·œê²©ì— ë”°ë¥¸ ì‹¤ì œ ê³„ì‚° ìˆ˜ëŸ‰
           let qtyForCalc = baseQty;

           if (isStandardNumeric) {
            if (isMeter(unitVal)) {
             // Mì¸ ê²½ìš°ë§Œ ê·œê²© Ã— ìˆ˜ëŸ‰
             qtyForCalc = standardNum * baseQty;
            } else {
             // Mì´ ì•„ë‹Œ ë‹¨ìœ„(EA, SET ë“±)ëŠ” ê·œê²© ë¬´ì‹œ
             qtyForCalc = baseQty;
            }
           }

           const isVatIncluded = $row.find('input[name^="VatIncluded_"]').is(':checked');
            const isVatExempt   = false;

            let supplyAmount     = getNumericValue($row.find('input[name^="supplyAmount_"]'), 0);
            let vatAmount        = getNumericValue($row.find('input[name^="VatAmount_"]'), 0);
            const isSupplyEdited = $row.data('supplyEdited') === true;
            const isVatEdited    = $row.data('vatEdited') === true;

            const adjustment = isAdjustmentRow($row);

            // ë‹¨ê°€ ì—†ìœ¼ë©´ ìë™ê³„ì‚° ê¸ˆì§€
            const shouldAuto = !adjustment && hasUnitPrice && ((source === 'unit') || (!isSupplyEdited && !isVatEdited));

            if (adjustment) {
              let supplyAmount = getNumericValue($row.find('input[name^="supplyAmount_"]'), 0, true); // ìŒìˆ˜ í—ˆìš©
              // (ì •ì±…ìƒ ë‹¨ìˆ˜ì •ë¦¬ í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ Math.floor ë“± ì ìš©)
              $row.find('input[name^="VatAmount_"]').val(''); // VAT=0 í‘œê¸°
              $row.find('input[name^="totalAmount_"]').val(
                supplyAmount === 0 ? '' : supplyAmount.toLocaleString('ko-KR')
              );
              calculateTotalSum($content);
              return; // ì¡°ì •í–‰ì€ ì—¬ê¸°ì„œ ì¢…ë£Œ(ì¼ë°˜ ìë™ê³„ì‚° ë®ì–´ì“°ê¸° ë°©ì§€)
            }

            if (shouldAuto) {
              const lineTotal = qtyForCalc * unitPrice;

              if (isVatExempt) {
                supplyAmount = lineTotal;
                vatAmount    = 0;
              } else if (isVatIncluded) {
                supplyAmount = Math.round(lineTotal / 1.1);
                vatAmount    = lineTotal - supplyAmount;
              } else {
                supplyAmount = lineTotal;
                vatAmount    = Math.floor(supplyAmount * 0.1);
              }

              if (!isSupplyEdited) {
                $row.find('input[name^="supplyAmount_"]').val(supplyAmount === 0 ? '' : supplyAmount.toLocaleString());
              }
              if (!isVatEdited) {
                $row.find('input[name^="VatAmount_"]').val(isVatExempt ? 'ë©´ì„¸' : (vatAmount === 0 ? '' : vatAmount.toLocaleString()));
              }
            } else if (!hasUnitPrice && !adjustment && !isSupplyEdited && !isVatEdited) {

            }
            // í•©ê³„(í‘œì‹œìš©)
            const sNum = getNumericValue($row.find('input[name^="supplyAmount_"]'), 0);
            const vNum = getNumericValue($row.find('input[name^="VatAmount_"]'), 0);
            const autoSum = sNum + vNum;

            $row.find('input[name^="totalAmount_"]').val(autoSum === 0 ? '' : autoSum.toLocaleString('ko-KR') );

            // í‘œê¸° í¬ë§·
            $row.find('input[name^="quantity_"]').val(quantity  === 0 ? '' : quantity.toLocaleString());
            $row.find('input[name^="unitPrice_"]').val(unitPrice === 0 ? '' : unitPrice.toLocaleString());

            calculateTotalSum($content);
          } finally {
            isInternalFormatting = false;
          }
        }


        // ì´í•© ê³„ì‚°(ë¶€ëª¨ í¼ í—¤ë” ë°˜ì˜) â€” í†µí•© ë²„ì „
        function calculateTotalSum($scope) {
          const $root = $scope && $scope.length ? $scope : $('#sujuForm');

          let sum = 0;
          $root.find('.item-table tr:visible').each(function () {
            const $row = $(this);
            const $totalInput =
              $row.find('input[name="totalAmount"]').first().length
                ? $row.find('input[name="totalAmount"]').first()
                : $row.find('input[name^="totalAmount_"]').first();
            if (!$totalInput.length) return;

            const raw = String($totalInput.val() || '').replace(/,/g, '').trim();
            if (raw === '' || raw === '-' || raw === '.') return;

            const n = parseFloat(raw);
            if (Number.isFinite(n)) sum += n;
          });

          const $target = $root.find('#totalAmountSum').first().length
            ? $root.find('#totalAmountSum').first()
            : $('#totalAmountSum');

          $target.val(sum !== 0 ? Number(sum).toLocaleString() : '');
        }

        // ìˆ˜ëŸ‰/ë‹¨ê°€ ì…ë ¥ ì‹œ
        $content.on('input', 'input[name^="quantity_"], input[name^="unitPrice_"]', function () {
          const $row = $(this).closest('tr');
          $row.removeData('supplyEdited');
          $row.removeData('vatEdited');
          calculateAmounts($row, 'unit');
        });

        // ê³µê¸‰ê°€ ì…ë ¥
        $content.on('input', 'input[name^="supplyAmount_"]', function () {
          const $row = $(this).closest('tr');
          $row.data('supplyEdited', true);
          calculateAmounts($row);
        });

        // ì„¸ì•¡ ì…ë ¥
        $content.on('input', 'input[name^="VatAmount_"]', function () {
          const $row = $(this).closest('tr');
          $row.data('vatEdited', true);
          calculateAmounts($row);
        });

        // í•©ê³„ ì§ì ‘ ì…ë ¥ ì‹œ ì´í•© ê³„ì‚°
        $content.on('input', 'input[name^="totalAmount_"]', function () {
          calculateTotalSum($content);
        });

        // ë¶€ê°€ì„¸ ì²´í¬ ë³€ê²½
        $content.on('change', 'input[name^="VatIncluded_"]', function () {
          const $row = $(this).closest('tr');
          $(this).val(this.checked ? 'Y' : 'N');
          $row.removeData('supplyEdited');
          $row.removeData('vatEdited');
          calculateAmounts($row, 'unit');
        });

        // í‘œì¤€ ë³€ê²½ ì‹œ ì¦‰ì‹œ ì¬ê³„ì‚°
        $content.on('input change', 'input[name^="standard_"]', function () {
          const $row = $(this).closest('tr');
          calculateAmounts($row, 'unit'); // â† 'standard-change' ë§ê³  'unit'ìœ¼ë¡œ
        });

        // ìˆ«ì í¬ë§· (input ì¤‘ formatting) - ì†Œìˆ˜ì /ì²œë‹¨ìœ„ ì§€ì›
        // 1) ì…ë ¥ ì¤‘: í¬ë§·(ì²œë‹¨ìœ„)ë§Œ, ì†Œìˆ˜ ê³ ì • ê¸ˆì§€
        $content.off('input.numfmt')
          .on('input.numfmt',
            'input[name^="quantity_"], input[name^="unitPrice_"],' +
            ' input[name^="supplyAmount_"], input[name^="VatAmount_"],' +
            ' input[name^="totalAmount_"]',
            function (e) {
              if (isInternalFormatting) return;
              if (e.originalEvent && e.originalEvent.isComposing) return;

              isInternalFormatting = true;
              const input = this;
              const $this = $(this);
              const name  = input.name || '';
              const $row  = $this.closest('tr');

              // ì»¤ì„œ ë³´ì •
              const prevLen = input.value.length;
              const cursorPos = input.selectionStart;
              const rightRemain = prevLen - cursorPos;

              // â”€â”€ supplyAmount_ ì „ìš©: ì¡°ì • í–‰ì¼ ë•Œë§Œ '-' í—ˆìš© â”€â”€
              if (name.startsWith('supplyAmount_')) {
                const adjustment = isAdjustmentRow($row);
                let raw = String($this.val() || '').replace(/,/g, '');

                // ì¡°ì •í–‰ë§Œ '-' í—ˆìš©, ì†Œìˆ˜ì ì€ ë¶ˆí—ˆ(ì •ìˆ˜)
                raw = raw.replace(adjustment ? /[^0-9\-]/g : /[^0-9]/g, '');
                if (adjustment) raw = raw.replace(/(?!^)-/g, ''); // ì„ í–‰ '-' í•˜ë‚˜ë§Œ í—ˆìš©

                if (raw === '' || raw === '-') { isInternalFormatting = false; return; }
                const num = Number(raw);
                if (!isFinite(num)) { isInternalFormatting = false; return; }

                const formatted = num.toLocaleString('ko-KR');
                $this.val(formatted);

                const newLen = formatted.length;
                const pos = Math.max(0, newLen - rightRemain);
                input.setSelectionRange(pos, pos);
                isInternalFormatting = false;
                return;
              }

              // â”€â”€ totalAmount_ ì „ìš©: ì¡°ì • í–‰ì¼ ë•Œë§Œ '-' í—ˆìš© â”€â”€
              if (name.startsWith('totalAmount_')) {
                const adjustment = isAdjustmentRow($row);
                let raw = String($this.val() || '').replace(/,/g, '');
                raw = raw.replace(adjustment ? /[^0-9.\-]/g : /[^0-9.]/g, '');
                if (adjustment) raw = raw.replace(/(?!^)-/g, ''); // ì„ í–‰ '-' í•˜ë‚˜ë§Œ
                // ì  í•˜ë‚˜ë§Œ
                raw = raw.replace(/\.(?=.*\.)/g, '');
                if (raw === '' || raw === '-' || raw === '.') { isInternalFormatting = false; return; }
                const num = Number(raw);
                if (!isFinite(num)) { isInternalFormatting = false; return; }
                const formatted = num.toLocaleString('ko-KR');
                $this.val(formatted);

                const newLen = formatted.length;
                const pos = Math.max(0, newLen - rightRemain);
                input.setSelectionRange(pos, pos);
                isInternalFormatting = false;
                return;
              }

              // â”€â”€ ì´í•˜ ê¸°ì¡´ ë¡œì§(ìˆ˜ëŸ‰ ì†Œìˆ˜1ìë¦¬, ê·¸ ì™¸ ì •ìˆ˜) â”€â”€
              let allowDecimal = false;
              let decimals = 0;
              if (name.startsWith('quantity_')) { allowDecimal = true; decimals = 2; }

              let raw = String($this.val() || '').replace(/,/g, '');

              if (allowDecimal) {
                raw = raw.replace(/[^0-9.]/g, '').replace(/\.(?=.*\.)/g, '');
                if (raw === '' || raw === '.') { $this.val(''); isInternalFormatting = false; return; }
                const hasDot = raw.includes('.');
                let [intPart, fracPart = ''] = raw.split('.');
                intPart = intPart.replace(/^0+(?=\d)/, '');
                if (fracPart.length > decimals) fracPart = fracPart.slice(0, decimals);
                const intFormatted = (intPart === '' ? '0' : String(Number(intPart))).toLocaleString('ko-KR');
                const formatted = hasDot ? `${intFormatted}.${fracPart}` : intFormatted;
                $this.val(formatted);
                const newLen = formatted.length;
                const pos = Math.max(0, newLen - rightRemain);
                input.setSelectionRange(pos, pos);
              } else {
                raw = raw.replace(/[^0-9]/g, '');
                if (raw === '') { $this.val(''); isInternalFormatting = false; return; }
                const formatted = Number(raw).toLocaleString('ko-KR');
                $this.val(formatted);
                const newLen = formatted.length;
                const pos = Math.max(0, newLen - rightRemain);
                input.setSelectionRange(pos, pos);
              }

              isInternalFormatting = false;
            }
          );

        // ë¸”ëŸ¬ ì‹œ: totalAmount_ëŠ” ì¡°ì • í–‰ì—ì„œ ìŒìˆ˜ ìœ ì§€
        $content.off('blur.numfmt')
          .on('blur.numfmt',
            'input[name^="quantity_"], input[name^="unitPrice_"], ' +
            'input[name^="supplyAmount_"], input[name^="VatAmount_"], ' +
            'input[name^="totalAmount_"]',
            function () {
              const $this = $(this);
              const name = this.name || '';
              const $row = $this.closest('tr');
              let v = String($this.val() || '').replace(/,/g, '');
              if (!v) return;

              if (name.startsWith('supplyAmount_')) {
                const adjustment = isAdjustmentRow($row);
                v = v.replace(/,/g, '');
                v = v.replace(adjustment ? /[^0-9\-]/g : /[^0-9]/g, '');
                if (adjustment) v = v.replace(/(?!^)-/g, '');
                if (v === '' || v === '-') { $this.val(''); return; }

                const num = Number(v);
                if (!isFinite(num)) { $this.val(''); return; }

                // í•„ìš” ì‹œ ì—¬ê¸°ì„œ ë‹¨ìˆ˜ì •ë¦¬(ì ˆì‚¬/ë°˜ì˜¬ë¦¼) ìˆ˜í–‰
                // num = Math.floor(num); // ì •ì±…ì— ë§ê²Œ

                $this.val(num.toLocaleString('ko-KR'));

                // ì¡°ì •í–‰ì´ë©´ ê³µê¸‰ê°€ ìˆ˜ë™í¸ì§‘ í”Œë˜ê·¸ ì„¸ìš°ê³  ì¬ê³„ì‚°(VAT=0 ì •ì±…ì´ë¼ë©´ calculateAmountsì—ì„œ ì²˜ë¦¬)
                if (adjustment) {
                  $row.data('supplyEdited', true);
                  $row.removeData('vatEdited');
                  calculateAmounts($row);
                }
                return;
              }

              //  totalAmount_ ë¶„ê¸° ëŒ€ì²´
              if (name.startsWith('totalAmount_')) {
                const adjustment = isAdjustmentRow($row);

                // ìˆ«ì ì •ë¦¬(+ ì¡°ì •í–‰ì€ ìŒìˆ˜ í—ˆìš©)
                v = v.replace(adjustment ? /[^0-9.\-]/g : /[^0-9.]/g, '');
                if (adjustment) v = v.replace(/(?!^)-/g, '');
                v = v.replace(/\.(?=.*\.)/g, '');
                if (v === '' || v === '-' || v === '.') { $this.val(''); return; }

                const num = Number(v);
                if (!isFinite(num)) { $this.val(''); return; }

                if (adjustment) {
                  // âœ… í•©ê³„ ì…ë ¥ê°’ì„ 'ê³µê¸‰ê°€ì•¡'ìœ¼ë¡œ ì´ê´€
                  const $sup = $row.find('input[name^="supplyAmount_"]');
                  $sup.val(num ? Number(num).toLocaleString('ko-KR') : '');

                  // ë¶€ê°€ì„¸ëŠ” ë‹¨ìˆ˜ì •ë¦¬ í–‰ì—ì„œëŠ” 0ìœ¼ë¡œ(ê´€ë¡€) â€”â€” í•„ìš” ì‹œ ì •ì±…ìœ¼ë¡œ ë°”ê¾¸ì„¸ìš”.
                  $row.find('input[name^="VatAmount_"]').val('');
                  $row.data('supplyEdited', true);
                  $row.removeData('vatEdited');

                  // í•©ê³„ëŠ” supply+vatë¡œ ìë™ ë°˜ì˜
                  calculateAmounts($row);
                  return; // totalì€ ì‚¬ìš©ìê°€ ì§ì ‘ ë„£ëŠ” í•„ë“œê°€ ì•„ë‹˜
                }

                // ì¼ë°˜í–‰: ê¸°ì¡´ í¬ë§·ë§Œ ìœ ì§€
                $this.val(num.toLocaleString('ko-KR'));
                return;
              }

              // quantity_ ë¸”ëŸ¬ ì²˜ë¦¬ (ì†Œìˆ˜ 2ìë¦¬)
              if (name.startsWith('quantity_')) {
                v = v.replace(/[^0-9.]/g, '').replace(/\.(?=.*\.)/g, '');
                if (v === '' || v === '.') { $this.val(''); return; }
                let num = Number(v);
                if (!isFinite(num)) { $this.val(''); return; }

                // â¬‡ ì—¬ê¸°ë§Œ 1â†’2ìë¦¬ë¡œ
                num = Math.round(num * 100) / 100;

                const parts = String(num).split('.');
                const intStr = Number(parts[0]).toLocaleString('ko-KR');

                if (parts.length === 1 || Number(parts[1]) === 0) {
                  $this.val(intStr);
                } else {
                  // ìµœëŒ€ 2ìë¦¬, ë’¤ì˜ 0ì€ ì œê±°
                  const frac = (parts[1] + '00').slice(0, 2).replace(/0+$/, '');
                  $this.val(frac ? `${intStr}.${frac}` : intStr);
                }
              } else {
                const iv = v.replace(/[^0-9]/g, '');
                if (iv === '') { $this.val(''); return; }
                $this.val(Number(iv).toLocaleString('ko-KR'));
              }
            }
          );

        $content.off('change.productCodeGuard')
          .on('change.productCodeGuard', 'input[name^="product_code_"]', function () {
            const $row = $(this).closest('tr');
            const code = (this.value ?? '').toString().trim();
            if (code !== '') {
              // totalAmount_ì—ì„œ ìŒìˆ˜ ì œê±° í›„ ì¬ê³„ì‚°
              const $tot = $row.find('input[name^="totalAmount_"]');
              const cleaned = (($tot.val() ?? '') + '').replace(/,/g, '').replace(/-/g, '');
              $tot.val(cleaned ? Number(cleaned).toLocaleString('ko-KR') : '');
              // ì¼ë°˜ ëª¨ë“œ ê°•ì œ ì¬ê³„ì‚°
              $row.removeData('supplyEdited');
              $row.removeData('vatEdited');
              calculateAmounts($row, 'unit');
            }
          });

        // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ íŒì—…
        $content.on('click', 'a[title="í’ˆëª© ì‹ ê·œë“±ë¡"]', function () {
          //í˜„ì¬ í´ë¦­í•œ ë²„íŠ¼ì´ ì†í•œ í–‰ì„ ê¸°ì¤€ ì»¨í…ìŠ¤íŠ¸ë¡œ ì‚¬ìš©
          const $row = $(this).closest('tr');

          const pop = new PopMatSaveComponent();
          pop.show({
            onSaved: (saved) => {
              if (typeof window.searchMatList === 'function') searchMatList();
              if (!saved) return;

              //prefixë¡œ ì°¾ëŠ” í—¬í¼ (ë³´ì´ëŠ” í…ìŠ¤íŠ¸/ì…€ë ‰íŠ¸ë§Œ íƒ€ê²Ÿ)
              const setByPrefix = (prefix, val) => {
                const $target = $row.find(
                  `input[type="text"][name^="${prefix}"]:visible,
                     textarea[name^="${prefix}"]:visible,
                     select[name^="${prefix}"]:visible`
                ).first();

                if ($target.length) {
                  $target.val(val ?? '').trigger('input').trigger('change');
                } else {
                  // ìˆ¨ê¹€ í•„ë“œë§Œ ìˆëŠ” ê²½ìš° ëŒ€ë¹„í•´ í•œ ë²ˆ ë” ì‹œë„(í…ìŠ¤íŠ¸ ìš°ì„ )
                  const $fallback = $row.find(`[name^="${prefix}"]`).filter(':input').first();
                  if ($fallback.length) {
                    $fallback.val(val ?? '').trigger('input').trigger('change');
                  } else {
                    console.warn(`No target found for prefix: ${prefix}`);
                  }
                }
              };

              setByPrefix('product_code_',   saved.Code);
              setByPrefix('Material_id_',    saved.id);
              setByPrefix('txtProductName_', saved.name);
              setByPrefix('standard_',       saved.standard);
              setByPrefix('unit_',       saved.unit_name);

              // ì½ê¸°ì „ìš© í† ê¸€
              const $std = $row.find('input[type="text"][name^="standard_"]:visible').first();
              const hasStd = !!(saved.standard && String(saved.standard).trim().length);
              if ($std.length) $std.prop('readonly', hasStd);
            },

            // í¬ì»¤ìŠ¤ ë³µê·€
            focusAfterClose: this
          });
        });

        $content.on('keydown', 'input[name^="txtProductName_"]', function (e) {
          if (e.key !== 'Enter' && e.keyCode !== 13) return;

          e.preventDefault();

          const $field = $(this);
          const $row = $field.closest('tr');

          const $productInput = $row.find('input[name^="txtProductName_"]');
          const $productId = $row.find('input[name^="Material_id_"]');
          const $productCode = $row.find('input[name^="product_code_"]');
          const $Standard = $row.find('input[name^="standard_"]');
          const $unit_name = $row.find('input[name^="unit_"]');

          const keyword = $field.val().trim();
          const pop = new PopMatComponent();
          pop.material_type = 'product,sangpum';

          const callback = function (item) {
            $productId.val(item.id || '');
            $productInput.val(item.Name || '');
            $productCode.val(item.Code || '');
            $unit_name.val(item.unit_name || '').trigger('input');
            $Standard.val(item.Spec || '');

            tryShowPrice($row);
          };

          if (!keyword) {
            pop.focusAfterClose = $field[0];
            pop.show(callback);
            return;
          }

          const data = {
            keyword: keyword,
            spjangcd: sessionStorage.getItem('spjangcd')
          };

          const result = AjaxUtil.getSyncData('/api/popup/search_material', data);
          const rows = result?.data || [];

          if (rows.length === 1) {
            callback(rows[0]);
          } else {
            pop.show(callback);
            setTimeout(() => {
              pop.$keyword.val(keyword);
              pop.$btnMaterialSearch.trigger('click');
            }, 50);
          }
        });

        // í’ˆëª©ëª… ì§€ìš°ë©´ ì½”ë“œë“¤ë„ ê°™ì´ ì§€ì›Œì§€ê²Œ
        $content.on('input', 'input[name^="txtProductName_"]', function () {
          const $field = $(this);
          const $row = $field.closest('tr');

          const $productId = $row.find('input[name^="Material_id_"]');
          const $productCode = $row.find('input[name^="product_code_"]');
          const $Standard = $row.find('input[name^="standard_"]');
          const $unit_name = $row.find('input[name^="unit_"]');

          if ($field.val().trim() === '') {
            // ê°’ì´ ë¹„ì—ˆì„ ê²½ìš° ì—°ê´€ëœ í•„ë“œ ì´ˆê¸°í™”
            $productId.val('');
            $productCode.val('');
            $Standard.val('');
            $unit_name.val('');
            $Standard.prop('readonly', false);
          }
        });

        $content.find('#addRemark').click(function () {
          const $tbody = $content.find('.item-table tbody');
          const $template = $tbody.find('.item-template-row');

          for (let i = 0; i < 3; i++) {
            const $newRow = $template.clone().removeClass('item-template-row').show();
            const index = page.nextSujuListIndex();
            $newRow.find('input').each(function () {
              const baseName = $(this).attr('name');
              if (baseName) {
                $(this).attr('name', `${baseName}_${index}`);
              }
            });

            $newRow.find('a[title="ì‚­ì œ"]').attr('id', `btnDelItem_${index}`);
            $tbody.append($newRow);
          }
        });

        // í¬ì»¤ìŠ¤ ìë™ ì´ë™: Enter + ë°©í–¥í‚¤(â†â†’â†‘â†“)
        $content.on('keydown', 'input', function (e) {
          const key = e.key;

          if (!['Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(key)) return;
          e.preventDefault();

          const $input = $(this);
          const $row = $input.closest('tr');
          const nameAttr = $input.attr('name') || '';

          const focusOrder = [
            'txtProductName_',
            'standard_',
            'quantity_',
            'unitPrice_',
            'supplyAmount_',
            'VatAmount_',
            'totalAmount_',
            'project_',
            'description_',
          ];

          const currentIndex = focusOrder.findIndex(prefix => nameAttr.startsWith(prefix));
          if (currentIndex === -1) return;

          let $nextInput = null;

          // â†”ï¸ ì¢Œìš° ì´ë™
          if (key === 'ArrowRight' && currentIndex < focusOrder.length - 1) {
            const nextPrefix = focusOrder[currentIndex + 1];
            $nextInput = $row.find(`input[name^="${nextPrefix}"]`);
          } else if (key === 'ArrowLeft' && currentIndex > 0) {
            const prevPrefix = focusOrder[currentIndex - 1];
            $nextInput = $row.find(`input[name^="${prevPrefix}"]`);
          }

          // â†•ï¸ ìƒí•˜ ì´ë™
          if (key === 'ArrowDown' || key === 'ArrowUp') {
            const $targetRow = key === 'ArrowDown'
              ? $row.nextAll('tr:visible').first()
              : $row.prevAll('tr:visible').first();

            const allowAutoAdd = ['txtProductName_', 'description_'];
            const isAllowedField = allowAutoAdd.some(prefix => nameAttr.startsWith(prefix));

            // â¬‡ï¸ ë°©í–¥í‚¤ + í˜„ì¬ í–‰ì´ ë§ˆì§€ë§‰ + í—ˆìš©ëœ í•„ë“œì¼ ê²½ìš° â†’ í–‰ ìë™ ì¶”ê°€
            if (key === 'ArrowDown' && !$targetRow.length && isAllowedField) {
              $content.find('#addRemark').trigger('click');

              setTimeout(() => {
                const $rows = $content.find('.item-table tbody tr:visible').not('.item-template-row');
                const $newRow = $rows.last();
                const $newInput = $newRow.find('input[name^="txtProductName_"]');
                if ($newInput.length) $newInput.focus().select();
              }, 50);
              return;
            }
            // ì¼ë°˜ ìƒí•˜ ì´ë™
            $nextInput = $targetRow.find(`input[name^="${focusOrder[currentIndex]}"]`);
          }

          // â†µ Enter í‚¤: í˜„ì¬ í–‰ ë‚´ ë‹¤ìŒ í•„ë“œ
          if (key === 'Enter' && currentIndex < focusOrder.length - 1) {
            const nextPrefix = focusOrder[currentIndex + 1];
            $nextInput = $row.find(`input[name^="${nextPrefix}"]`);
          } else if (key === 'Enter' && nameAttr.startsWith('description_')) {
            const $nextRow = $row.nextAll('tr:visible').first();
            if (!$nextRow.length) {
              //console.log('ë‹¤ìŒ í–‰ ì—†ìŒ. í–‰ ìë™ ì¶”ê°€ íŠ¸ë¦¬ê±°.');
              $content.find('#addRemark').trigger('click');

              setTimeout(() => {
                const $rows = $content.find('.item-table tbody tr:visible').not('.item-template-row');
                const $newRow = $rows.last();
                const $newInput = $newRow.find('input[name^="txtProductName_"]');
                if ($newInput.length) $newInput.focus().select();
              }, 50);
              return;
            } else {
              $nextInput = $nextRow.find('input[name^="txtProductName_"]');
            }
          }

          if ($nextInput && $nextInput.length) {
            $nextInput.focus().select();
          }
        });

      }

      deleteSujuData(id, state, ShipmentStateName) {
        let _this = this;
        let url = _this.url + '/delete';
        let data = {'id': id, 'State': state, 'ShipmentStateName': ShipmentStateName}
        let fnsuccess = function (res) {
          if (res.success) {
            Notify.success('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            _this.searchMainData();
          } else {
            Alert.alert('', res.message);
          }
        };

        AjaxUtil.postAsyncData(url, data, fnsuccess);
      }

      // exportExcel() {
      //     var targetview = this.grid;
      //     targetview.exportExcel('ìˆ˜ì£¼ë‚´ì—­.xls');
      // }

      searchMainData() {
        let _this = this;
        let start = $('#srchStartDt').val();
        let end = $('#srchEndDt').val();
        let url = this.url + '/read';

        let data = {
          'start': start,
          'end': end,
          'action': 'read'
        };

        let fnsuccess = function (result) {
          if (result != null) {
            _this.viewData.sourceCollection = result.data;

            if (window.selectedGridId) {
              GridUtil.selectRowById(_this.grid, window.selectedGridId);
              window.selectedGridId = null;
            }
          }
        };
        AjaxUtil.getAsyncData(url, data, fnsuccess);

      }

      // ì—‘ì…€ ì—…ë¡œë“œ ë²„íŠ¼
      showPopupExcelUpload(data) {
        let _this = this;
        let content = tmpl('excelUploadTemplate', data);
        let $content = $(content);
        $content.find('#data_date').val(data.data_date);
        $content.find('#day_index').val(data.day_index);

        //íŒì—…ê³µí†µëª¨ë“ˆ
        let modalContainer = new PopupDraggable('ì—‘ì…€ ì—…ë¡œë“œ');
        modalContainer.open({width: 440, height: 220, $content});


        $content.find('#btn_excel_save').on('click', function () {
          let $form = $content.find('#excelUploadForm');
          Alert.confirm('',
            'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
            function () {
              _this.saveSujuBulkData($form, modalContainer);
              //modalContainer.close();
            },
            function () {
            }
          );
        });
      }

      // ì—‘ì…€ ì—…ë¡œë“œ ì €ì¥
      saveSujuBulkData($form, modalContainer) {
        let _this = this;
        var form = $('#excelUploadForm')[0];
        var formData = new FormData(form);

        formData['data_date'] = $('#srchStartDt').val();
        formData.append("uploadfile", $('#upload_file')[0].files[0].name);

        let result = AjaxUtil.postFileSyncData(_this.url + '/upload_save', formData);

        if (result) {
          let message = 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
          if (result.success) {
            Notify.success(message);
            _this.searchMainData();
            modalContainer.close();
          } else {

            Alert.alert('', result.message);

            /*let $divMessage = modalContainer.$content.find('#upload_message');
            $divMessage.text(JSON.stringify(result.error_items));
            $divMessage.show();*/
          }
        }

      }

      downloadExcelForm() {
        let _this = this;
        //let url = '/api/files/mes_form?action=suju_upload';
        let fileName = "ìˆ˜ì£¼ì—…ë¡œë“œì–‘ì‹.xlsx";
        let url = '/api/files/mes_form?file_name=' + fileName;
        /*
        let data = {
            //'tableName' : tableName,
            'file_name': "ìˆ˜ì£¼ì—…ë¡œë“œì–‘ì‹.xlsx",
        };
        */
        AjaxUtil.downloadFile(url, fileName);
      }

    }

    // ===== í•©ê³„ ì§‘ê³„ (ê·œê²©/ìˆ˜ëŸ‰ íŒì—…) =====
    /*function updateTotals($root) {
      // ê¸ˆì•¡ í•©ê³„ ê³„ì‚°
      let sumPrice = 0; // ê³µê¸‰ê°€ì•¡ í•©ê³„
      let sumVat   = 0; // ë¶€ê°€ì„¸ í•©ê³„

      $root.find('.item-Standard-table tr.std-row').each(function () {
        const p = parseFloat(($(this).find('input[name="sd_price"]').val() || '').replace(/,/g,'')) || 0;
        const v = parseFloat(($(this).find('input[name="sd_vat"]').val()   || '').replace(/,/g,'')) || 0;
        sumPrice += p;
        sumVat   += v;
      });

      const total = sumPrice + sumVat;

      // 1) í‘œì‹œìš© ì˜ì—­ì´ ìˆìœ¼ë©´ ì±„ìš°ê¸° (ì„ íƒ: ì—†ìœ¼ë©´ ë¬´ì‹œë¨)
      // ì˜ˆ: <span id="total_price"></span> / <span id="total_vat"></span> / <span id="total_amount"></span>
      const fmt = n => Number(n).toLocaleString();
      $root.find('#total_price').text(fmt(sumPrice));
      $root.find('#total_vat').text(fmt(sumVat));
      $root.find('#total_amount').text(fmt(total));

      // 2) íˆë“  ê°’ìœ¼ë¡œë„ ë³´ê´€ (ì„œë²„ ì „ì†¡/ë¶€ëª¨í–‰ ë°˜ì˜ìš©)
      // name="TotalAmount" íˆë“  ì¸í’‹ì„ íŒì—… ë‚´ì— ìœ ì§€ (ì½¤ë§ˆ ì—†ëŠ” ì›ì‹œê°’)
      let $hid = $root.find('input[type="hidden"][name="TotalAmount"]');
      if ($hid.length) $hid.val(String(total));
      else $('<input>', { type: 'hidden', name: 'TotalAmount', value: String(total) }).appendTo($root);

      // (ì„ íƒ) ê³µê¸‰ê°€/ë¶€ê°€ì„¸ íˆë“ ë„ ì›í•˜ë©´ ìœ ì§€
      let $hidP = $root.find('input[type="hidden"][name="TotalSupplyPrice"]');
      if ($hidP.length) $hidP.val(String(sumPrice));
      else $('<input>', { type: 'hidden', name: 'TotalSupplyPrice', value: String(sumPrice) }).appendTo($root);

      let $hidV = $root.find('input[type="hidden"][name="TotalVat"]');
      if ($hidV.length) $hidV.val(String(sumVat));
      else $('<input>', { type: 'hidden', name: 'TotalVat', value: String(sumVat) }).appendTo($root);
    }*/

    //í–‰ ì‚­ì œ í•¨ìˆ˜
    function removeItemRow(el) {
      const $tbody = $(el).closest('tbody');
      const $rows = $tbody.find('tr:not(.item-template-row)');
      const $targetRow = $(el).closest('tr');

      if ($rows.length <= 3) {
        // ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ì´ˆê¸°í™”ë§Œ í•˜ê³  ë¦¬í„´
        const hasData = $targetRow.find('input[type="text"], input[type="number"]').filter(function () {
          return $(this).val().trim() !== '';
        }).length > 0;

        if (hasData) {
          $targetRow.find('input[type="text"], input[type="number"]').val('');
          // hidden ê°’ë„ ì´ˆê¸°í™”í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì¶”ê°€
          $targetRow.find('input[type="hidden"]').val('');
        }

        return;
      }

      // 4ê°œ ì´ìƒì´ë©´ ì •ìƒ ì‚­ì œ
      $targetRow.remove();
    }

    let page = null;

    $(document).ready(function (e) {

      page = new SujuUploadPage();

     const now = new Date();
     const month1 = new Date(now.getFullYear(), now.getMonth(), 1);
     const monthLast = new Date(now.getFullYear(), now.getMonth() + 1, 0);

     $('#srchStartDt').val(CommonUtil.formatYYYYMMDD(month1));
     $('#srchEndDt').val(CommonUtil.formatYYYYMMDD(monthLast));

      page.searchMainData();

      // ê²€ìƒ‰
      $('#btnSearch').click(function (e) {
        page.searchMainData();
      });

      // ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
      $('#btnDownloadTemplate').click(function (e) {
        page.downloadExcelForm();
      });

      // ì—‘ì…€ ì—…ë¡œë“œ ë²„íŠ¼
      $('#btnShowUpload').click(function (e) {
        let data = {
          'id': '',
          'data_date': CommonUtil.getYYYYMMDD(),
        };
        page.showPopupExcelUpload(data);
      });

    })
  </script>
</th:block>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>